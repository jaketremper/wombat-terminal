<!DOCTYPE html>
<html lang="en">
<head>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>W.O.M.B.A.T. Terminal Offline</title>
  <meta name="description" content="Next-gen neighborhood comms planning - Interactive scenarios, network visualization, equipment database">
  <meta name="theme-color" content="#0a0e1a">

  <style>
* { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --tactical-green: #39ff14;
      --signal-blue: #00d9ff;
      --warning-orange: #ff6b35;
      --danger-red: #ff3838;
      --success-green: #00ff88;
      --dark-bg: #0a0e1a;
      --terminal-bg: #0d1117;
      --grid-color: rgba(57, 255, 20, 0.15);
    }
    
    .skip-link {
      position: absolute;
      top: -40px;
      left: 0;
      background: var(--tactical-green);
      color: var(--dark-bg);
      padding: 0.5rem 1rem;
      text-decoration: none;
      z-index: 100;
      font-weight: bold;
    }
    
    .skip-link:focus {
      top: 0;
    }
    
    body {
      background: var(--dark-bg);
      min-height: 100vh;
      font-family: 'Share Tech Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      color: var(--tactical-green);
      padding: 0;
      position: relative;
    }
    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-image:
        linear-gradient(var(--grid-color) 1px, transparent 1px),
        linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
      background-size: 50px 50px;
      opacity: 0.3;
      z-index: 0;
      pointer-events: none;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      position: relative;
      z-index: 1;
      padding: 1rem;
    }
    .header {
      text-align: center;
      margin-bottom: 2rem;
      border-bottom: 2px solid var(--tactical-green);
      padding-bottom: 1rem;
    }
    .header-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      justify-content: center;
      margin-bottom: 1rem;
    }
    .header-text {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .backlink {
      text-decoration: none;
      color: var(--signal-blue);
      font-size: 13px;
      border: 1px solid var(--tactical-green);
      padding: 4px 8px;
      border-radius: 6px;
      background: rgba(57, 255, 20, 0.1);
      transition: all 0.2s;
      white-space: nowrap;
    }
    .backlink:hover {
      filter: brightness(1.2);
      box-shadow: 0 0 8px rgba(57, 255, 20, 0.3);
    }
    .header h1 {
      font-size: clamp(1.5rem, 5vw, 2rem);
      color: var(--tactical-green);
      text-shadow: 0 0 10px var(--tactical-green);
      margin-bottom: 0.5rem;
    }
    .header p {
      color: var(--signal-blue);
      font-size: clamp(0.7rem, 2vw, 0.9rem);
      letter-spacing: 0.2rem;
    }
    .version {
      color: var(--warning-orange);
      font-size: 0.8rem;
      margin-top: 0.5rem;
    }
    .terminal {
      background: var(--terminal-bg);
      border: 2px solid var(--tactical-green);
      border-radius: 8px;
      padding: 1.5rem;
      min-height: 400px;
      max-height: 80vh;
      overflow: hidden;
      box-shadow: 0 0 20px rgba(57, 255, 20, 0.2);
      position: relative;
      display: flex;
      flex-direction: column;
    }
.branding {
  font-family: 'Share Tech Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size: 0.85rem;
  color: var(--warning-orange);
  letter-spacing: 0.3rem;
  text-transform: uppercase;
  margin-top: 2rem;
  opacity: 0.85;
  max-width: 100%;
  overflow-wrap: break-word;
  line-height: 1.5;
}

.branding a {
  color: var(--tactical-green);
  text-decoration: none;
  transition: all 0.2s;
  border-bottom: 1px solid var(--tactical-green);
}

.branding a:hover {
  color: var(--signal-blue);
  border-bottom-color: var(--signal-blue);
  text-shadow: 0 0 10px var(--signal-blue);
}    
    #output {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 1rem;
    }
    .terminal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--grid-color);
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .status-indicators {
      display: flex;
      gap: 1rem;
      font-size: 0.8rem;
      flex-wrap: wrap;
    }
    .status-indicator {
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    .status-dot.online { background: var(--success-green); }
    .status-dot.warning { background: var(--warning-orange); }
    .status-dot.danger { background: var(--danger-red); }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .prompt {
      color: var(--signal-blue);
      margin-bottom: 1rem;
    }
    .prompt::before {
      content: '> ';
      color: var(--tactical-green);
    }
    .input-line {
      display: flex;
      align-items: center;
      margin-bottom: 0;
      padding-top: 0.75rem;
      position: sticky;
      bottom: 0;
      background: var(--terminal-bg);
      border-top: 1px solid rgba(57, 255, 20, 0.2);
      z-index: 10;
    }
    .input-line::before {
      content: '$ ';
      color: var(--tactical-green);
      margin-right: 0.5rem;
    }
    #commandInput {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--tactical-green);
      font-family: 'Share Tech Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 1rem;
      outline: none;
      caret-color: var(--tactical-green);
    }
    
    #commandInput::placeholder {
      color: rgba(57, 255, 20, 0.3);
    }

    /* =====================================================
       AUTOCOMPLETE DROPDOWN
       ===================================================== */
    .autocomplete {
      position: absolute;
      left: 1.5rem;
      right: 1.5rem;
      /* Sit just above the sticky input line */
      bottom: 3.3rem;
      max-height: 45vh;
      overflow: auto;
      background: rgba(13, 17, 23, 0.98);
      border: 1px solid rgba(57, 255, 20, 0.35);
      border-radius: 6px;
      box-shadow: 0 0 18px rgba(57, 255, 20, 0.15);
      z-index: 25;
      display: none;
      padding: 0.25rem;
      backdrop-filter: blur(2px);
    }

    .autocomplete.open {
      display: block;
    }

    .autocomplete-item {
      padding: 0.45rem 0.6rem;
      cursor: pointer;
      border-radius: 4px;
      color: rgba(57, 255, 20, 0.9);
      font-size: 0.95rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .autocomplete-item:hover {
      background: rgba(57, 255, 20, 0.12);
    }

    .autocomplete-item.active {
      background: rgba(0, 217, 255, 0.12);
      color: var(--signal-blue);
      box-shadow: inset 0 0 0 1px rgba(0, 217, 255, 0.25);
    }
    .output {
      white-space: pre-wrap;
      color: var(--tactical-green);
      margin-bottom: 1rem;
      line-height: 1.6;
      word-wrap: break-word;
    }
    .output.warning { color: var(--warning-orange); }
    .output.danger { color: var(--danger-red); }
    .output.info { color: var(--signal-blue); }
    .output.success { color: var(--success-green); }
    .output.help-text {
      color: rgba(0, 217, 255, 0.7);
      font-style: italic;
      font-size: 0.9rem;
    }
    .output.dim {
      color: rgba(57, 255, 20, 0.6);
    }
    .output.ascii-art {
      line-height: 1.0;
      margin-bottom: 0;
      font-variant-ligatures: none;
      letter-spacing: 0;
      white-space: pre;
    }
    .command-history {
      opacity: 0.6;
      margin-bottom: 0.5rem;
    }
    .progress-bar {
      background: rgba(57, 255, 20, 0.1);
      border: 1px solid var(--tactical-green);
      border-radius: 4px;
      height: 20px;
      margin: 0.5rem 0;
      position: relative;
      overflow: hidden;
    }
    .progress-fill {
      background: var(--tactical-green);
      height: 100%;
      transition: width 0.3s ease;
      position: relative;
    }
    .progress-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: var(--dark-bg);
      font-size: 0.8rem;
      font-weight: bold;
      z-index: 1;
    }
.button-group {
  display: flex;
  gap: 1rem;
  margin: 1rem 0;
  flex-wrap: wrap;
}

.output .button-group {
  display: flex !important;
  flex-direction: row !important;
  justify-content: flex-start !important;
  align-items: center !important;
  gap: 0.75rem !important;
  margin: 1rem 0 !important;
  flex-wrap: wrap !important;
  width: 100% !important;
}

.output .button-group .terminal-button {
  flex: 0 0 auto;
  white-space: nowrap;
  min-width: auto;
}

@media (max-width: 768px) {
  .output .button-group {
    flex-direction: column !important;
    align-items: stretch !important;
  }
  
  .output .button-group .terminal-button {
    width: 100% !important;
  }
}
    
    .terminal-input, .terminal-select {
      width: min(420px, 100%);
      background: rgba(0,0,0,0.35);
      border: 1px solid var(--tactical-green);
      color: var(--tactical-green);
      padding: 0.5rem 0.6rem;
      font-family: 'Share Tech Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 1rem;
      outline: none;
      border-radius: 4px;
    }
    
    .terminal-input:focus, .terminal-select:focus {
      box-shadow: 0 0 0 2px rgba(57, 255, 20, 0.25);
      border-color: var(--success-green);
    }
    
    .terminal-button {
      background: transparent;
      border: 1px solid var(--tactical-green);
      color: var(--tactical-green);
      padding: 0.5rem 1rem;
      font-family: 'Share Tech Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.9rem;
    }
    .terminal-button:hover {
      background: var(--tactical-green);
      color: var(--dark-bg);
      box-shadow: 0 0 10px var(--tactical-green);
    }
    .card-preview {
      background: white;
      color: black;
      padding: 1.5rem;
      margin: 1rem 0;
      border: 2px dashed var(--tactical-green);
      font-family: Arial, sans-serif;
      max-width: 600px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
    .network-canvas {
      background: rgba(13, 17, 23, 0.8);
      border: 2px solid var(--tactical-green);
      border-radius: 8px;
      margin: 1rem 0;
      cursor: crosshair;
      box-shadow: 0 0 15px rgba(57, 255, 20, 0.3);
      display: block;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
      margin: 1rem 0;
    }
    .stat-box {
      background: rgba(0, 217, 255, 0.05);
      border: 1px solid var(--signal-blue);
      padding: 1rem;
      border-radius: 4px;
      text-align: center;
    }
    .stat-value {
      font-size: 2rem;
      color: var(--tactical-green);
      font-weight: bold;
      margin: 0.5rem 0;
    }
    .stat-label {
      color: var(--signal-blue);
      font-size: 0.9rem;
    }
    .timeline {
      position: relative;
      padding-left: 2rem;
      margin: 1rem 0;
    }
    .timeline::before {
      content: '';
      position: absolute;
      left: 0.5rem;
      top: 0;
      bottom: 0;
      width: 2px;
      background: var(--tactical-green);
    }
    .timeline-item {
      position: relative;
      margin-bottom: 1.5rem;
      padding-left: 1rem;
    }
    .timeline-item::before {
      content: '';
      position: absolute;
      left: -1.4rem;
      top: 0.3rem;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--tactical-green);
      border: 2px solid var(--dark-bg);
      box-shadow: 0 0 0 2px var(--tactical-green);
    }
    .timeline-time {
      color: var(--warning-orange);
      font-weight: bold;
      margin-bottom: 0.3rem;
    }
    .timeline-content {
      color: var(--signal-blue);
    }
    .comparison-table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
      font-size: 0.85rem;
    }
    .comparison-table th,
    .comparison-table td {
      border: 1px solid var(--grid-color);
      padding: 0.5rem;
      text-align: left;
    }
    .comparison-table th {
      background: rgba(57, 255, 20, 0.1);
      color: var(--tactical-green);
      font-weight: bold;
    }
    .comparison-table td {
      color: var(--signal-blue);
    }
    .comparison-table tr:hover {
      background: rgba(57, 255, 20, 0.05);
    }
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--terminal-bg);
      border: 2px solid var(--success-green);
      padding: 1rem;
      border-radius: 4px;
      color: var(--success-green);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      z-index: 2000;
      animation: slideIn 0.3s ease;
      max-width: 300px;
    }
    @keyframes slideIn {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .notification.warning { border-color: var(--warning-orange); color: var(--warning-orange); }
    .notification.danger { border-color: var(--danger-red); color: var(--danger-red); }
    .notification.info { border-color: var(--signal-blue); color: var(--signal-blue); }
    .notification.success { border-color: var(--success-green); color: var(--success-green); }
    @media (max-width: 768px) {
      body { padding: 0.5rem; }
      .terminal { padding: 1rem; }
      .header h1 { font-size: 1.5rem; }
      .backlink {
        font-size: 12px;
        padding: 3px 6px;
      }
      .stats-grid { grid-template-columns: 1fr; }
      .comparison-table { font-size: 0.75rem; }
    }
    
/* Print staging area: keep it in the DOM but off-screen so it never shows on the page */
.print-area {
  position: fixed;
  left: -100000px;
  top: 0;
  width: 1px;
  height: 1px;
  overflow: hidden;
  visibility: hidden;
  pointer-events: none;
}

@media print {
      @page { margin: 0.5in; }

      body {
        background: white !important;
        padding: 0 !important;
      }

      body::before { display: none !important; } /* Hide grid overlay */

      /* Hide the app UI */
      .container { display: none !important; }

      /* Show print content */
      .print-area {
        position: static !important;
        left: auto !important;
        top: auto !important;
        width: auto !important;
        height: auto !important;
        overflow: visible !important;
        visibility: visible !important;
        pointer-events: auto !important;
      }

      .card-preview {
        border: 2px solid black !important;
        max-width: none !important;
        width: 100% !important;
        box-shadow: none !important;
        page-break-after: always;
      }

      .card-preview:last-child { page-break-after: auto; }
      
      /* Timeline print styling */
      .card-preview .timeline-item-print {
        position: relative;
        padding-left: 1.5rem;
        margin: 0.75rem 0;
      }
      
      .card-preview .timeline-item-print::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0.3rem;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: black;
        border: 2px solid white;
        box-shadow: 0 0 0 2px black;
      }
    }

    nav a:hover {
      color: #63b3ed !important;
      background-color: rgba(99, 179, 237, 0.1);
      border-radius: 4px;
    }
    nav a.active {
      color: #f6ad55 !important;
      font-weight: bold;
    }
    @media (max-width: 768px) {
      nav {
        font-size: 0.7rem !important;
        gap: 0.25rem !important;
      }
      nav a {
        margin: 0 0.25rem !important;
        padding: 0.4rem 0.4rem !important;
      }
    }
  </style>
</head>
<body>

  <a href="#commandInput" class="skip-link">Skip to command input</a>
  <div class="container">
    <div class="header">
      <div class="header-content">
        <div class="header-text">
          <h1>W.O.M.B.A.T. TERMINAL OFFLINE</h1>
          <p>WIRELESS OMNIDIRECTIONAL MULTI-BAND AWARENESS TOOLKIT TERMINAL</p>
          <div class="version">Neighborhood Comms Planning</div>
        </div>
      </div>
    </div>
    
    <div class="terminal" id="terminal">
      <div class="terminal-header">
        <div class="status-indicators">
          <div class="status-indicator">
            <div class="status-dot online"></div>
            <span>SYSTEM READY</span>
          </div>
          <div class="status-indicator">
            <div class="status-dot online" id="storageStatus"></div>
            <span id="storageText">STORAGE: OK</span>
          </div>
        </div>
        <div class="button-group" style="margin: 0; gap: 0.5rem;">
          <button class="terminal-button" onclick="clearTerminal()" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;">CLEAR</button>
          <button class="terminal-button" onclick="saveSession()" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;">SAVE</button>
          <button class="terminal-button" onclick="loadSession()" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;">LOAD</button>
                  <button class="terminal-button" onclick="openImportDialog()" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;">IMPORT</button>
</div>
      </div>
      
      <div class="prompt">WOMBAT Neighborhood Comms Planning</div>
      <div class="prompt">Type 'help' for commands | 'demo' for full demonstration | 'quick' for fast start</div>
      
      <div id="output" role="log" aria-live="polite" aria-atomic="false" aria-label="Terminal output"></div>
      
      <div class="input-line">
        <input type="text" id="commandInput" autofocus autocomplete="off" placeholder="Enter command..." aria-label="Command input">
      </div>

      <!-- Autocomplete dropdown (populated by JS) -->
      <div id="autocomplete" class="autocomplete" role="listbox" aria-label="Command suggestions" aria-hidden="true"></div>
    </div>
  </div>
  
  
  <!-- Print-only staging area (kept outside the terminal so print CSS can hide the UI) -->
  <div id="printArea" class="print-area" aria-hidden="true"></div>
  <!-- Hidden file input for importing exported JSON -->
  <input type="file" id="importFile" accept="application/json" style="display:none">

<script>
    // ===========================================================================================
    // CORE SYSTEM
    // ===========================================================================================
    
    const terminal = document.getElementById('output');
    const terminalContainer = terminal; // Output div is now the scroll container
    const input = document.getElementById('commandInput');
    const printArea = document.getElementById('printArea');

const importFileInput = document.getElementById('importFile');

function openImportDialog() {
  if (!importFileInput) {
    addOutput('Import not available: file input missing', 'warning');
    return;
  }
  importFileInput.value = '';
  importFileInput.click();
}

function detectImportType(obj) {
  // Session export ("export all" or saved session JSON)
  if (obj && typeof obj === 'object' && obj.networkPlan && (obj.equipmentInventory || obj.scenarioResults || obj.version)) {
    return 'session';
  }
  // Plan-only export ("export plan")
  if (obj && typeof obj === 'object' && ('houses' in obj || 'area_sqkm' in obj || 'terrain' in obj || 'budget' in obj)) {
    return 'plan';
  }
  return 'unknown';
}

function importFromObject(obj) {
  const t = detectImportType(obj);

  if (t === 'session') {
    // Normalize to our session format and persist so LOAD works
    const sessionData = migrateSession({
      version: obj.version || 3,
      networkPlan: obj.networkPlan || networkPlan,
      equipmentInventory: obj.equipmentInventory || {},
      scenarioResults: obj.scenarioResults || {},
      timestamp: obj.timestamp || new Date().toISOString()
    });

    localStorage.setItem('wombat_session', JSON.stringify(sessionData));
    loadSession();
    addOutput('[OK] Imported full session from JSON', 'success');
    showNotification('Session imported', 'success');
    return;
  }

  if (t === 'plan') {
    // Merge into existing plan defaults, then regenerate derived values
    networkPlan = { ...networkPlan, ...obj };

    addOutput('[OK] Imported network plan from JSON', 'success');
    showNotification('Plan imported', 'success');

    // Generate derived values (minNodes, recNodes, coverage, etc.)
    // This also prints the results for quick verification.
    generatePlan();
    return;
  }

  addOutput('Import failed: Unrecognized JSON format.', 'danger');
  addOutput('Accepted formats:', 'info');
  addOutput('  - "export all" file (wombat-complete-export.json)', 'info');
  addOutput('  - "export plan" file (wombat-network-plan.json)', 'info');
  showNotification('Import failed', 'danger');
}

if (importFileInput) {
  importFileInput.addEventListener('change', (e) => {
    const file = e.target.files && e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
      try {
        const text = String(reader.result || '');
        const obj = JSON.parse(text);
        importFromObject(obj);
      } catch (err) {
        addOutput('Import failed: ' + err.message, 'danger');
        showNotification('Import failed', 'danger');
      }
    };
    reader.readAsText(file);
  });
}

    function clearPrintArea() {
      if (!printArea) return;
      printArea.innerHTML = '';
    }

    function addCardToPrintArea(cardHtml) {
      if (!printArea) return;
      printArea.insertAdjacentHTML('beforeend', cardHtml);
    }

    const commandHistory = [];
    let historyIndex = -1;
    
    // State
    let networkPlan = {
      houses: 0,
      area_sqkm: 0,
      terrain: 'suburban',
      has_solar: false,
      budget: 0,
      max_distance: 0
    };
    
    let equipmentInventory = {};
    let scenarioResults = {};
    
    // Initialize
    // ===========================================================================================
    // UTILITY FUNCTIONS
    // ===========================================================================================
    
    function escapeHTML(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }
    
    // ===========================================================================================
    // OUTPUT FUNCTIONS
    // ===========================================================================================
    
    const MAX_OUTPUT_LINES = 200; // Reduced for mobile performance
    
    function pruneOutput() {
      while (terminal.childNodes.length > MAX_OUTPUT_LINES) {
        terminal.removeChild(terminal.firstChild);
      }
    }
    
    function addOutput(text, className = '') {
      const div = document.createElement('div');
      div.className = `output ${className}`;
      div.textContent = text;
      terminal.appendChild(div);
      pruneOutput();
      scrollToBottom(true); // Force scroll for command output
      return div;
    }
    
    function addHTML_UNSAFE_TRUSTED_ONLY(html) {
      // WARNING: Only use with trusted, static HTML templates
      // NEVER pass user input or dynamic data without escapeHTML()
      const div = document.createElement('div');
      div.className = 'output';
      div.innerHTML = html;
      terminal.appendChild(div);
      pruneOutput();
      scrollToBottom(true);
      return div;
    }
    
    function scrollToBottom(force = true) {
      if (!terminalContainer) return;
      
      // For command output, always scroll
      // For manual scrolling by user, they can scroll up and stay there
      if (force) {
        requestAnimationFrame(() => {
          terminalContainer.scrollTop = terminalContainer.scrollHeight;
        });
      }
    }
    
    function clearTerminal() {
      // Use safe DOM manipulation instead of innerHTML
      while (terminal.firstChild) {
        terminal.removeChild(terminal.firstChild);
      }

      clearPrintArea(); // also clear print staging content

      showWelcome();
      showNotification('Terminal cleared', 'info');
    }
    
    function showWelcome() {
      addOutput('WOMBAT - Neighborhood Communications Planning', 'info ascii-art');
      addOutput('Wireless Omnidirectional Multi-Band Awareness Toolkit', 'info ascii-art');
      addOutput('PLANNING GUIDANCE ONLY - Verify all procedures with local authorities', 'warning');
      addOutput('Emergency communications planning for resilient communities\n', 'success');
      addOutput('Type "help" for commands | "quick" to start | "triage" for emergencies\n', 'dim');
    }
    
    function showAbout() {
      addOutput('\n' + '═'.repeat(60), 'info');
      addOutput('ABOUT W.O.M.B.A.T.', 'info');
      addOutput('═'.repeat(60) + '\n', 'info');
      
      addOutput('Wireless Omnidirectional Multi-Band Awareness Toolkit\n', 'success');
      
      addOutput('PURPOSE:', 'info');
      addOutput('Planning tool for neighborhood emergency communications.');
      addOutput('Helps you prepare mesh networks, GMRS nets, and backup plans.\n');
      
      addOutput('IMPORTANT DISCLAIMER:', 'warning');
      addOutput('This is PLANNING GUIDANCE ONLY.');
      addOutput('NOT a substitute for official emergency management.');
      addOutput('Verify all procedures with local authorities.\n');
      
      addOutput('WHAT IT IS:', 'success');
      addOutput('  • Scenario planning with realistic timelines');
      addOutput('  • Equipment recommendations and comparisons');
      addOutput('  • Network planning with coverage calculations');
      addOutput('  • Printable reference cards');
      addOutput('  • Session persistence and backup\n');
      
      addOutput('WHAT IT ISN\'T:', 'warning');
      addOutput('  • Official emergency guidance');
      addOutput('  • Real-time communications system');
      addOutput('  • Substitute for professional training');
      addOutput('  • Legal or medical advice\n');
      
      addOutput('GETTING STARTED:', 'info');
      addOutput('  1. Type "quick" for guided setup');
      addOutput('  2. Run "scenario list" to see emergency scenarios');
      addOutput('  3. Use "plan wizard" to calculate your network');
      addOutput('  4. Type "card pack" for printable reference cards\n');
      
      addOutput('Created by Chaos Koalas - chaoskoalas.com', 'dim');
      addOutput('Open source • No tracking • Runs entirely in your browser\n', 'dim');
    }
    
    function showStatus() {
      addOutput('\n═'.repeat(60), 'info');
      addOutput('SYSTEM STATUS', 'info');
      addOutput('═'.repeat(60) + '\n', 'info');
      
      // Network Plan
      if (networkPlan.houses > 0) {
        addOutput('NETWORK PLAN:', 'success');
        addOutput(`  Houses: ${networkPlan.houses}`);
        addOutput(`  Area: ${networkPlan.area_sqkm} sq km`);
        addOutput(`  Terrain: ${networkPlan.terrain}`);
        if (networkPlan.recNodes) {
          addOutput(`  Recommended Nodes: ${networkPlan.recNodes}`);
        }
        addOutput('');
      } else {
        addOutput('NETWORK PLAN: Not configured', 'dim');
        addOutput('  Run "plan wizard" to create a plan\n');
      }
      
      // Scenario Results
      const scenarioKeys = Object.keys(scenarioResults);
      if (scenarioKeys.length > 0) {
        addOutput('SCENARIOS COMPLETED:', 'success');
        scenarioKeys.forEach(key => {
          const result = scenarioResults[key];
          const date = new Date(result.timestamp);
          addOutput(`  ${key}: ${result.readiness}% ready (${date.toLocaleDateString()})`);
        });
        addOutput('');
      } else {
        addOutput('SCENARIOS: None completed', 'dim');
        addOutput('  Run "scenario list" to see options\n');
      }
      
      // Storage
      const hasStorage = typeof(Storage) !== "undefined";
      addOutput(`STORAGE: ${hasStorage ? '[OK] Available' : '[X] Unavailable'}`, hasStorage ? 'success' : 'danger');
      
      const lastSave = localStorage.getItem('wombat_session');
      if (lastSave && hasStorage) {
        try {
          const data = JSON.parse(lastSave);
          const saveDate = new Date(data.timestamp);
          addOutput(`Last Save: ${saveDate.toLocaleString()}`);
        } catch (e) {
          addOutput('Last Save: Error reading save data', 'warning');
        }
      } else {
        addOutput('Last Save: None');
      }
      
      addOutput('\n' + '═'.repeat(60) + '\n');
    }
    
    function showNotification(message, type = 'success') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }
    
    function showProgress(current, total, label) {
      const percent = Math.round((current / total) * 100);
      return addHTML_UNSAFE_TRUSTED_ONLY(`
        <div style="margin: 0.5rem 0;">
          <div style="color: var(--signal-blue); font-size: 0.9rem; margin-bottom: 0.3rem;">
            ${label} - Step ${current}/${total}
          </div>
          <div class="progress-bar">
            <div class="progress-fill" style="width: ${percent}%">
              <div class="progress-text">${percent}%</div>
            </div>
          </div>
        </div>
      `);
    }
    
    // ===========================================================================================
    // STORAGE & PERSISTENCE
    // ===========================================================================================
    
    function checkStorage() {
      try {
        localStorage.setItem('test', 'test');
        localStorage.removeItem('test');
        return true;
      } catch (e) {
        document.getElementById('storageStatus').className = 'status-dot warning';
        document.getElementById('storageText').textContent = 'STORAGE: LIMITED';
        return false;
      }
    }
    
    function saveSession() {
      try {
        const sessionData = {
          version: 3,
          networkPlan: networkPlan,
          equipmentInventory: equipmentInventory,
          scenarioResults: scenarioResults,
          timestamp: new Date().toISOString()
        };
        localStorage.setItem('wombat_session', JSON.stringify(sessionData));
        showNotification('Session saved successfully', 'success');
      } catch (e) {
        showNotification('Failed to save session', 'danger');
      }
    }
    
    function migrateSession(sessionData) {
      // Migrate old session formats to current version
      const migrated = { ...sessionData };
      
      // Ensure version exists
      if (!migrated.version) {
        migrated.version = 1;
      }
      
      // v1 → v2 migrations
      if (migrated.version < 2) {
        // Add missing networkPlan fields
        if (migrated.networkPlan) {
          migrated.networkPlan.minNodes = migrated.networkPlan.minNodes || 0;
          migrated.networkPlan.recNodes = migrated.networkPlan.recNodes || 0;
          migrated.networkPlan.effectiveRange = migrated.networkPlan.effectiveRange || 0;
        }
      }
      
      // v2 → v3 migrations
      if (migrated.version < 3) {
        // Ensure scenarioResults has proper structure
        if (migrated.scenarioResults) {
          Object.keys(migrated.scenarioResults).forEach(key => {
            if (!migrated.scenarioResults[key].timestamp) {
              migrated.scenarioResults[key].timestamp = new Date().toISOString();
            }
          });
        }
      }
      
      // Set to current version
      migrated.version = 3;
      return migrated;
    }
    
    function loadSession() {
      try {
        const data = localStorage.getItem('wombat_session');
        if (data) {
          let sessionData = JSON.parse(data);
          
          // Migrate old versions
          if (!sessionData.version || sessionData.version < 3) {
            addOutput('\nMigrating session from older version...', 'info');
            sessionData = migrateSession(sessionData);
          }
          
          networkPlan = sessionData.networkPlan || networkPlan;
          equipmentInventory = sessionData.equipmentInventory || equipmentInventory;
          scenarioResults = sessionData.scenarioResults || {};
          
          const date = new Date(sessionData.timestamp);
          addOutput(`\nSession loaded from ${date.toLocaleString()}`, 'success');
          showNotification('Session restored', 'success');
        } else {
          addOutput('No saved session found', 'warning');
          addOutput('If you exported a JSON file, use the IMPORT button or type "import".', 'info');
          addOutput('If you copied a backup blob, type "restore".', 'info');
        }
      } catch (e) {
        addOutput('Failed to load session: ' + e.message, 'danger');
        addOutput('Your save may be corrupted. Type "backup" to try exporting it, or "restore" to replace it.', 'warning');
        showNotification('Failed to load session', 'danger');
      }
    }
    
    function backupSave() {
      const data = localStorage.getItem('wombat_session');
      if (!data) {
        addOutput('\nNo saved session to backup.', 'warning');
        addOutput('Run "save" first to create a session.\n');
        return;
      }
      
      addOutput('BACKUP YOUR SESSION', 'info');
      addOutput('Copy the text below and save it somewhere safe.', 'success');
      addOutput('Use "restore" to load it on another device.\n', 'info');
      
      const container = document.createElement('div');
      container.style.margin = '1rem 0';
      
      const textarea = document.createElement('textarea');
      textarea.value = data;
      textarea.className = 'terminal-input';
      textarea.style.width = '100%';
      textarea.style.height = '200px';
      textarea.style.fontFamily = 'monospace';
      textarea.style.fontSize = '0.8rem';
      textarea.readOnly = true;
      
      const copyBtn = document.createElement('button');
      copyBtn.textContent = 'Copy to Clipboard';
      copyBtn.className = 'terminal-button';
      copyBtn.style.marginTop = '0.5rem';
      copyBtn.onclick = () => {
        textarea.select();
        document.execCommand('copy');
        showNotification('Copied to clipboard!', 'success');
      };
      
      container.appendChild(textarea);
      container.appendChild(copyBtn);
      terminal.appendChild(container);
      
      textarea.select();
      addOutput('\n[OK] Backup displayed. Copy and save somewhere safe.', 'success');
      scrollToBottom(true);
    }
    
    function restoreSave() {
      addOutput('RESTORE FROM BACKUP', 'info');
      addOutput('Paste your backup JSON below and click Restore.\n', 'warning');
      
      const container = document.createElement('div');
      container.style.margin = '1rem 0';
      
      const textarea = document.createElement('textarea');
      textarea.className = 'terminal-input';
      textarea.style.width = '100%';
      textarea.style.height = '200px';
      textarea.style.fontFamily = 'monospace';
      textarea.style.fontSize = '0.8rem';
      textarea.placeholder = 'Paste backup JSON here...';
      
      const buttonGroup = document.createElement('div');
      buttonGroup.style.marginTop = '0.5rem';
      buttonGroup.style.display = 'flex';
      buttonGroup.style.gap = '0.5rem';
      
      const restoreBtn = document.createElement('button');
      restoreBtn.textContent = 'Restore';
      restoreBtn.className = 'terminal-button';
      restoreBtn.onclick = () => {
        try {
          const data = JSON.parse(textarea.value);
          // Validate it's actually session data
          if (!data.networkPlan && !data.scenarioResults) {
            throw new Error('Invalid session format');
          }
          localStorage.setItem('wombat_session', textarea.value);
          addOutput('\n[OK] Backup restored successfully!', 'success');
          addOutput('Type "load" to use the restored session.\n', 'info');
          container.remove();
          showNotification('Backup restored', 'success');
        } catch (e) {
          addOutput('\n[X] ERROR: Invalid backup data', 'danger');
          addOutput('Make sure you pasted the complete JSON from "backup" command.\n', 'warning');
        }
      };
      
      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'Cancel';
      cancelBtn.className = 'terminal-button';
      cancelBtn.onclick = () => {
        container.remove();
        addOutput('\nRestore cancelled.\n', 'dim');
      };
      
      buttonGroup.appendChild(restoreBtn);
      buttonGroup.appendChild(cancelBtn);
      container.appendChild(textarea);
      container.appendChild(buttonGroup);
      terminal.appendChild(container);
      
      textarea.focus();
      scrollToBottom(true);
    }
    
    // ===========================================================================================
    // DATA STRUCTURES
    // ===========================================================================================
    
    const scenarios = {
      hurricane: {
        name: "Hurricane Landfall",
        severity: "critical",
        description: "Cat 3 hurricane making landfall. Power grid down, cell towers typically fail within 2-6 hours. Expect 48-72 hour blackout minimum, potentially longer in hard-hit areas. Storm surge can reach 8-12 feet in coastal zones. NOTE: Reality varies by geography/infrastructure - treat time windows as planning estimates.",
        questions: [
          {
            q: "Do you have at least 3 Meshtastic nodes deployed in your neighborhood network?",
            tooltip: "Minimum 3 nodes creates mesh redundancy. Single points of failure = total network loss. Each node should cover 2-3km radius.",
            yes: "Good start. Ensure nodes are at different elevations and locations to survive localized damage. Test message propagation to furthest points NOW.",
            no: "CRITICAL: Without mesh redundancy, one failure means total communications blackout. You need minimum 3 nodes - ideally 5-7 for 15 house neighborhood. Deploy immediately or accept 72+ hours of isolation."
          },
          {
            q: "Do you have at least 72 hours of battery capacity for ALL communication devices?",
            tooltip: "Calculate: (device power draw in mAh) × (hours needed) = total capacity. Meshtastic node = ~80mAh avg, GMRS radio = ~150mAh avg. 10,000mAh bank = ~18hrs for one node.",
            yes: "Excellent. Verify actual runtime under load - manufacturers overstate capacity. Test your equipment at full power for 12 hours and measure actual drain. Store batteries at 60-80% charge, not 100%.",
            no: "WARNING: Most people vastly underestimate power needs. A 10,000mAh battery bank powers ONE Meshtastic node for ~20 hours. For 3 nodes + 2 radios for 72hrs you need 50,000+ mAh total. Buy more NOW - Amazon may not deliver after storm warning."
          },
          {
            q: "Do you have a neighborhood GMRS net established with assigned roles?",
            tooltip: "GMRS provides voice coordination mesh can't. Need: Net Control (coordinates), Medical (triage), Security (patrols), Supply (resources), Welfare (check-ins). Everyone monitors Ch 15.",
            yes: "Good. Conduct voice check-in RIGHT NOW. Verify everyone's radio works and they know their role. Establish: Primary freq (Ch 15), Backup freq (Ch 20), Emergency freq (Ch 1). Practice using CTCSS tones to reduce interference.",
            no: "MAJOR GAP: Text mesh is slow for urgent coordination. You need voice. Get GMRS license ($35, instant online, covers family). Minimum: 2 handheld radios per household, one mobile 50W unit for Net Control. Establish net TODAY."
          },
          {
            q: "Are all outdoor antennas and equipment secured or removed?",
            tooltip: "120mph winds turn unsecured antennas into missiles. Coax connections fail in rain. Roof mounts rip off and damage structures.",
            yes: "Good. Double-check guy wires are tensioned properly. Apply dielectric grease to ALL connectors. Bring portable equipment inside NOW - don't wait for rain.",
            no: "URGENT: Remove ALL outdoor antennas within 24 hours of landfall. 120mph winds WILL destroy them and potentially damage your home. Better to lose comms than lose your roof. Use indoor antennas only during storm."
          },
          {
            q: "Have you waterproofed ALL electronics in double-layer protection?",
            tooltip: "Storm surge brings SALTWATER which destroys electronics instantly. Even 'waterproof' cases fail under pressure. Need: Device in ziplock, inside dry bag, inside sealed container, elevated >10ft.",
            yes: "Verify: Each device in its own ziplock, squeezed to remove air. Then inside DRY bag (not just 'water resistant'). Store on 2nd floor minimum. Test one ziplock with paper towel inside bucket of water for 24 hours.",
            no: "CRITICAL: Saltwater is your enemy. Even moisture/humidity kills electronics. Get: Heavy-duty ziplock bags (gallon size), dry bags (5L minimum), dessicant packets. Create staging area on 2nd floor or attic. Do this in next 6 hours."
          },
          {
            q: "Do you have solar panels AND charge controllers ready to deploy post-storm?",
            tooltip: "Grid will be down 5-14 days minimum. Generators run out of fuel. Solar is only sustainable option. Need: 50-100W panel per node, MPPT charge controller, weather protection.",
            yes: "Excellent. Store panels INSIDE until after storm passes. Deploy within 12 hours post-storm before batteries die. Mount at angle for latitude. Clear debris from collection area immediately.",
            no: "WARNING: You'll have power for 48-72 hours MAX on batteries alone. After that, total blackout unless you have solar. Get minimum: 50W foldable panel ($60), 10A charge controller ($25), MC4 to USB adapter. These will keep ONE node alive indefinitely. Scale up for network."
          },
          {
            q: "Have you pre-positioned emergency nodes at evacuation rally points?",
            tooltip: "If flooding/damage forces evacuation, pre-staged nodes at higher ground maintain network. Battery-only nodes in waterproof containers, activated by pull-tab.",
            yes: "Good planning. Verify GPS coordinates are shared with all neighbors. Test activation procedure. Ensure 72hr battery minimum. Mark locations on physical maps (phones will die).",
            no: "PLANNING GAP: If you must evacuate, your home-based network dies. Cache 2-3 battery-powered nodes in waterproof containers at: nearby church/school on high ground, parking garage, friend's house in safer zone. Activate post-storm."
          },
          {
            q: "Does every household have physical printed copies of: frequencies, contact list, rally points, and emergency procedures?",
            tooltip: "Phones die. Laptops die. Memory fails under stress. Paper works when nothing else does. Laminated cards survive water.",
            yes: "Perfect. Verify: Laminated or in waterproof sleeve, attached to radio or in go-bag, includes frequencies with CTCSS tones, has map with rally points marked, lists each neighbor's capabilities/needs.",
            no: "CRITICAL OVERSIGHT: Digital info is useless when devices die. Print NOW: GMRS frequencies (Ch 15 primary, Ch 20 backup, CTCSS 141.3), every neighbor's radio callsign, rally point GPS coords, medical needs of each household, evacuation routes with landmarks."
          }
        ],
        timeline: [
          { time: "T-72 hours (Storm Watch)", action: "INITIAL PREP: Conduct neighborhood meeting. Test ALL equipment. Assign roles: Net Control, Medical Lead, Security Patrol, Supply Coordinator. Share frequencies and rally points. Top off vehicle gas tanks." },
          { time: "T-48 hours (Storm Warning)", action: "EQUIPMENT CHECK: Verify battery capacity under load. Charge everything to 100%. Apply dielectric grease to ALL antenna connections. Secure or remove outdoor antennas. Download offline maps (hurricane.gov, NOAA). Fill bathtubs with water. Purchase last-minute supplies." },
          { time: "T-24 hours", action: "FINAL PREP: Move all electronics to 2nd floor. Double-bag in waterproof protection. Deploy solar panels in secure location. Conduct radio net check-in - everyone must respond. Document each household: medical needs, medications, special equipment, pets. Take photos of property for insurance. Fuel vehicles completely." },
          { time: "T-12 hours", action: "HUNKER DOWN: All outdoor work STOPS. Everyone inside. Final radio check. Switch Meshtastic to LOW power mode to conserve battery. Establish check-in schedule (every 4 hours). Close storm shutters. Fill extra containers with water. Move to interior room away from windows. Keep one radio monitoring Ch 15 continuously." },
          { time: "T-6 hours", action: "STORM IMMINENT: All mesh nodes to minimum power. Turn OFF non-essential devices. Designate one person per household as radio operator. Everyone else preserves phone battery (airplane mode). Last bathroom breaks. Interior room lockdown. Have go-bags ready for rapid evacuation if needed." },
          { time: "T-2 hours", action: "EYE WALL APPROACH: Radio silence unless life-threatening emergency. Conserve all power. Stay in interior rooms. Do NOT go outside. Monitor NOAA weather radio if available. Keep copy of frequencies and emergency contacts on paper in waterproof bag in pocket." },
          { time: "Landfall", action: "HUNKER: Complete radio silence except emergencies. If mesh node fails, DO NOT attempt repair until winds <50mph. Monitor for water intrusion. If flooding occurs, move to higher floor with radio and go-bag. Do NOT go outside even during eye - winds return from opposite direction." },
          { time: "T+2 hours (Eye or Backside)", action: "STAY PUT: Winds reverse direction and may be stronger. DO NOT go outside. If in eye, this is NOT all-clear. Wait for sustained winds <40mph and official all-clear. Keep monitoring Ch 15 but maintain radio silence to preserve battery." },
          { time: "T+6 hours", action: "INITIAL ASSESSMENT: If winds <40mph and safe to move, conduct INTERNAL damage assessment only. Check structural integrity. Check for gas leaks (smell), electrical hazards (sparks/smoke), water damage. First radio check-in: 'CALLSIGN - OK/NEED HELP - DETAILS'. Be brief. Net Control logs all responses." },
          { time: "T+12 hours", action: "NEIGHBOR WELFARE: If safe, visual check on immediate neighbors (within 100ft). DO NOT enter damaged structures. Report via radio: injuries, trapped persons, fires, flooding, structural collapse. Net Control prioritizes response. Deploy solar panels. Begin battery recharge cycle. Ration food/water." },
          { time: "T+24 hours", action: "NETWORK RESTORATION: Check all mesh nodes. Replace any failed nodes. Optimize antenna positions based on new terrain (trees down, buildings damaged). Establish regular check-in schedule (08:00, 14:00, 20:00). Begin coordinated damage assessment. Pool resources: who has water, food, fuel, medical supplies, tools." },
          { time: "T+48 hours", action: "RECOVERY OPERATIONS: Organize work parties: debris clearing (main roads first), water distribution, medical needs, security patrols. Use mesh for coordination, GMRS for real-time tactical. Document everything for FEMA. Begin generator fuel sharing rotation. Check for injured/missing persons in wider area." },
          { time: "T+72 hours", action: "SUSTAINED OPERATIONS: Establish rhythm: morning net (situation update), afternoon work parties, evening net (planning next day). Begin contacting outside family members as connectivity permits. Continue solar charging rotation. Monitor for health issues: dehydration, heat stress, infections, medication needs." },
          { time: "T+7 days", action: "LONG HAUL: Grid still down. Maintain communications discipline. Rotate leadership to prevent burnout. Share generator runtime. Coordinate supply runs to distribution points. Update status board. Begin planning for 30-day scenario. Mental health check-ins important now." }
        ],
        recommendations: [
          "IMMEDIATE (Do in next 6 hours):",
          "  • Test EVERY device - don't assume it works. Power on, verify display, check battery drain over 1 hour",
          "  • Charge all batteries to 100% - include flashlights, radios, phones, tablets, battery banks, power tools",
          "  • Waterproof protection: Double-bag EVERY electronic in ziplock + dry bag. Test one bag with paper towel in water bucket",
          "  • Print emergency info: Frequencies (Ch 15 = 462.550, Ch 20 = 462.675), neighbor contacts, rally points, medical needs. LAMINATE.",
          "",
          "NETWORK SETUP (Next 24 hours):",
          "  • Deploy minimum 3 Meshtastic nodes in triangular pattern covering neighborhood. Test message propagation to furthest points",
          "  • Configure mesh: Encryption ON (share PSK with neighbors), Region=US, Power=LongFast, Hop Limit=3",
          "  • Mark node locations on physical map with GPS coordinates. Store map in waterproof sleeve in go-bag",
          "  • Position nodes at different elevations - if one floods, others maintain network. Secure firmly to survive wind",
          "",
          "COMMUNICATIONS PLAN:",
          "  • Primary: GMRS Ch 15 (462.550 MHz) - voice coordination. Set CTCSS 141.3 to reduce interference",
          "  • Backup: GMRS Ch 20 (462.675 MHz) - if Ch 15 congested or damaged repeater",
          "  • Data: Meshtastic mesh - status updates, non-urgent coordination, position tracking",
          "  • Emergency: Any means necessary including CB Ch 9, FRS Ch 1, or 146.52 MHz (ham emergency freq)",
          "",
          "POWER MANAGEMENT:",
          "  • 72-hour minimum battery capacity per device. For neighborhood network: 5 nodes + 10 radios = ~50,000 mAh required",
          "  • Solar deployment plan: 50W panel + 10A controller per critical node. Deploy POST-storm when winds <40mph",
          "  • Battery rotation: Primary nodes (Net Control, Medical) get fresh batteries first. Secondary nodes power down at night",
          "  • Charge priority: 1) One relay node (keeps network alive), 2) Net Control radio, 3) Medical comms, 4) All others",
          "",
          "ROLES & RESPONSIBILITIES:",
          "  • Net Control (1): Coordinates all comms, logs check-ins, prioritizes emergency traffic, maintains situation awareness",
          "  • Medical Lead (1): Triages injuries, coordinates medical resources, has list of medications needed by each household",
          "  • Security Patrol (2-3): Mobile with GMRS radios, conducts welfare checks, reports hazards, assists trapped persons",
          "  • Supply Coordinator (1): Tracks food/water/fuel/supplies, organizes distribution, prevents hoarding",
          "  • Welfare Checkers (all): Every household monitors Ch 15, reports status 3x daily (08:00, 14:00, 20:00)",
          "",
          "PHYSICAL PREPARATION:",
          "  • Secure outdoor antennas NOW or remove them. 120mph winds will destroy them and damage your home",
          "  • Move ALL electronics to 2nd floor or higher. Storm surge can reach 12+ feet",
          "  • Stage go-bag at highest point in home: Radio, battery bank, phone, water, food, first aid, copies of documents",
          "  • Mark evacuation routes on physical map. Identify multiple routes - roads will be blocked",
          "",
          "PRE-DEPLOY CACHES:",
          "  • Rally Point Alpha (high ground, safe structure): 1 Meshtastic node, 1 GMRS radio, 20,000mAh battery bank, in waterproof container",
          "  • Rally Point Bravo (alternate location): Same cache as Alpha. GPS coordinates shared with all households",
          "  • Vehicle staging: One vehicle per neighborhood fueled, loaded with: jump box, chainsaw, tow strap, first aid, radio",
          "",
          "POST-STORM ACTIONS (When winds <40mph):",
          "  • Safety first: Check for gas leaks, electrical hazards, structural damage BEFORE exploring",
          "  • Radio check-in: Brief status 'CALLSIGN - OK/INJURED/TRAPPED - HOUSE COLOR/NUMBER'. Net Control logs ALL responses",
          "  • Deploy solar panels: Position for latitude, clear debris, connect to charge controllers, begin battery recovery",
          "  • Welfare checks: Visual confirmation of every household. If no response on radio, physical check by security patrol",
          "  • Network assessment: Check all nodes, replace failures, optimize antenna positions based on new terrain",
          "",
          "LONG-TERM (Days 3-14):",
          "  • Establish routine: Morning net (situation update), work parties (debris/repairs), evening net (planning)",
          "  • Resource pooling: Centralize generators for scheduled charging, share water filtration, combine security patrols",
          "  • Health monitoring: Watch for dehydration, heat exhaustion, wound infections, medication shortages, mental health",
          "  • Outside contact: As connectivity permits, update family members. Keep messages brief to conserve power",
          "  • Documentation: Photos of damage, logs of expenses, records of volunteer hours - FEMA will need this",
          "",
          "CRITICAL DON'Ts:",
          "  • DON'T go outside during eye of storm - winds return from opposite direction with same or greater force",
          "  • DON'T touch downed power lines or standing water near them - assume ALL lines are live",
          "  • DON'T use generator indoors or in garage - carbon monoxide kills. Minimum 20 feet from windows",
          "  • DON'T drink flood water or use for hygiene - sewage contamination. Boil or filter all water",
          "  • DON'T overload communications with non-essential traffic - someone may have life-threatening emergency",
          "",
          "REMEMBER:",
          "  • Power will be out 5-14 days minimum. Some areas have waited 30+ days. Plan accordingly",
          "  • First responders are overwhelmed. You are on your own for 72 hours minimum. Longer in rural areas",
          "  • Your neighborhood network may be the ONLY working communications in your area. Take it seriously",
          "  • Preserve battery power like your life depends on it - because it might"
        ]
      },
      power_outage: {
        name: "Extended Power Outage",
        severity: "high",
        description: "Grid down for 48-72 hours minimum, potentially 7-14 days. Cause: Ice storm, equipment failure, or cyber attack. Cell towers on backup generators - will last 4-8 hours maximum. No refrigeration. No heating/cooling. No traffic lights. ATMs offline. Gas pumps don't work.",
        questions: [
          {
            q: "Do you have enough battery capacity to run ONE Meshtastic relay node continuously for 7 days?",
            tooltip: "One always-on relay node keeps entire network alive. Math: 80mAh avg draw × 168 hours = 13,440mAh minimum. Add 30% safety margin = 17,500mAh. That's TWO 10,000mAh banks with rotation.",
            yes: "Good. But have you TESTED actual runtime? Put node on battery bank, run for 24 hours, measure actual drain. Manufacturers lie about capacity. Real-world is often 70% of rated capacity. Retest monthly - batteries degrade.",
            no: "CRITICAL SHORTFALL: You need minimum 20,000mAh dedicated to ONE relay node. That's your network backbone. Without it, entire mesh dies in 24-48 hours and you go dark. Order now: Two 10,000mAh banks ($40 total). Test them immediately."
          },
          {
            q: "Do you have solar panels sized to keep at least one node alive indefinitely?",
            tooltip: "10W panel produces ~6W real-world. Meshtastic draws ~2W average. Minimum 15W panel for one node in good sun. Need 20W+ for reliable charging in cloudy/winter conditions.",
            yes: "Excellent. Verify: Panel can charge battery bank AND run node simultaneously. Test on cloudy day - that's your real capacity. Know your panel angle for latitude (roughly = your latitude in degrees). Clean panels monthly - dirt cuts output 40%.",
            no: "MAJOR VULNERABILITY: Batteries last 48-72 hours MAX. After that, total blackout unless you have solar. Get: 20W foldable panel ($50), 10A MPPT controller ($25), MC4 to battery adapter. This keeps ONE critical node alive forever. Scale up for full network."
          },
          {
            q: "Can you reduce mesh power settings to extend battery life 2-3x?",
            tooltip: "LongFast mode draws ~80mAh. MediumFast draws ~50mAh (40% less). ShortSlow draws ~30mAh (65% less). Range decreases but battery life increases dramatically.",
            yes: "Know the tradeoff: Lower power = shorter range but 2-3x battery life. In extended outage, switch to MediumFast or ShortSlow. Deploy additional relay nodes to compensate for reduced range. One high-power node wastes everyone's batteries.",
            no: "LEARN NOW: Settings > Radio Config > Modem Preset. Default is LongFast (maximum range, maximum battery drain). In extended outage, switch ALL nodes to MediumFast. Range drops from 5km to 3km but batteries last 2x longer. Worth it."
          },
          {
            q: "Do you have a written power rationing plan that everyone agreed to?",
            tooltip: "Without plan, people waste power on non-essentials and critical comms dies early. Need: charging schedule, priority order, runtime limits, check-in frequency.",
            yes: "Good. Verify: Posted in common area, everyone has copy, includes specific wattage/runtime for each device, designates 'charging hours' to avoid overload, identifies who has authority to override in emergency.",
            no: "COORDINATION FAILURE: In extended outage, human nature = everyone charges everything = available power depleted too fast. Create NOW: Priority list (1. Relay node, 2. Net Control radio, 3. Medical devices, 4. Security patrol radios, 5. Other). Post it. Enforce it."
          },
          {
            q: "Do you know which neighbors have generators and their fuel capacity?",
            tooltip: "Generators solve short-term charging but limited by fuel. Typical 2000W generator: 8-10 hours per gallon. Most people have 5-10 gallons = 2-4 days runtime max if running continuously.",
            yes: "Excellent intel. Plan: Coordinate generator runtime schedules to maximize efficiency. All charging happens during 2-hour windows. Centralize charging station. Track fuel consumption. When fuel hits 50%, switch to emergency-only mode.",
            no: "RESOURCE BLINDSPOT: You don't know what power sources exist in your neighborhood. Survey NOW: Who has generator? Size? Fuel capacity? Solar panels? Car inverters? Battery banks? Create shared resource map. In outage, coordinate access rather than everyone running generators 24/7."
          },
          {
            q: "Have you tested running all critical comms gear from 12V car battery with inverter?",
            tooltip: "Car batteries are mobile power banks (60Ah typical = 60,000mAh at 12V). 150W inverter ($25) makes them usable for USB charging. Can idle car 30min every 6 hours to recharge battery.",
            yes: "Smart backup. Know the limits: 150W inverter max. USB charging only (no laptop). Car battery should not drop below 12.4V or you won't start engine. Idle car 2000RPM for 30min every 6 hours to recharge. Monitor battery voltage with multimeter.",
            no: "UNTAPPED RESOURCE: Your car is a generator with 60,000mAh of mobile power. Get: 150W DC-to-AC inverter ($25) that plugs into cigarette lighter. Provides 2-3 USB charging ports. Idle engine 30min every 6 hours. This powers critical gear for days when batteries die."
          }
        ],
        timeline: [
          { time: "Hour 0 (Outage Begins)", action: "IMMEDIATE: Switch all devices to airplane mode except one designated phone. Turn off WiFi/Bluetooth on all devices. Deploy all battery banks. Activate mesh network. Test all nodes respond. Log start time." },
          { time: "Hour 1-2", action: "ORGANIZE: Conduct neighborhood check-in on GMRS Ch 15. Count who has power sources (generators, solar, battery banks). Establish Net Control. Begin coordinated power conservation. Turn off non-essential devices." },
          { time: "Hour 4", action: "CELL TOWERS FAILING: Most cell towers now offline. Mesh and GMRS are your ONLY communications. Test mesh propagation. Verify relay node has sufficient battery. Begin rotating charging if generators available." },
          { time: "Hour 8", action: "POWER CONSERVATION MODE: Switch all Meshtastic nodes to MediumFast or ShortSlow mode (Settings > Radio Config). Reduces power draw by 40-60%. Check battery levels on all devices. Establish charging schedule if generator available." },
          { time: "Hour 12", action: "FIRST CHECKPOINT: Radio check-in. Status of each household: OK/NEED HELP/MEDICAL. Begin tracking battery capacity remaining. Identify medical needs (insulin, oxygen, CPAP). Prioritize those for generator charging access." },
          { time: "Hour 24", action: "FIRST BATTERIES DEPLETING: Some handheld devices dying. Consolidate: One phone per household max, one radio designated as primary. Deploy solar panels if not already done. Begin car battery charging rotation for critical devices." },
          { time: "Hour 36", action: "SUSTAIN MODE: Most consumer devices now dead. Mesh network + GMRS radios are only functioning comms. Verify relay node still operational - this is your lifeline. Reduce check-ins to twice daily (morning/evening) to conserve power." },
          { time: "Hour 48 (Day 2)", action: "LONG-TERM PLANNING: If grid not restored, prepare for 7-14 day scenario. Establish runner system: designate 2-3 people with vehicles to coordinate supply runs. Create central charging station at house with generator/solar. Share fuel resources." },
          { time: "Hour 60", action: "GENERATOR FUEL CHECK: Most generators running on fumes if run continuously. Switch to scheduled charging windows: 2 hours morning (06:00-08:00), 2 hours evening (18:00-20:00). All charging happens in these windows ONLY. Conserve remaining fuel." },
          { time: "Hour 72 (Day 3)", action: "GRID RESTORATION EXPECTED: If grid still down, this is now major infrastructure failure. Escalate prep: Coordinate with adjacent neighborhoods. Pool resources. Establish security patrols (crime increases after 72hrs). Ration generator fuel strictly." },
          { time: "Day 4-5", action: "EXTENDED OUTAGE OPERATIONS: Solar-only for comms. Generator fuel reserved for medical emergencies only. Twice-daily radio nets (08:00, 20:00). Coordinate food sharing (refrigerators dead, freezers thawing). Address sanitation needs. Mental health support important." },
          { time: "Day 6-7", action: "WEEK-LONG SCENARIO: Establish new normal rhythm. Morning net: status updates, work assignments. Afternoon: coordinated tasks (debris clearing, well water access, solar deployment). Evening net: plan next day. Rotate leadership to prevent burnout." },
          { time: "Day 8-14", action: "SUSTAINED CRISIS: If grid down 2 weeks, this is catastrophic infrastructure failure. Maintain communications discipline. Solar is only sustainable power. Coordinate with authorities if possible. Begin planning for 30-day scenario. Community cohesion critical." }
        ],
        recommendations: [
          "IMMEDIATE ACTIONS (Hour 0-4):",
          "  • Test EVERY communication device NOW - verify it works before you need it desperately",
          "  • Switch all phones to airplane mode except ONE designated device per household",
          "  • Deploy all battery banks. Check actual charge level with voltage meter, not just indicator lights",
          "  • Activate mesh network. Verify all nodes respond. If any node fails, troubleshoot NOW not later",
          "  • Conduct GMRS radio net check-in. Everyone responds with status. Log who responds, who doesn't",
          "",
          "POWER MANAGEMENT (Critical for survival beyond 48 hours):",
          "  • ONE relay node stays on 24/7 - this is your network backbone. Give it best battery + solar",
          "  • Calculate battery needs: 80mAh × 168 hours (7 days) = 13,440mAh minimum per critical device",
          "  • Solar deployment priority: 20W panel + controller on relay node FIRST. Other nodes secondary",
          "  • Reduce mesh power: Settings > Radio > Modem Preset > Change from LongFast to MediumFast",
          "  • Car battery backup: 150W inverter ($25) + car battery = 60,000mAh mobile power source",
          "",
          "GENERATOR MANAGEMENT (If available):",
          "  • Typical 2000W generator: 8-10 hours per gallon. 5 gallons = 40-50 hours total runtime",
          "  • DO NOT run continuously - fuel will be gone in 2-3 days. Instead: scheduled charging windows",
          "  • Charging schedule: 2 hours morning (06:00-08:00), 2 hours evening (18:00-20:00) ONLY",
          "  • Centralize charging: One house becomes charging station. Everyone brings devices during windows",
          "  • Fuel conservation: When fuel hits 50% capacity, switch to emergency-only mode (medical devices priority)",
          "  • Carbon monoxide kills: Generator minimum 20 feet from ANY window or door. Outdoor only",
          "",
          "COMMUNICATION STRUCTURE:",
          "  • Net Control: One person coordinates all comms, logs check-ins, maintains situation awareness",
          "  • Check-in schedule: Twice daily (08:00, 20:00). Format: 'Callsign - Status - Brief needs'",
          "  • Emergency traffic: Breaks into net anytime. Medical, fire, safety issues = immediate response",
          "  • Social chatter: PROHIBITED on primary frequency. Save battery power for essential comms",
          "  • Runner system: 2-3 designated people with vehicles for supply runs, welfare checks, message delivery",
          "",
          "PRIORITY SYSTEM (Enforce strictly to prevent chaos):",
          "  • Priority 1: Relay node (keeps network alive)",
          "  • Priority 2: Net Control radio (coordinates everything)",
          "  • Priority 3: Medical devices (insulin pumps, oxygen, CPAP)",
          "  • Priority 4: Security patrol radios (safety)",
          "  • Priority 5: Everyone else rotates access",
          "",
          "RESOURCE MAPPING (Do this BEFORE outage):",
          "  • Survey neighborhood: Who has generator? Size? Fuel capacity?",
          "  • Who has solar panels? How many watts? Portable or fixed?",
          "  • Who has battery banks? Capacity?",
          "  • Who has car inverter? 12V outlets?",
          "  • Who has well water? (electric pumps won't work but hand pumps do)",
          "  • Who has medical needs requiring power? (O2, CPAP, refrigerated meds)",
          "",
          "COLD WEATHER CONSIDERATIONS (Winter outages):",
          "  • Battery capacity drops 30-40% in freezing temps. Double your capacity estimates",
          "  • Keep batteries WARM: inside jacket, sleeping bag, or insulated container",
          "  • Solar output drops: snow on panels = zero output. Keep panels clear and angled for low winter sun",
          "  • Heating priorities: Elderly, infants, medical patients. Pool resources, share space",
          "",
          "HOT WEATHER CONSIDERATIONS (Summer outages):",
          "  • Heat stress is major medical threat after 48 hours. Monitor elderly closely",
          "  • Battery charging in heat degrades batteries. Charge in shade if possible",
          "  • Solar panels LOVE heat - output increases. But batteries hate it - keep them cool",
          "  • Cooling centers: If available, coordinate group transport for vulnerable people",
          "",
          "WEEK 2+ PREPARATIONS (If outage extends beyond 7 days):",
          "  • This is now catastrophic infrastructure failure. Regional or national scope likely",
          "  • Fuel will be gone. Solar is ONLY sustainable option. Ration remaining fuel for medical only",
          "  • Food coordination: Refrigerators are dead. Share perishables before they spoil. Pool canned goods",
          "  • Water: If city water stops (pumps need power), know where wells, springs, or stores are",
          "  • Security: Crime increases after 72 hours. Organize neighborhood watch with radios",
          "  • Sanitation: Toilets may not flush (electric pumps). Have plan for waste disposal",
          "",
          "CRITICAL REMINDERS:",
          "  • Test equipment NOW, not when outage hits. Dead batteries and broken gear discovered during crisis = disaster",
          "  • One relay node 24/7 = entire network stays alive. This is your highest priority",
          "  • Batteries last 48-72 hours MAX without recharging. Solar is only solution for extended outages",
          "  • Generator fuel runs out fast if running continuously. Scheduled charging windows only",
          "  • Communication discipline saves lives: brief check-ins, no chatter, emergency breaks anytime",
          "  • After 72 hours, expect: crime increase, medical emergencies, mental health crisis, community stress",
          "",
          "YOU ARE ON YOUR OWN:",
          "  • First responders overwhelmed in wide-area outage. You are your own rescue for 72+ hours",
          "  • Neighbors helping neighbors is ONLY solution until grid restored",
          "  • Your planning and equipment TODAY determines your survival and comfort in extended outage",
          "  • This isn't theoretical - ice storms, equipment failures, and cyber attacks cause this scenario regularly"
        ]
      },
      wildfire: {
        name: "Wildfire Evacuation",
        severity: "critical",
        description: "Fast-moving wildfire within 5 miles. Winds 30+ mph pushing fire toward populated areas. Air quality hazardous. Evacuation may be ordered with little warning. Time-critical coordination needed.",
        constraints: [
          "Smoke reducing visibility",
          "Roads may be congested or blocked",
          "Cell towers overloaded or damaged",
          "Time pressure - fire moves faster than expected",
          "Air quality making breathing difficult"
        ],
        available_assets: [
          "Vehicles with fuel (hopefully full tanks)",
          "Meshtastic nodes with GPS enabled",
          "GMRS radios for convoy coordination",
          "Go-bags (if pre-packed)",
          "Knowledge of alternate routes"
        ],
        objective: "Coordinate safe evacuation of all residents and account for everyone at rally point",
        questions: [
          {
            q: "Do all nodes have GPS enabled for position tracking?",
            tooltip: "GPS tracking helps coordinate evacuation and locate stragglers during chaotic exodus",
            yes: "Excellent. You can track evacuation progress and find anyone who needs help. Share positions via mesh immediately.",
            no: "CRITICAL: Enable GPS NOW on all devices. Settings > Position > GPS Enabled. Essential for tracking during chaotic evacuation. Without it, you lose people."
          },
          {
            q: "Have you designated rally points outside the evacuation zone?",
            tooltip: "Pre-planned meeting locations in safe areas with clear landmarks",
            yes: "Share rally point GPS coordinates via mesh immediately. Verify everyone knows primary and backup locations.",
            no: "URGENT: Establish rally points NOW. Need: Primary 10+ miles away in safe direction, Backup alternate route, Clear landmarks (shopping center, school). Share coordinates with all neighbors."
          },
          {
            q: "Do you have vehicle-mounted or handheld GMRS radios for convoy coordination?",
            tooltip: "Mobile radios maintain comms during evacuation when stationary nodes are abandoned",
            yes: "Good. Mobile nodes/radios will maintain mesh and voice comms during movement. Establish convoy frequency Ch 15. Designate lead and sweep vehicles.",
            no: "MAJOR GAP: Once you leave, home nodes are abandoned. You lose coordination ability. At minimum: Handheld GMRS radios, everyone on Ch 15, convoy stays together visually."
          },
          {
            q: "Can you account for all residents right now? Who needs help evacuating?",
            tooltip: "Knowing who needs assistance BEFORE evacuation is critical - no time to figure this out during",
            yes: "Document: Who's leaving in each vehicle, who needs ride, who has medical issues, who has pets. Share via mesh. Assign buddy system.",
            no: "CRITICAL: Do neighborhood count NOW. Broadcast on mesh: 'All residents report in with status and needs'. Create list: who's leaving alone, who needs ride, who needs medical help, who's refusing to leave."
          },
          {
            q: "Do you have N95 masks or respirators for smoke?",
            tooltip: "Wildfire smoke contains toxic particles. Regular masks don't help. N95 minimum required.",
            yes: "Distribute to those who don't have them. Mandatory for anyone driving through smoke. Reduces lung damage and keeps drivers alert.",
            no: "WARNING: Smoke inhalation is serious medical threat. Wet cloth over face is better than nothing but not adequate. Stay low in vehicle if driving through smoke. Windows UP, AC on recirculate."
          }
        ],
        timeline: [
          { time: "Alert Issued", action: "IMMEDIATE: Enable GPS on all nodes. Broadcast evacuation alert on mesh and GMRS Ch 15. Account for all residents - who's here, who needs help. Grab go-bags." },
          { time: "T-30 minutes", action: "ACCOUNT FOR EVERYONE: Door-to-door if time permits. Document who's in each vehicle. Assign rides to those without transport. Identify who needs medical help. Share via mesh. No one left behind." },
          { time: "T-15 minutes", action: "CONVOY FORMATION: Lead vehicle (knows route), family vehicles in middle, sweep vehicle (ensures no one left). All on GMRS Ch 15. Share rally point GPS one more time. Last chance for stragglers." },
          { time: "Evacuation Begins", action: "MAINTAIN CONTACT: Regular position updates via mesh. Voice comms on Ch 15. Speed of slowest vehicle. DO NOT separate. If convoy splits, both parts need radio contact." },
          { time: "En Route", action: "ADAPT: If road blocked, lead vehicle decides alternate route, broadcasts to convoy. Maintain spacing - don't create gaps. Watch for hazards: downed trees, power lines, panicked drivers. Help each other." },
          { time: "Rally Point", action: "ACCOUNTABILITY: Check in on arrival. Net control logs everyone. Verify all expected vehicles arrived. If someone missing, contact authorities immediately. Do NOT return to search." },
          { time: "Post-Evacuation", action: "COMMUNICATION HUB: Rally point becomes coordination center. Mesh still active if nodes survived. Monitor official channels for all-clear. Share information about road conditions, fire progress. Support each other." }
        ],
        recommendations: [
          "IMMEDIATE ACTIONS (Do in next 10 minutes):",
          "  • Enable GPS on ALL Meshtastic devices: Settings > Position > GPS Enabled",
          "  • Broadcast evacuation notice: 'WILDFIRE EVACUATION - All residents report status'",
          "  • Grab go-bags (if you have them). If not: meds, documents, water, phone chargers",
          "  • Fill vehicle gas tanks if time permits. Do NOT wait in line - leave with what you have",
          "",
          "ACCOUNTABILITY (Critical - people die when forgotten):",
          "  • Go door-to-door or call every household: Who's home? Who needs ride? Who needs medical help?",
          "  • Create list: 'Smith family: 4 people, leaving in red truck' - share via mesh",
          "  • Assign rides: 'Jones family needs ride - Smith family will take them'",
          "  • Identify vulnerable: Elderly, disabled, oxygen/meds needed, pets",
          "  • Document who's refusing to leave (inform authorities, don't force)",
          "",
          "CONVOY COORDINATION:",
          "  • Lead vehicle: Knows route, has GPS, makes decisions, broadcasts changes",
          "  • Middle vehicles: Family groups, those needing help, slower vehicles",
          "  • Sweep vehicle: Last out, ensures no one left behind, has GMRS radio",
          "  • All vehicles on GMRS Ch 15 for voice coordination",
          "  • Maintain visual contact - don't let gaps form",
          "  • Speed of slowest vehicle - NO ONE gets left behind",
          "",
          "RALLY POINT SETUP:",
          "  • Primary: 10+ miles away, UPWIND of fire, clear landmark (shopping center parking lot)",
          "  • Backup: Alternate direction in case primary route blocked",
          "  • Share GPS coordinates: 'Rally Point Alpha: 28.1234, -82.5678 - Walmart parking lot on Main St'",
          "  • Designate Net Control at rally point: Someone stays by radio, logs arrivals",
          "",
          "COMMUNICATION PLAN:",
          "  • Primary: GMRS Ch 15 for voice convoy coordination",
          "  • Secondary: Meshtastic mesh for position tracking and text updates",
          "  • Emergency: Any means necessary - CB Ch 9, FRS, phone if working",
          "  • Position updates: Every 5-10 minutes 'Vehicle 3 - passing Main and Oak, convoy intact'",
          "",
          "ROUTE PLANNING:",
          "  • Know 3 routes out: Primary, Secondary, Tertiary",
          "  • Avoid: Areas where fire already crossed, low areas (smoke pools), single-lane roads (bottleneck)",
          "  • Prefer: Multi-lane highways, routes away from fire, high ground (above smoke)",
          "  • If route blocked: Lead vehicle decides, broadcasts 'Taking alternate route to Oak Street'",
          "",
          "SMOKE SAFETY:",
          "  • N95 masks or better - regular cloth masks don't filter smoke particles",
          "  • In vehicle: Windows UP, AC on RECIRCULATE (blocks outside air)",
          "  • If driving through heavy smoke: Headlights on, slow down, increase following distance",
          "  • If smoke too thick: Pull over TOGETHER, wait for visibility, maintain radio contact",
          "",
          "AT RALLY POINT:",
          "  • Check in with Net Control immediately on arrival",
          "  • Account for all vehicles and people: 'All 15 households present and accounted for'",
          "  • If anyone missing: Contact authorities, provide last known position from GPS",
          "  • Do NOT return to look for them - authorities will search",
          "  • Set up coordination center: One person monitors official channels, updates everyone",
          "",
          "WHAT NOT TO DO:",
          "  • DON'T wait for official evacuation order if you see/smell fire - LEAVE",
          "  • DON'T go back for forgotten items - stuff is replaceable, you are not",
          "  • DON'T separate from convoy - strength in numbers, help each other",
          "  • DON'T ignore smoke - it kills more people than fire does",
          "  • DON'T block roads - pull fully off if you must stop",
          "  • DON'T return until official all-clear - fires can reignite",
          "",
          "PRE-PLANNING (Do this NOW, before fire):",
          "  • Drive your evacuation routes - know which roads go where",
          "  • Identify 3 rally points in different directions",
          "  • Share rally point GPS with all neighbors NOW",
          "  • Pre-pack go-bags: meds, documents, photos, chargers, water, N95 masks",
          "  • Test GPS on all Meshtastic devices monthly",
          "  • Keep vehicle gas above half-tank during fire season",
          "",
          "REMEMBER:",
          "  • Wildfires move faster than you think - 5mph in grass, 14mph in forest with wind",
          "  • Smoke and panic kill more people than fire - stay calm, help each other",
          "  • Things are replaceable, people are not - don't risk lives for possessions",
          "  • You are not firefighters - your job is GET OUT SAFELY",
          "  • Coordination saves lives - account for everyone, leave together, arrive together"
        ]
      },
      earthquake: {
        name: "Earthquake / Infrastructure Damage",
        severity: "critical",
        description: "Major earthquake (6.0+ magnitude). Significant shaking felt, possible structural damage. Aftershocks expected and can be nearly as strong. Power out, gas lines may be ruptured, water mains broken. Cell towers may be damaged or overloaded.",
        constraints: [
          "Ongoing aftershock risk - buildings may be unstable",
          "No utility power, possibly for days or weeks",
          "Gas leaks possible - explosion hazard",
          "Water contamination likely",
          "Communications infrastructure damaged",
          "Roads may be impassable (cracks, debris, collapsed bridges)"
        ],
        available_assets: [
          "Portable radios (if they survived shaking)",
          "Battery banks (if not damaged)",
          "Neighbors in close proximity",
          "Manual tools (no power tools work)",
          "First aid supplies",
          "Whatever supplies survived in your home"
        ],
        objective: "Ensure immediate safety, account for all residents, coordinate search and rescue for trapped persons, establish communications and mutual aid",
        questions: [
          {
            q: "Have you done immediate safety check: injuries, gas leaks, structural damage?",
            tooltip: "First 60 seconds after shaking stops are most dangerous - aftershocks, gas explosions, collapse",
            yes: "Good. If gas leak detected: shut off at meter, do NOT turn back on yourself. If structural damage: evacuate to open space. Treat injuries with first aid.",
            no: "URGENT: STOP. Do safety check NOW before using electronics: 1) Check family for injuries, 2) Smell for gas, 3) Look for cracks in walls/ceiling, 4) Check for fires. If any major issues, evacuate FIRST."
          },
          {
            q: "Are your communication devices in earthquake-safe locations and operational?",
            tooltip: "Devices on high shelves fell and broke. Antennas may be damaged. Check everything before assuming it works.",
            yes: "Test them NOW. Power on, verify display works, check antenna connections. Many devices look fine but have internal damage. Test actual transmission.",
            no: "WARNING: Assume equipment is damaged until proven otherwise. Check: antennas still attached, cases not cracked, battery compartments intact. If doubtful, use most rugged devices first (handheld GMRS)."
          },
          {
            q: "Can you safely operate without fixed infrastructure? (Buildings may be unsafe)",
            tooltip: "Aftershocks can collapse damaged buildings. May need to operate from yards, streets, parks.",
            yes: "Good. Use portable nodes and handheld radios from open areas. Establish temporary relay point in safe location - parking lot, park, away from buildings.",
            no: "CRITICAL: Do NOT rely on home-based equipment. Assume buildings are unsafe. Grab: Handheld radios, battery banks, first aid. Operate from yards or streets. Aftershocks WILL come."
          },
          {
            q: "Do you have 72+ hours of battery reserves or alternative power?",
            tooltip: "Earthquake recovery takes minimum 3 days, often weeks. Grid restoration unpredictable.",
            yes: "Excellent but ration strictly. You don't know when power returns. Prioritize: Search/rescue comms > medical needs > welfare checks. Non-essential devices OFF.",
            no: "CRITICAL: You have 24-48 hours of comms maximum. After that, total blackout. Use power ONLY for: life-threatening emergencies, locating trapped persons, coordinating rescue. Everything else is luxury."
          },
          {
            q: "Can you account for all neighbors? Anyone trapped, injured, or missing?",
            tooltip: "Golden hour for rescue is first 60 minutes. After that, survival rates drop dramatically.",
            yes: "Document carefully: Who's OK, who's injured, who's trapped, who's missing. Broadcast via radio. Coordinate rescue teams. Trapped persons are HIGHEST priority.",
            no: "URGENT: Begin immediate accountability. Go door to door if safe. Shout, listen for responses. Mark houses: X = checked/empty, O = people inside/OK, T = trapped/needs help. Broadcast findings on radio."
          }
        ],
        timeline: [
          { time: "Immediate (0-5 min)", action: "SAFETY FIRST: Drop-Cover-Hold during shaking. After stops: Check injuries, smell gas, assess structure. If gas leak or major damage, EVACUATE to open area. Grab radio and go-bag if time." },
          { time: "+5-15 minutes", action: "INITIAL CONTACT: Activate portable radios from OUTSIDE or safe area. Test nodes - may be damaged. Broadcast: 'This is [location], checking in after earthquake, need status reports'. Listen for responses." },
          { time: "+15-30 minutes", action: "RAPID ACCOUNTABILITY: Quick door-to-door if buildings appear stable. Mark houses: X = checked, O = OK, T = trapped. DO NOT enter obviously damaged buildings. Shout through windows. Listen for responses. Time is critical for trapped persons." },
          { time: "+30-60 minutes (Golden Hour)", action: "SEARCH AND RESCUE PRIORITY: Any reports of trapped persons = highest priority. Coordinate rescue teams via radio. Need: Tools, medical supplies, strong people. Keep radio nets clear for rescue coordination. DO NOT enter collapsed structures without training." },
          { time: "+1-2 hours", action: "MEDICAL TRIAGE: Set up casualty collection point in safe open area. Account for all injuries. Coordinate transport to hospitals if possible. Realize 911 is overwhelmed. Begin neighbor-to-neighbor first aid." },
          { time: "+2-6 hours", action: "ESTABLISH COORDINATION CENTER: Safe outdoor location becomes hub. Set up relay node if equipment survived. Begin organized welfare checks. Document: Who needs medical help, who needs water, who has supplies to share, structural damage locations." },
          { time: "+6-12 hours", action: "AFTERSHOCK MANAGEMENT: Major aftershocks likely. Be ready to take cover. Don't sleep under damaged ceilings. Coordinate watches. Share resources: Food, water, batteries. Begin addressing immediate needs: Shelter, water, sanitation." },
          { time: "+12-24 hours", action: "SUSTAINED OPERATIONS: Establish routine. Twice-daily radio nets. Coordinate supply distribution. Address sanitation needs (toilets may not work). Security patrols (looting can start). Mental health support - people are traumatized." },
          { time: "+24-72 hours", action: "LONG-TERM COORDINATION: If authorities not yet arrived, neighborhood self-governs. Water purification critical. Food rationing. Medical monitoring. Communications discipline - conserve batteries. Begin damage documentation for insurance/FEMA." },
          { time: "+72 hours onward", action: "RECOVERY PHASE: Outside help should arrive. Maintain local coordination. Help authorities with needs assessment. Continue supporting vulnerable neighbors. Plan for extended displacement if homes unsafe." }
        ],
        recommendations: [
          "IMMEDIATE POST-QUAKE (First 5 minutes - LIFE SAFETY):",
          "  • Stay OUTSIDE or move to open area after shaking stops",
          "  • Check all household members for injuries - treat bleeding, fractures",
          "  • SMELL for gas - if detected, shut off at meter, do NOT use electronics or open flame",
          "  • Look for obvious structural damage: cracks, sagging, tilting",
          "  • If major damage or gas leak: EVACUATE immediately with go-bag and radio",
          "",
          "SAFETY ASSESSMENT (First 30 minutes):",
          "  • DO NOT re-enter obviously damaged buildings",
          "  • Check for: Gas smell, electrical sparks/smoke, water leaks, cracked walls, shifted foundation",
          "  • Mark unsafe structures with orange X or spray paint",
          "  • Wear shoes (broken glass everywhere) and gloves",
          "  • Aftershocks WILL occur - be ready to drop/cover/hold again",
          "",
          "COMMUNICATION PRIORITY:",
          "  • Handheld GMRS radios are most reliable - simple, rugged, less likely damaged",
          "  • Meshtastic nodes: Check physical condition before powering on (cracked cases = possibly damaged)",
          "  • Test equipment from OUTSIDE buildings initially",
          "  • Establish relay point in OPEN AREA away from structures (parking lot, park, playing field)",
          "  • Frequency: GMRS Ch 15 for voice, Meshtastic for GPS tracking and text",
          "",
          "ACCOUNTABILITY SYSTEM:",
          "  • Use marking system: X = checked/empty, O = people inside/OK, T = trapped/needs help, ? = unable to check",
          "  • Broadcast findings: 'House 123 Oak St: Marked T - 2 persons trapped in basement'",
          "  • Create physical map with markings - electronics may fail",
          "  • Re-check after major aftershocks - conditions change",
          "",
          "SEARCH AND RESCUE (Only if trained):",
          "  • DO NOT enter collapsed or heavily damaged structures without training",
          "  • Shout and listen - trapped persons may respond verbally",
          "  • If you hear someone trapped: Note exact location, mark it clearly, radio for help",
          "  • Use basic tools only: Pry bars, come-alongs, NOT heavy equipment (may cause further collapse)",
          "  • Always have lookout watching for aftershocks",
          "  • Document: Location, number of persons, accessibility, special needs (medical, oxygen, etc)",
          "",
          "MEDICAL TRIAGE:",
          "  • Set up casualty collection point in OPEN area (away from buildings)",
          "  • Prioritize: Active bleeding > fractures > minor injuries",
          "  • Realize 911 is overwhelmed or not functioning",
          "  • Coordinate transport to hospitals if roads passable and critical injuries present",
          "  • Begin neighbor first aid: Stop bleeding (pressure), stabilize fractures (splint), treat shock (warmth, elevate legs)",
          "",
          "UTILITY MANAGEMENT:",
          "  • Gas: If you smell it or see damage, shut off at meter. DO NOT turn back on yourself",
          "  • Water: Assume contaminated until tested. Hot water heater has 40-50 gallons if intact",
          "  • Electricity: Will be out. Do NOT use generators indoors (carbon monoxide)",
          "  • Sanitation: Toilets may not flush (broken sewer lines). Bucket toilet with bags is solution",
          "",
          "POWER AND COMMUNICATIONS:",
          "  • Battery capacity is PRECIOUS - ration strictly",
          "  • Priority order: 1) Search/rescue comms, 2) Medical coordination, 3) Welfare checks, 4) Everything else",
          "  • Reduce mesh transmission power to extend battery life",
          "  • Twice-daily radio nets only - not constant chatter",
          "  • Conserve phone batteries (airplane mode when not needed)",
          "",
          "AFTERSHOCK PREPARATION:",
          "  • Largest aftershock usually occurs within 24 hours",
          "  • Aftershocks can cause already-damaged structures to collapse",
          "  • DO NOT sleep under damaged ceilings or near heavy furniture",
          "  • Set up outdoor sleeping area if weather permits",
          "  • Have radio and whistle within reach at all times",
          "  • Re-assess buildings after each major aftershock",
          "",
          "RESOURCE COORDINATION:",
          "  • Water: Pool containers, share purification methods (boil 1 min or 8 drops bleach per gallon)",
          "  • Food: Share perishables first (no refrigeration), ration dry goods",
          "  • Shelter: Those with outdoor space host those whose homes are unsafe",
          "  • Tools: Coordinate use - don't duplicate tools, share efficiently",
          "  • Medical: Identify neighbors with medical training or supplies",
          "",
          "SECURITY AND MENTAL HEALTH:",
          "  • Organize security patrols - looting can occur after 24-48 hours",
          "  • Watch for vulnerable persons: Elderly, children, those with disabilities",
          "  • Trauma is real - people will be shaken emotionally as well as physically",
          "  • Keep families together when possible",
          "  • Maintain routine where possible - humans need structure in chaos",
          "",
          "CRITICAL DON'Ts:",
          "  • DON'T re-enter damaged buildings to retrieve items - possessions aren't worth your life",
          "  • DON'T use candles or open flames if any chance of gas leaks",
          "  • DON'T flush toilets if you suspect sewer line damage (creates backflow)",
          "  • DON'T drink tap water without purifying - water mains are likely broken",
          "  • DON'T attempt structural repairs - leave that for professionals",
          "  • DON'T ignore aftershock warnings - they can be nearly as damaging as main quake",
          "",
          "REMEMBER:",
          "  • First hour is most critical for rescuing trapped persons - survival rates drop fast",
          "  • Aftershocks are guaranteed - largest one typically within 24 hours",
          "  • Recovery takes weeks to months, not days",
          "  • Your neighborhood is on its own for at least 72 hours - plan accordingly",
          "  • Coordination and mutual aid save lives when professional help is overwhelmed"
        ]
      },
      winter_storm: {
        name: "Winter Storm / Ice Storm",
        severity: "high",
        description: "Severe ice storm with prolonged freezing temperatures. Ice accumulation on power lines causing widespread outages. Roads impassable. Extreme cold (below 20°F/-7°C) affecting battery performance and creating hypothermia risk. Outage expected 3-7 days minimum.",
        constraints: [
          "Sub-freezing temperatures dramatically reduce battery capacity (30-50% loss)",
          "Ice on power lines = extended outage (days to weeks)",
          "Roads ice-covered and impassable",
          "Heating is life-critical issue (hypothermia risk)",
          "Pipes may freeze and burst",
          "Electronics fail in extreme cold"
        ],
        available_assets: [
          "Battery banks (if kept warm)",
          "Radios (keep in warm pocket when not transmitting)",
          "Neighbors for resource and warmth sharing",
          "Fireplaces/wood stoves (if you have them)",
          "Generator (if fuel available and not frozen)",
          "Vehicles (emergency heating source)"
        ],
        objective: "Maintain communications while managing power in extreme cold, coordinate heating resources, prevent hypothermia deaths, and ensure vulnerable populations survive extended cold",
        questions: [
          {
            q: "Are you keeping batteries WARM? (Inside clothing, sleeping bag, or insulated container)",
            tooltip: "Cold kills battery capacity. At 20°F, lithium batteries lose 30-40% capacity. At 0°F, lose 50%+. Cold batteries also won't charge.",
            yes: "Good. Keep spares inside jacket or sleeping bag between uses. Charge in warm location. Return to warmth immediately after use. Monitor voltage - cold batteries show false 'full' readings.",
            no: "CRITICAL: Cold will kill your batteries in hours. Do NOW: Move ALL batteries to warm location (inside clothing, sleeping bag, near body heat). Test capacity - probably much lower than you think. Won't charge unless warm (>40°F)."
          },
          {
            q: "Do you have backup heating that doesn't require electricity?",
            tooltip: "Furnaces need electricity for blowers. Hypothermia kills. Heating is highest priority - even above communications.",
            yes: "Excellent: Fireplace, wood stove, propane heater (VENTILATED), kerosene heater. Coordinate with neighbors: Those with heat host those without. Share warmth = survival.",
            no: "CRITICAL: Without heat source in sub-freezing temps, hypothermia begins in 3-4 hours indoors. Options: Vehicle (outside for CO risk), sleep in insulated room, body heat in sleeping bags, coordinate with neighbors who have heat sources."
          },
          {
            q: "Do you have winter-rated sleeping bags and cold weather clothing for extended stay?",
            tooltip: "Indoor temperatures will drop to outdoor temps within 24-48 hours without heat. Proper clothing = survival.",
            yes: "Good. Layer up now before it gets colder. Wear hat indoors (40% heat loss through head). Insulate floor from below. Close off rooms to concentrate heat in small space.",
            no: "WARNING: Indoor temp will match outdoor in 1-2 days. Need: Layers (wool/synthetic, NOT cotton), hat, gloves, warm socks, sleeping bags rated to 0°F or combine multiple bags. Worst case: sleep in insulated closet with multiple blankets."
          },
          {
            q: "Have you identified vulnerable neighbors? (Elderly, infants, medical conditions)",
            tooltip: "Cold kills the vulnerable first: elderly, very young, diabetics, those with heart conditions. They need priority for heat.",
            yes: "Create heat-sharing plan NOW: Those with warming sources host vulnerable neighbors. Conduct welfare checks every 4-6 hours. Watch for confusion (hypothermia sign).",
            no: "URGENT: Survey neighborhood NOW. Identify: Elderly living alone, infants/small children, people with medical conditions, those without heat sources. Bring them to homes with heat BEFORE they get hypothermia."
          },
          {
            q: "Can you run radios and nodes from solar panels despite cold/ice?",
            tooltip: "Solar panels work in cold (actually MORE efficient), but ice coverage = zero output. Snow must be cleared frequently.",
            yes: "Monitor carefully: Ice on panels = no output. Clear ice/snow immediately. Angle panels steep (60+ degrees) so ice slides off. Output is good in cold sun. Focus on midday hours (max sun).",
            no: "Plan for battery-only operation. With cold reducing capacity 30-50%, your runtime is MUCH shorter than summer. Extreme power rationing required. Consider solar if you can clear panels."
          }
        ],
        timeline: [
          { time: "Pre-storm", action: "PREPARE: Charge everything to 100%, bring ALL batteries inside to warm location, fill bathtubs with water (pipes will freeze), test heating sources, coordinate with neighbors on heat-sharing plan" },
          { time: "Storm begins", action: "MINIMIZE OUTDOOR OPS: Ice makes everything dangerous. Falls cause injuries. Keep radios warm in pockets. Transmit only when necessary. Brief check-in on GMRS Ch 15, then power down to conserve." },
          { time: "+6 hours", action: "FIRST CHECK-IN: Everyone reports status and heating situation. Identify who has heat, who doesn't. Begin coordination: Those with heat source host those without. Elderly and infants get priority. Make moves while daylight available." },
          { time: "+12 hours", action: "TEMPERATURE MANAGEMENT: Indoor temps dropping. Close off unused rooms. Insulate windows with blankets. Everyone layers up. Vulnerable persons to warming centers (neighbor homes with heat). Begin battery warming rotation." },
          { time: "+24 hours", action: "ESTABLISH WARMING CENTERS: 2-3 homes with heat become neighborhood hubs. Coordinate shifts: Warm up, charge devices, return home. Twice-daily radio nets only (morning, evening). Conserve power aggressively." },
          { time: "+48 hours (Day 2)", action: "WELFARE CHECKS CRITICAL: Hypothermia sets in after prolonged cold. Check vulnerable persons every 4-6 hours. Signs: Confusion, slurred speech, shivering stopped (late stage). Move to warmth immediately if symptomatic." },
          { time: "+72 hours (Day 3)", action: "WATER CONCERNS: Pipes frozen or burst. Snow/ice melting for water (boil or treat). Share water sources. Coordinate generator use for limited water pump operation. Sanitation becomes issue (frozen toilets)." },
          { time: "Day 4-7", action: "SUSTAINED COLD OPERATIONS: Routine is critical. Morning net (status/needs), midday warming rotation, evening net (planning). Share food (combine cooking = efficiency). Mental health support. Boredom and cabin fever are real." },
          { time: "Day 7+", action: "EXTENDED SCENARIO: If still no power after week, this is major infrastructure failure. Coordinate fuel sharing for generators. Begin planning for multi-week cold. Address morale - people are exhausted and cold." }
        ],
        recommendations: [
          "IMMEDIATE ACTIONS (Before storm or in first hours):",
          "  • Move ALL batteries to warm location: inside jacket, sleeping bag, or insulated container",
          "  • Charge everything to 100% while power still available",
          "  • Fill bathtubs, sinks, containers with water (pipes WILL freeze)",
          "  • Test heating sources: fireplace, wood stove, generator",
          "  • Close off rooms - concentrate living in smallest heated space",
          "  • Coordinate neighbor heat-sharing plan BEFORE temps drop",
          "",
          "BATTERY MANAGEMENT IN EXTREME COLD:",
          "  • Cold reduces capacity 30-50%: Your '10,000mAh' bank is now 5,000-7,000mAh effective",
          "  • Keep batteries WARM: Inside clothing, sleeping bag, near body heat",
          "  • Charge in warm location (>40°F) - won't charge properly when cold",
          "  • Use immediately after charging, then return to warmth",
          "  • Test capacity - cold batteries show false voltage readings",
          "  • Rotate: One battery in use (warm), one charging (warm location), spare warming",
          "",
          "RADIO OPERATIONS IN COLD:",
          "  • Keep radio in warm pocket, only remove to transmit",
          "  • Transmit briefly, then return to pocket immediately",
          "  • GMRS voice preferred over mesh data (lower power, faster transmit)",
          "  • Reduce transmission power if using mesh - every mW counts",
          "  • Schedule nets only twice daily: morning (08:00) and evening (20:00)",
          "  • NO social chatter - power conservation is life-critical",
          "",
          "HEATING HIERARCHY (Priority order):",
          "  • Priority 1: Vulnerable persons (elderly, infants, medical conditions)",
          "  • Priority 2: Warming centers (homes with heat sources)",
          "  • Priority 3: Everyone else rotates through warming centers",
          "  • Create shifts: 2-3 hours warming, 4-6 hours in own home bundled up",
          "  • Those with fireplaces/wood stoves become community warming centers",
          "",
          "WARMING CENTER SETUP:",
          "  • 2-3 homes with heat sources = warming centers",
          "  • Coordinate schedule: 'Warming Center Alpha open 08:00-12:00, 14:00-18:00, 20:00-22:00'",
          "  • Bring: Devices to charge, food to share, water bottles to fill",
          "  • Host provides: Heat, charging station, water",
          "  • Rotate hosts to prevent burnout",
          "  • Keep list of who came when (accountability)",
          "",
          "COLD SURVIVAL BASICS:",
          "  • Layer clothing: Base (synthetic), insulation (fleece/down), outer (wind/water)",
          "  • Cotton KILLS in cold - wet cotton = hypothermia. Use wool or synthetic",
          "  • Cover head indoors - 40% of heat loss is through head",
          "  • Insulate floor: Cardboard, foam, rugs create barrier from cold floor",
          "  • Close doors, seal drafts, hang blankets over windows",
          "  • Occupy smallest room - easier to keep warm with body heat",
          "",
          "HYPOTHERMIA RECOGNITION (Life-threatening):",
          "  • Early signs: Shivering, cold hands/feet, mild confusion",
          "  • Moderate: Shivering stops (!), slurred speech, drowsiness, confusion",
          "  • Severe: No shivering, can't walk, unconscious, appears dead",
          "  • Treatment: Move to warmth immediately, remove wet clothes, warm core first (not extremities), warm sweet drinks if conscious",
          "  • If shivering stopped = late stage = medical emergency",
          "",
          "VULNERABLE POPULATION MANAGEMENT:",
          "  • Elderly: Check every 4-6 hours. Confusion is hypothermia sign. Bring to warmth immediately.",
          "  • Infants/children: Lose heat faster than adults. Keep wrapped warm, with hat. Check often.",
          "  • Diabetics: Cold affects blood sugar. Extra monitoring needed.",
          "  • Heart conditions: Cold stresses heart. Avoid overexertion. Keep warm.",
          "  • Anyone living alone: Buddy system - someone checks on them regularly",
          "",
          "WATER IN FREEZING CONDITIONS:",
          "  • Pipes freeze at 20°F and below, burst when they thaw",
          "  • Fill containers BEFORE pipes freeze (you get one chance)",
          "  • Melt snow/ice for water: Must purify (boil 1min or treat)",
          "  • Coordinate water sources: Who has unfrozen pipes, wells, stored water",
          "  • Drip faucets at coldest point to prevent freezing (if water still flowing)",
          "",
          "FOOD AND COOKING:",
          "  • Refrigerator unnecessary - outside is colder. Use porch/garage as freezer",
          "  • Cooking = heat source: Combine households for meals = share warmth",
          "  • If no cooking ability: Cold food is OK short-term. Better than using precious fuel.",
          "  • Share hot water for drinks - raises core temp, boosts morale",
          "  • Eat extra calories - body burns more keeping warm",
          "",
          "GENERATOR USE IN COLD:",
          "  • Gasoline gels in extreme cold - store fuel indoors or add stabilizer",
          "  • Generator won't start if too cold - may need to warm engine first",
          "  • Schedule runtime: 2 hours morning, 2 hours evening = charge everything",
          "  • NEVER run indoors - carbon monoxide kills in 15-30 minutes",
          "  • Keep exhaust pointed away from structures",
          "  • Share generator time: Neighbor A morning, Neighbor B evening",
          "",
          "SOLAR IN WINTER/ICE:",
          "  • Panels work in cold (actually more efficient than heat)",
          "  • Ice/snow coverage = ZERO output. Must be cleared",
          "  • Angle steep (60+ degrees) so ice slides off naturally",
          "  • Use roof rake or long pole to clear from ground",
          "  • Midday sun is best - mornings/evenings too low angle in winter",
          "  • Even partial cloud reduces output dramatically - plan accordingly",
          "",
          "VEHICLE AS EMERGENCY HEAT:",
          "  • Last resort - use only when no other option",
          "  • Run engine outside (NEVER in garage) - 10 minutes every hour max",
          "  • Watch fuel gauge - you need gas to evacuate if roads clear",
          "  • Check exhaust clear of snow (carbon monoxide backs up if blocked)",
          "  • Stay with vehicle - watch for exhaust leaks into cabin",
          "",
          "CRITICAL DON'Ts:",
          "  • DON'T use generator, grill, or camp stove indoors - carbon monoxide kills",
          "  • DON'T let vulnerable persons 'tough it out' alone - check on them constantly",
          "  • DON'T ignore hypothermia signs - confusion means immediate action needed",
          "  • DON'T waste battery power on non-essentials - power = survival",
          "  • DON'T go outside unnecessarily - falls on ice cause serious injuries",
          "  • DON'T drain vehicle batteries trying to charge devices - need car to evacuate",
          "",
          "REMEMBER:",
          "  • Cold reduces battery capacity 30-50% - your gear lasts half as long",
          "  • Heating is more important than communications - prevent hypothermia first",
          "  • Vulnerable populations die first in cold - check elderly and infants constantly",
          "  • Indoor temps will match outdoor in 24-48 hours without heat source",
          "  • Coordinate and share warmth - no one survives extended cold alone",
          "  • Recovery takes longer in ice storms - infrastructure repairs are slower in cold"
        ]
      },
      
      lights_out: {
        name: "The Lights Went Out",
        severity: "high",
        description: "Severe thunderstorm knocks out grid power across neighborhood. Cell networks overloaded. Internet down. Nightfall in 3 hours.",
        constraints: [
          "No utility power",
          "Cellular unreliable or down",
          "Nightfall approaching",
          "No clear restoration timeline"
        ],
        available_assets: [
          "Battery power station or banks",
          "Wi-Fi router (if you have battery power)",
          "1-3 handheld radios (GMRS/FRS)",
          "Neighbors within 200-500m range",
          "Possibly generator with fuel"
        ],
        objective: "Establish local communication and share situational awareness before nightfall",
        courses_of_action: [
          {
            name: "COA 1: Do Nothing",
            description: "Wait for services to return. Monitor phone for updates.",
            effort: "Minimal",
            resources: "None required",
            outcome: "No shared awareness. Anxiety rises as darkness falls. Each household isolated. If emergency occurs, no way to coordinate help. Uncertainty about neighbors' status.",
            best_for: "Short outages (<2 hours) with clear restoration timeline"
          },
          {
            name: "COA 2: Ad-hoc Check-Ins",
            description: "Use handheld radios to check immediate neighbors only. No organized network.",
            effort: "Low",
            resources: "2-3 handheld radios, agreed frequency",
            outcome: "Works for 3-5 adjacent houses. Limited coverage. Person-to-person relay required for farther neighbors. Better than nothing but inefficient.",
            best_for: "Very small groups or when time is extremely limited"
          },
          {
            name: "COA 3: Neighborhood Relay Network",
            description: "Deploy temporary radio relay at high point (balcony, attic window, roof). Announce check-in frequency. Establish net control.",
            effort: "Moderate",
            resources: "1 dedicated radio at elevation, agreed frequency (GMRS Ch 15), volunteer net control",
            outcome: "Whole-block awareness achieved. Everyone can hear status updates. Organized check-ins. Can coordinate resource sharing. Net control logs who needs help.",
            best_for: "Organized neighborhoods, outages >4 hours, when coordination needed"
          },
          {
            name: "COA 4: Battery-Powered Local Network",
            description: "Run Wi-Fi router from battery power. Deploy simple local web page or chat accessible to nearby devices. Announce SSID on radio.",
            effort: "Moderate-High",
            resources: "Router, battery bank (50Wh+), laptop/Pi for server, someone with basic tech skills",
            outcome: "Real-time text updates possible. Can post resource availability, needs, updates. Works alongside radio. Creates digital hub for coordination. Battery lasts 8-24 hours depending on capacity.",
            best_for: "Tech-capable households, extended outages, when text/visual coordination valuable"
          }
        ],
        decision_factors: [
          "Expected outage duration (2 hrs vs 2 days matters)",
          "Time until nightfall (darkness changes everything)",
          "Available equipment (do you actually have working radios?)",
          "Neighbor relationships (can you coordinate quickly?)",
          "Other simultaneous issues (weather, medical needs, etc.)"
        ],
        real_world_notes: [
          "A $30 handheld radio with pre-agreed channel does more than most people expect",
          "Battery-powered Wi-Fi AP can cover entire street (200-300ft radius)",
          "First 30 minutes matter most - organize FAST before chaos sets in",
          "Nightfall amplifies every problem - prioritize communication before dark",
          "Most people default to COA 1 (do nothing) and regret it around hour 3",
          "The person who takes initiative and gets on radio becomes de facto coordinator",
          "Having plan NOW means you skip to COA 3/4 immediately when outage hits"
        ],
        recommended_coa: "COA 3 for most neighborhoods (simple, effective, proven). Upgrade to COA 4 if you have equipment ready and outage extends past 6 hours."
      },
      
      water_question: {
        name: "The Water Question", 
        severity: "high",
        description: "City water pressure drops after main break. Water may be contaminated. No clear guidance from authorities yet. Stores getting crowded.",
        constraints: [
          "Uncertain water safety",
          "Grocery stores crowded, supplies limited",
          "Communication spotty",
          "Unknown restoration timeline"
        ],
        available_assets: [
          "5-gallon containers (if you have them)",
          "Camping water filter OR chlorine tablets",
          "Bathtubs and buckets",
          "Neighbor group chat (if still working)",
          "Possibly nearby natural water sources"
        ],
        objective: "Ensure 72 hours of safe drinking water for household and help neighbors",
        courses_of_action: [
          {
            name: "COA 1: Store Run",
            description: "Drive to store, buy bottled water. Standard crisis response.",
            effort: "Low-Moderate",
            resources: "Vehicle, cash/card, time to wait in line",
            outcome: "Works if you're EARLY (first 30-60 min). Fails if supply runs out or if you wait. May spend 2+ hours in line. Expensive. Doesn't scale to help neighbors.",
            best_for: "Immediate family needs only, if you hear about it very early"
          },
          {
            name: "COA 2: Fill Everything Now",
            description: "Immediately fill bathtubs, buckets, every container. Do this BEFORE water stops completely.",
            effort: "Low",
            resources: "Containers, 15-30 minutes of time",
            outcome: "Quick and effective if done IMMEDIATELY. Bathtub = 40-60 gallons. Sinks, buckets add 10-20 gallons. Enough for several days. Must treat for drinking if source questionable.",
            best_for: "First action everyone should take, buys time for other solutions"
          },
          {
            name: "COA 3: Neighborhood Pool",
            description: "Coordinate neighbors: some gather containers, some fetch bulk water, some share filters. Centralize treatment.",
            effort: "Moderate",
            resources: "Group coordination, multiple vehicles, water treatment supplies, pre-existing trust",
            outcome: "Best total resilience. Efficient use of vehicles and supplies. Those with water treatment can help those without. Creates mutual aid network. May find sources others didn't know about.",
            best_for: "Organized neighborhoods, outages >24 hours, building community resilience"
          },
          {
            name: "COA 4: Rain Capture + Treatment",
            description: "Set up improvised rain collection. Filter and treat. Sustainable for extended outage.",
            effort: "Moderate-High", 
            resources: "Tarps/gutters, collection containers, filtration, treatment chemicals",
            outcome: "Sustainable if it rains. Provides ongoing supply. Requires setup time and knowledge. Not immediate solution but extends supplies dramatically. Educational for neighbors.",
            best_for: "Extended outages (week+), rainy climate, when you have time to set up properly"
          }
        ],
        decision_factors: [
          "How soon did you hear about the problem? (First hour vs. 3 hours later changes options)",
          "Is water completely off or just low pressure?",
          "Do you have water treatment supplies already?",
          "How organized is your neighborhood?",
          "Weather forecast (rain helps COA 4)"
        ],
        real_world_notes: [
          "Most outages resolve within 48 hours - but confusion kills time",
          "First 15 minutes after announcement: fill everything. Think later.",
          "Bathtub water is NOT automatically safe to drink - treat it",
          "1 gallon per person per day is survival minimum. 3 gallons is comfortable.",
          "Water treatment: 8 drops bleach per gallon, wait 30 min. Or boil 1 minute.",
          "Hot water heater has 40-50 gallons - most people forget this",
          "Toilet tank (not bowl) has 2-3 gallons of clean water",
          "Coordination beats individual action every time"
        ],
        recommended_coa: "COA 2 immediately, then COA 3 if outage extends. Always have water treatment supplies pre-positioned."
      },
      flood: {
        name: "Flooding / Flash Flood",
        severity: "critical",
        description: "Heavy rain causing rapid water rise. Streets flooding, potential for house flooding. Water up to 2-6 feet in low-lying areas. Time-critical evacuation may be needed. Standing water can electrify from downed power lines. Current strong enough to sweep vehicles away with just 12 inches of moving water.",
        questions: [
          {
            q: "Do you have waterproof protection for ALL communication equipment?",
            tooltip: "Floodwater destroys electronics instantly. Even humidity/splashing can kill devices. Need multi-layer protection.",
            yes: "Verify protection level: Device in ziplock bag (air squeezed out), inside dry bag, elevated above potential water level. Test one bag with paper towel in water for 1 hour to confirm seal.",
            no: "CRITICAL: Water is coming. Do NOW: Heavy-duty ziplock bags for EVERY device, squeeze air out, seal tight. Then dry bag. Move everything to 2nd floor minimum. One soaked radio = total comms loss."
          },
          {
            q: "Are all nodes and equipment elevated above potential flood level?",
            tooltip: "Water rises faster than expected. Ground floor can flood in minutes. First floor in 15-30 minutes during flash flood.",
            yes: "Good. But verify: Is equipment at least 6 feet above current ground level? Flash floods can rise 5-8 feet. If any doubt, move higher NOW. Check battery banks, chargers, nodes - everything.",
            no: "URGENT: Move ALL equipment to 2nd floor or highest point in home immediately. Water can rise 6+ feet in flash flood. Ground-level nodes will be destroyed. Takes 5 minutes to move - do it NOW before water arrives."
          },
          {
            q: "Have you identified your evacuation route and is it still passable?",
            tooltip: "6 inches of moving water can knock you down. 12 inches can float a car. 2 feet WILL sweep vehicle away. Road that was clear 10 minutes ago may now be impassable.",
            yes: "Recheck NOW. Water situation changes in minutes. If water is over curbs or moving fast, that route is likely lost. Identify alternate routes on higher ground. Share route info via mesh.",
            no: "WARNING: You need evacuation plan RIGHT NOW. Identify: Highest ground route out of area, alternate if primary blocked, rally point on high ground. Drive slowly near water - hidden holes can swallow cars. Turn around, don't drown."
          },
          {
            q: "Can you maintain communications if you must evacuate to vehicle or emergency shelter?",
            tooltip: "Home nodes will be abandoned/destroyed. Mobile communications critical during evacuation. Handheld radios and battery banks must come with you.",
            yes: "Pack NOW for evacuation: Handheld radios (GMRS + Meshtastic), fully charged battery banks (minimum 20,000mAh), USB cables, one phone. Keep dry. Practice operating radio from vehicle.",
            no: "MAJOR GAP: Once you leave home, your fixed nodes are gone. Must have: Handheld GMRS radio, portable Meshtastic node, charged battery banks, waterproof bags. Pack these in go-bag NOW - may need to leave in 15 minutes."
          },
          {
            q: "Have you checked on neighbors in basements or lower areas?",
            tooltip: "People in basements can be trapped as water rises. Lower floors flood first. Elderly/disabled may not realize danger in time.",
            yes: "Continue monitoring. Water rises fast. If water is entering homes, begin evacuation assistance immediately. Coordinate via radio - don't let anyone isolate.",
            no: "CRITICAL: Do neighborhood welfare check NOW. Door-to-door if safe: Who's in basement? Who's on ground floor? Who needs help evacuating? Broadcast on mesh: 'All residents report floor level and ability to evacuate'. Time sensitive."
          },
          {
            q: "Do you know where the high ground rally points are?",
            tooltip: "Pre-identified high ground locations for regrouping if neighborhood floods. Parking garage upper levels, schools on hills, churches on high ground.",
            yes: "Share GPS coordinates via mesh NOW. Rally Point Alpha (primary), Rally Point Bravo (backup). Everyone needs to know these. Test that mesh still reaches rally points from your location.",
            no: "URGENT: Establish rally points immediately. Find: Elevated parking structure, school/church on high ground, friend's house on hill. Get GPS coordinates. Broadcast to all neighbors. This is where you regroup if forced to evacuate."
          }
        ],
        timeline: [
          { time: "Alert / Water Rising", action: "IMMEDIATE ACTION: Move all electronics to 2nd floor or highest point. Waterproof critical devices in multiple layers. Enable GPS on all nodes. Broadcast flood alert on mesh and GMRS Ch 15." },
          { time: "+10 minutes", action: "ACCOUNTABILITY: Quick door-to-door or radio check: Who's in basements/ground floor? Who needs help? Who has vehicles? Coordinate evacuation rides. Move vulnerable people to upper floors or prepare to leave." },
          { time: "+20 minutes", action: "DECISION POINT: If water over curbs or approaching houses, initiate evacuation. No more waiting. Grab: Go-bags, radios, battery banks, pets, medications. Water rises FAST - 15 more minutes could trap you." },
          { time: "+30 minutes (If Evacuating)", action: "CONVOY FORMATION: Everyone with vehicle on GMRS Ch 15. Lead vehicle navigates to high ground via highest route. SLOW speed near water. Turn around if road flooded - never drive through moving water." },
          { time: "+45 minutes", action: "MOBILITY CHECK: If water on roads, test depth before driving. 6 inches looks harmless but hides dangers. If water moving fast, DO NOT cross. Find alternate route. Broadcast road conditions to others." },
          { time: "+1-2 hours", action: "RALLY POINT: Everyone checks in at high ground location. Account for all households. If anyone missing, contact authorities - do NOT return to search. Set up coordination center with mesh/GMRS." },
          { time: "+3-6 hours", action: "SUSTAINED OPERATIONS: Monitor water levels via authorities/news if available. Twice-daily radio check-ins. Coordinate: Who needs shelter, who has vehicles, resource sharing. No one returns until official all-clear." },
          { time: "+12-24 hours", action: "DAMAGE ASSESSMENT: When safe, visual assessment only - do NOT enter water-damaged homes yet. Electrical hazards, structural damage, contamination. Take photos for insurance. Coordinate cleanup once cleared by authorities." }
        ],
        recommendations: [
          "IMMEDIATE ACTIONS (Water is rising NOW):",
          "  • Move ALL electronics to 2nd floor or highest point - do this first, takes 5 minutes",
          "  • Waterproof critical devices: Radio + battery bank in ziplock, squeeze air out, seal, into dry bag",
          "  • Enable GPS on all Meshtastic devices if not already enabled",
          "  • Fill bathtubs and large containers with clean water before contamination",
          "  • Broadcast flood warning: 'FLOOD WARNING - All residents report location and status'",
          "",
          "EVACUATION DECISION:",
          "  • Water over curbs = LEAVE NOW. Don't wait for official order",
          "  • Water approaching house foundation = IMMEDIATE evacuation",
          "  • Water in basement = Time to go, will reach ground floor in 15-30 minutes",
          "  • Fast-moving water anywhere = CRITICAL - flash flood, extremely dangerous",
          "  • If unsure, err on side of caution - stuff is replaceable, you are not",
          "",
          "EVACUATION PROTOCOL:",
          "  • Grab go-bag: Radios, battery banks, phones, meds, documents, chargers, water, N95 masks",
          "  • Take pets in carriers - do NOT leave them behind",
          "  • Everyone on GMRS Ch 15 for voice coordination",
          "  • Drive SLOWLY near any water - hidden holes, debris, manhole covers lifted by pressure",
          "  • 6 inches of moving water = Can knock you down if you step in it",
          "  • 12 inches of moving water = Can float and move your car",
          "  • 2 feet of moving water = WILL sweep vehicle away - guaranteed",
          "  • If water over road, TURN AROUND DON'T DROWN - find alternate route",
          "",
          "COMMUNICATION PRIORITIES:",
          "  • Handheld GMRS radio for voice coordination during evacuation",
          "  • Portable Meshtastic node for position tracking and text updates",
          "  • All devices waterproofed - one drop can kill them",
          "  • Battery banks minimum 20,000mAh for extended operations",
          "  • Rally point GPS shared with all households: 'Rally Alpha: [coords] - Library parking garage'",
          "",
          "WATER SAFETY:",
          "  • NEVER walk through moving water - current stronger than it looks",
          "  • NEVER drive through flooded roads - hidden hazards everywhere",
          "  • Standing water may be electrified from downed power lines - stay back 50+ feet",
          "  • Floodwater is contaminated with sewage, chemicals, debris - avoid contact",
          "  • If you must wade, use stick to check depth ahead, shuffle feet, face upstream",
          "",
          "ACCOUNTABILITY:",
          "  • Radio check-in format: 'Household name - Location - Status - Needs'",
          "  • Document who's in each vehicle for convoy",
          "  • Identify who needs help: Elderly, disabled, no transportation, medical needs",
          "  • Buddy system: Each household pairs with neighbor - account for each other",
          "  • If someone refuses to evacuate: Note their location, inform authorities, don't force",
          "",
          "POST-FLOOD (After water recedes):",
          "  • DO NOT enter water-damaged buildings until cleared by authorities",
          "  • Electrical hazards: Water conducts electricity, may be energized",
          "  • Structural damage: Foundations weakened, floors compromised, walls unstable",
          "  • Contamination: Everything touched by floodwater is contaminated with sewage/chemicals",
          "  • Document damage: Photos/video for insurance before cleanup",
          "  • Professional assessment required before occupying water-damaged structures",
          "",
          "CRITICAL REMINDERS:",
          "  • Water rises MUCH faster than you think - minutes not hours in flash flood",
          "  • More people die in vehicles trying to drive through water than in homes",
          "  • Turn Around Don't Drown - most flood deaths are preventable",
          "  • 6 inches of moving water can sweep you off feet - respect the power of water",
          "  • Your electronics are trash if they get wet - waterproof NOW not after",
          "  • High ground is safety - get there early, stay there until official all-clear"
        ]
      },
      civil_unrest: {
        name: "Civil Unrest / Security Situation",
        severity: "high",
        description: "Localized civil unrest within 5 miles. Protests, property damage, or security concerns. Police presence may be minimal or overwhelmed. Cell networks possibly overloaded or disrupted. Stores closing. Need for enhanced situational awareness and coordination without appearing threatening.",
        questions: [
          {
            q: "Can you operate communications discreetly without drawing attention?",
            tooltip: "Visible antennas, handheld radios in public, or obvious coordination can make you a target for theft or worse. Low profile essential.",
            yes: "Good. Continue discreet ops: Indoor antennas only, handheld radios used inside vehicles or homes, no obvious equipment displays. Mesh text better than voice radio in this scenario.",
            no: "CRITICAL: Switch to discreet mode NOW. Take down external antennas. Use indoor antennas. Handheld radios stay hidden. Meshtastic text only - voice radio draws attention. Operate from inside, not outside."
          },
          {
            q: "Do you have eyes-on situational awareness of your immediate area?",
            tooltip: "Knowing what's happening in real-time within 1-2 blocks is critical. Where are crowds moving? What direction is trouble coming from? Are there fires, blocked roads, dangerous areas?",
            yes: "Maintain continuous watch. Rotate observers to prevent fatigue. Share updates via mesh: 'Cross street at Main - large group moving north'. Time-stamp everything. Map the situation.",
            no: "ESTABLISH NOW: Designate observers at vantage points (upper floors, corners). Every household reports what they see. Create mental map of situation: Where's the activity? What direction moving? Any specific threats? Update every 15 minutes."
          },
          {
            q: "Have you established buddy system and mutual aid agreements?",
            tooltip: "In security situations, nobody goes anywhere alone. Every household pairs with neighbor. Check-ins every 30-60 minutes. If someone misses check-in, immediate welfare check.",
            yes: "Verify system working: Who's your buddy? When's next check-in? What's the emergency code word? Test it now - everyone calls their buddy, confirms system operational.",
            no: "URGENT: Set up NOW. Each household pairs with immediate neighbor. Check-in schedule: Every hour on the hour via mesh text. If someone misses check-in, their buddy investigates. Code phrase: 'Everything is fine' = actually fine. 'All good here' = need help."
          },
          {
            q: "Do you have 72+ hours of supplies to stay put without leaving home?",
            tooltip: "Going out during unrest is risk. Every trip to store or work is exposure to danger. Best strategy is stay home until situation stabilizes.",
            yes: "Excellent. Stay inside. Lock doors. Keep lights low at night (don't advertise you're home). Radio check-ins only. Someone comes to door unexpectedly? Don't answer - verify via mesh with neighbors first.",
            no: "ASSESS: What do you NEED vs WANT? Water, food, medications = need. Everything else can wait. If you must go out: Daytime only, buddy system, GMRS radio, planned route, time limit. Mesh text when leaving/arriving."
          },
          {
            q: "Can you identify safe routes and no-go zones in your area?",
            tooltip: "Some streets become dangerous quickly. Knowing alternate routes and places to avoid is critical for safety if you must move.",
            yes: "Keep updating: Situations change rapidly. What was safe 2 hours ago may not be now. Share intel via mesh: 'Avoid Main St between 3rd and 5th - crowd activity'. Create safe route map.",
            no: "START MAPPING: Establish what you know now. Which streets are seeing activity? Where are police? Where are fires or damage? Broadcast: 'Share any dangerous areas you're aware of'. Build collective knowledge."
          }
        ],
        timeline: [
          { time: "Situation Develops", action: "AWARENESS: Activate mesh network discreetly. Indoor antennas only. Minimize external indicators. All households check in via mesh. Establish observation posts at upper floor windows. Begin situational awareness log." },
          { time: "+30 minutes", action: "COORDINATION: Designate Net Control for information hub. Every household reports what they can see/hear. Create neighborhood situation map: Where's activity, which direction moving, any specific threats. Share via mesh." },
          { time: "+1 hour", action: "SECURITY POSTURE: Lock doors/windows. Lower blinds but maintain observation capability. Lights low especially at night. Buddy system active - hourly check-ins. Vehicle fuel tanks full if possible. Go-bags staged near exit." },
          { time: "+2 hours", action: "PATTERN ANALYSIS: Is situation improving or worsening? Getting closer or moving away? Coordinate: Safe routes if anyone must leave, no-go zones identified, alternate rally points if evacuation needed." },
          { time: "+4-6 hours", action: "SUSTAINED POSTURE: Establish routine. Regular check-ins every 2 hours. Rotate observers to prevent fatigue. Share meals, coordinate supply needs. Monitor official channels if available. Maintain low profile." },
          { time: "+12 hours", action: "REASSESS: If situation stable, maintain current posture. If escalating, discuss evacuation scenarios. If improving, cautiously resume limited activities. Continue communication but reduce frequency to conserve power." },
          { time: "+24 hours", action: "ADAPTATION: Situation still active? Plan for 72+ hours staying put. Establish twice-daily check-ins. Coordinate supply sharing quietly. Continue observation and intel sharing. Security watch if needed." },
          { time: "Resolution", action: "GRADUAL RETURN: Even when situation calms, maintain heightened awareness for 24-48 hours. Continue check-ins. Share observations of damage, safe areas, open stores. Document anything relevant for authorities." }
        ],
        recommendations: [
          "IMMEDIATE POSTURE (When situation develops):",
          "  • Bring everyone HOME immediately if safe to do so",
          "  • Lock all doors and windows - sounds obvious but do it NOW",
          "  • Lower blinds/curtains but maintain observation capability from upper floors",
          "  • Switch to DISCREET communications: Indoor antennas only, no visible radios outside",
          "  • Mesh text preferred over voice radio (quieter, less obvious)",
          "  • Full family accountability - everyone checks in, no exceptions",
          "",
          "COMMUNICATION PROTOCOLS:",
          "  • Meshtastic mesh is PRIMARY (text-based, discreet, no voice signature)",
          "  • GMRS voice radio is BACKUP for emergencies only (voice carries and draws attention)",
          "  • Message format: 'Location - Situation - Time' example: 'Main & 3rd - Large group moving north - 14:30'",
          "  • No names over radio - use callsigns or house numbers",
          "  • Assume communications could be monitored - nothing sensitive",
          "  • Regular check-ins: Hourly first 6 hours, then every 2-3 hours",
          "",
          "SITUATIONAL AWARENESS:",
          "  • Designate observers at windows (rotate every 2 hours to prevent fatigue)",
          "  • Report: Group sizes, direction of movement, any property damage, fires, police presence",
          "  • Share immediately: 'Crowd 50+ people heading east on Oak St' = neighbors can prepare",
          "  • Create collective map: Net Control maintains running log of reported activity",
          "  • Update regular: Situations change fast - what was safe 1 hour ago may not be now",
          "",
          "SECURITY MEASURES:",
          "  • Low profile: Don't advertise that you're home or have supplies",
          "  • Lights minimal especially at night (use candles/flashlights in interior rooms)",
          "  • Vehicles in garage if possible, doors locked, keys accessible for quick departure",
          "  • Go-bags staged near primary and alternate exits",
          "  • Know your neighbors on sight - verify identity before opening door",
          "  • Unexpected door knock? DON'T answer - verify via mesh first: 'Anyone at the Jones house?'",
          "",
          "BUDDY SYSTEM:",
          "  • Every household pairs with immediate neighbor",
          "  • Check-in schedule: Every hour on the hour first 6 hours, then every 2 hours",
          "  • Format: 'Smith household - All secure - Next check 16:00'",
          "  • Missed check-in = Buddy investigates immediately via mesh, then carefully in person",
          "  • Code phrases: 'All clear' = fine, 'All secure' = fine, 'All quiet' = fine",
          "  • Emergency phrase: 'Could use company' = need help NOW but can't say it directly",
          "",
          "IF YOU MUST GO OUT:",
          "  • Daytime ONLY - night movement draws attention and is dangerous",
          "  • Buddy system - NEVER alone. Minimum 2 people, both with radios",
          "  • Planned route shared via mesh before leaving: 'Smith household departing to grocery on Main St via Oak, return 30 min'",
          "  • GMRS radio on, listening to Ch 15. Mesh device in pocket with GPS enabled",
          "  • Low profile: No visible valuables, no expensive vehicles if avoidable, regular clothes",
          "  • Time limit: Set expected return time. If you're late, buddy raises alarm",
          "  • Check-in en route: Brief position updates 'At grocery now' 'Heading home'",
          "",
          "NO-GO ZONES:",
          "  • Document and share: 'Main St between 3rd and 5th - large crowd, property damage - avoid'",
          "  • Update frequently: Safe areas can become dangerous quickly",
          "  • Alternate routes: Know 2-3 ways to get anywhere important",
          "  • If you encounter trouble: Don't confront, retreat, report via mesh",
          "  • Dead ends are dangerous - always have exit strategy",
          "",
          "SUPPLY MANAGEMENT:",
          "  • Assess what you have: 72 hours of food/water minimum?",
          "  • Share quietly if neighbors in need (but don't advertise that you have supplies)",
          "  • Medications critical: If someone needs pharmacy run, coordinate carefully",
          "  • Fuel vehicles now if safe - may need quick departure capability",
          "  • Cash on hand in case ATMs/cards don't work",
          "",
          "EVACUATION SCENARIO:",
          "  • Rally points: Pre-designated safe locations outside affected area",
          "  • Trigger: Fires approaching, direct threats, police evacuation order",
          "  • Convoy movement: Everyone together, maintain radio contact",
          "  • Account for all households: Nobody left behind",
          "  • Communication plan: How to reestablish contact if separated",
          "",
          "WHAT NOT TO DO:",
          "  • DON'T go out to observe or take photos - this isn't tourism, it's dangerous",
          "  • DON'T confront anyone or engage - not your job, not worth the risk",
          "  • DON'T be a hero - your job is keep your household safe, period",
          "  • DON'T share on social media - can reveal your location and capabilities",
          "  • DON'T use obvious external antennas or visible radio equipment",
          "  • DON'T have obvious political signs or anything that might make you a target",
          "",
          "REMEMBER:",
          "  • This situation is temporary - staying safe is the only goal",
          "  • Low profile and discreet operations keep you off radar",
          "  • Your communications network is for coordination, not confrontation",
          "  • Buddy system and hourly check-ins ensure nobody is isolated",
          "  • 72 hours of supplies means you don't have to risk going out",
          "  • When in doubt, stay put - movement is exposure to risk"
        ]
      },
      hiking: {
        name: "Hiking / Backcountry Operations",
        severity: "moderate",
        description: "Extended hiking, camping, or backcountry activity 5-20+ miles from civilization. No cell service. Need for emergency communications, coordination, and rescue capability if someone gets hurt or lost. Weather can change rapidly. Terrain may limit radio range.",
        questions: [
          {
            q: "Do all hiking group members have functioning communication devices?",
            tooltip: "If someone gets separated or injured, they need ability to call for help. Every person should have radio capability, not just group leader.",
            yes: "Verify: Turn on every device, test transmission, check battery level NOW. Don't assume it works - test before leaving trailhead. Fresh batteries in all devices. Know how to use them.",
            no: "CRITICAL: Every person needs radio. Minimum: GMRS handheld for each person. Better: Each person also has Meshtastic node. If you don't have enough, reduce group size or rent/borrow equipment. One person without radio = potential tragedy."
          },
          {
            q: "Have you shared your route plan and expected return time with someone outside the group?",
            tooltip: "If entire group has accident or gets lost, nobody knows where to look unless someone outside knows your plan. This is basic safety.",
            yes: "Verify they have: Exact trailhead, route map, expected waypoints with times, return deadline, emergency contacts. If you're not back by deadline + 2 hours, they call SAR.",
            no: "DO NOW before leaving: Text/email someone reliable (NOT in hiking group) with: Trailhead location, planned route, waypoints, return time, vehicle description/plate. Set check-in time. If no word by then, they alert authorities."
          },
          {
            q: "Do you have GPS-enabled position sharing working on at least one device?",
            tooltip: "In emergency, knowing exact position is critical. GPS coordinates allow helicopter rescue or guide ground teams. Without it, 'somewhere on the trail' wastes hours or days.",
            yes: "Test it NOW: Verify GPS lock, confirm coordinates are being transmitted/saved. Share position via mesh now so you know system works. Screenshot map on phone as backup.",
            no: "CONFIGURE NOW: Meshtastic position sharing must be ON. Settings > Position > GPS Enabled, Broadcast Position every 15 minutes. Test that other nodes receive your position. Phone GPS as backup."
          },
          {
            q: "Do you have sufficient battery capacity for entire trip duration plus emergency reserve?",
            tooltip: "Trip planned for 8 hours? Bring 16 hours of battery. Things always take longer. Getting lost adds hours. Cold weather drains batteries faster.",
            yes: "Calculate: Device power draw × hours × 2 (safety margin). Cold weather? ×3. Keep spare batteries warm (inside jacket). Test one device for 4 hours to verify actual runtime matches your plan.",
            no: "RECALCULATE: You need 2x trip duration minimum. Meshtastic ~10-12 hours on internal battery. GMRS radio ~12-16 hours. Bring battery banks: 10,000mAh = ~20 hours Meshtastic, or solar panel if multi-day."
          },
          {
            q: "Have you tested radio range and mesh connectivity from typical terrain you'll encounter?",
            tooltip: "Line-of-sight vs. forest vs. canyon vs. mountain - completely different ranges. What works at home may not work on trail.",
            yes: "Know the limitations: Open terrain = 5-10km, forest = 1-3km, canyons/valleys = could be 100m or zero. Plan for worst case. Buddy system: stay within confirmed working range.",
            no: "WARNING: Don't assume range. Forest absorbs signal. Canyons block it. Mountains give great range but only if you're both on ridges. Maintain visual contact or at least within ~1km (0.6 miles) in forest."
          }
        ],
        timeline: [
          { time: "Pre-departure (Trailhead)", action: "GEAR CHECK: Every person turns on radio, tests transmission, verifies GPS working. Share route plan outside group. Fresh batteries or full charge. Emergency contact plan reviewed. Buddy assignments made." },
          { time: "Start of Hike", action: "INITIAL COMMS CHECK: Everyone tests radio at trailhead. Establish check-in schedule (every 30-60 min). Share initial GPS position via mesh. Set GMRS frequency (Ch 15 or designated). Last cell service = send 'starting hike' text." },
          { time: "Every 30-60 minutes", action: "POSITION CHECK-IN: 'Callsign - Made it to waypoint 2 - All good' on radio. Test mesh position updates. Visual count: everyone still with group? Any issues developing? Adjust pace for slowest member." },
          { time: "If Separation Occurs", action: "IMMEDIATE: Stop. Radio call: 'Group halt, John is not here'. Last known position? How long ago? Radio range test. If no response in 2 minutes, establish search pattern. Coordinate via radio. One person stays at last known position as reference." },
          { time: "If Injury Occurs", action: "ASSESS: Life-threatening? Call for help immediately on GMRS Ch 15 + send mesh message with GPS position. Non-critical? Treat, then decide if continue or evacuate. Someone radio ahead to base camp or trailhead if possible." },
          { time: "If Lost/Disoriented", action: "STOP MOVING. Preserve energy and battery. Radio out: 'Need assistance, unclear of position'. Share GPS coordinates if device working. Try to reach high ground for better radio propagation. Stay put if anyone is coming to help." },
          { time: "Emergency Activation", action: "SIGNAL FOR HELP: GMRS Ch 15: 'MAYDAY MAYDAY MAYDAY - Injury/Lost - GPS coordinates - Need SAR'. Repeat every 5 minutes. Mesh broadcast same info. Preserve battery: set radio to lowest power that works, turn off GPS if battery critical." },
          { time: "End of Hike (Return)", action: "FINAL CHECK-IN: All members accounted for. Text/call outside contact: 'Trip complete, all safe'. Review what worked, what didn't. Note any dead zones for future reference." }
        ],
        recommendations: [
          "PRE-HIKE EQUIPMENT CHECK:",
          "  • Every person needs GMRS handheld radio minimum (simplex, no repeater needed)",
          "  • Better: Each person also has Meshtastic node (mesh works without infrastructure)",
          "  • Test EVERYTHING before leaving trailhead - turn on, verify works, check battery",
          "  • Spare batteries (lithium work better in cold) or battery bank 10,000+ mAh",
          "  • Backup: Whistle (3 blasts = distress), mirror (signal aircraft), bright clothing",
          "  • GPS device or phone with offline maps downloaded",
          "",
          "COMMUNICATION PLAN:",
          "  • Primary: GMRS voice radio on Ch 15 (or designated channel for group)",
          "  • Secondary: Meshtastic mesh text with position broadcast every 15 minutes",
          "  • Emergency: Any channel - try all if no response on primary",
          "  • Check-in schedule: Every 30 min easy terrain, every 15 min difficult terrain",
          "  • Format: 'Callsign - Position/waypoint - Status - Time'",
          "  • Buddy pairs: Each person assigned a buddy, responsible for each other",
          "",
          "ROUTE PLANNING:",
          "  • Share plan with someone outside group BEFORE departing (text/email is fine)",
          "  • Include: Trailhead, route, waypoints, expected return time, vehicle info, emergency contacts",
          "  • Check-in time: If you don't contact them by X time, they call SAR",
          "  • Conservative estimates: Add 50% to expected time (8 hour hike = plan for 12)",
          "  • Weather window: Don't start hike if weather turning bad",
          "",
          "BATTERY MANAGEMENT:",
          "  • Calculate needs: Device power × trip hours × 2 (safety margin)",
          "  • Cold weather reduces capacity 30-40% - bring extra",
          "  • Keep spare batteries WARM (inside jacket, not in pack)",
          "  • Test runtime before trip: Run device for 4 hours, measure actual drain",
          "  • Power saving: Reduce mesh broadcast frequency to 30min, lower radio to minimum power that works",
          "  • Emergency: If battery critical, turn off GPS, reduce to brief check-ins only",
          "",
          "TERRAIN & RANGE CONSIDERATIONS:",
          "  • Open terrain / ridgeline: 5-10km range typical",
          "  • Forest: 1-3km range (trees absorb signal)",
          "  • Dense forest / vegetation: 500m-1km range",
          "  • Canyons / valleys: Potentially ZERO range (walls block signal)",
          "  • Mountains: Great range on ridges, terrible in valleys",
          "  • Solution: Maintain tighter spacing in difficult terrain, use relay stations",
          "",
          "BUDDY SYSTEM:",
          "  • Assign pairs: Each person responsible for their buddy",
          "  • Visual contact or radio contact every 5-10 minutes in difficult terrain",
          "  • If buddy missing: STOP immediately, last known position, radio call, coordinate search",
          "  • Never separate more than confirmed radio range",
          "  • Stronger hikers paired with less experienced (helps pace, safety)",
          "",
          "IF SOMEONE GETS SEPARATED:",
          "  • STOP immediately when noticed (don't continue and make it worse)",
          "  • Radio call: 'All stop, [name] is missing'",
          "  • Last known position? How long ago? Retrace to that point",
          "  • Radio range test: Call repeatedly on primary freq",
          "  • One person stays at last known position as reference point",
          "  • If no radio contact in 5 minutes, activate search pattern",
          "  • If no contact in 15 minutes, someone goes for help with GPS coordinates",
          "",
          "IF INJURY OCCURS:",
          "  • Assess severity: Life-threatening (bleeding, unconscious, broken bones, chest pain) = immediate help",
          "  • Radio: 'Medical emergency at GPS [coordinates] - [nature of injury] - Need SAR'",
          "  • Send runner to trailhead if possible and radio coverage poor",
          "  • Mesh broadcast same info - it may propagate to relay nodes",
          "  • First aid while waiting: Stop bleeding, treat shock, keep warm, don't move if spine injury suspected",
          "  • Minor injury: Treat, evaluate if person can continue or needs evacuation",
          "",
          "IF LOST OR DISORIENTED:",
          "  • STOP MOVING - wandering makes it worse and drains battery",
          "  • Radio call: 'Need assistance, unclear of position' on primary freq",
          "  • Try other freqs: Ch 1, Ch 15, FRS channels - someone might hear",
          "  • GPS coordinates: Read them over radio if device working",
          "  • High ground: If safe to do so, move to elevation for better radio propagation",
          "  • Preserve battery: Reduce transmit frequency to every 5-10 minutes",
          "  • Stay calm: Most 'lost' people are found within 24 hours if they stay put",
          "",
          "EMERGENCY CALL FORMAT:",
          "  • MAYDAY MAYDAY MAYDAY (international distress call)",
          "  • Location: GPS coordinates + description ('north side of Mt Wilson')",
          "  • Situation: Injury / Lost / Equipment failure / Weather",
          "  • Number of people: 'Party of 5, one injured'",
          "  • Needs: 'Need SAR / Need medical evac'",
          "  • Radio info: 'Monitoring Ch 15, limited battery'",
          "",
          "COLD WEATHER CONSIDERATIONS:",
          "  • Batteries die FAST in cold - keep devices inside jacket",
          "  • Charge devices to 100% before leaving heated environment",
          "  • Lithium batteries perform better in cold than alkaline",
          "  • Hands too cold to operate device? Practice with gloves BEFORE trip",
          "  • Emergency: Body heat can warm battery enough for one more transmission",
          "",
          "MULTI-DAY TRIPS:",
          "  • Solar panel 10-20W for device charging (pack size)",
          "  • Charge during day while hiking, use at night",
          "  • Battery bank 20,000+ mAh (weather can prevent solar charging for days)",
          "  • Base camp relay: Leave one always-on node at base camp on high ground",
          "  • Nightly check-in: Schedule time to contact outside world if possible",
          "",
          "WHAT TO PACK:",
          "  • GMRS handheld radio (one per person) + spare batteries",
          "  • Meshtastic node (one per person or at least 2 per group) + battery banks",
          "  • GPS device or phone with offline maps",
          "  • First aid kit (actual medical supplies, not just band-aids)",
          "  • Emergency shelter (space blanket minimum, bivy better)",
          "  • Fire starting (waterproof matches + lighter + ferro rod)",
          "  • Water filter/purification",
          "  • Emergency food (bars, trail mix - 24hr extra)",
          "  • Headlamp with fresh batteries",
          "  • Whistle + mirror for signaling",
          "",
          "REMEMBER:",
          "  • Every person needs radio capability - no exceptions",
          "  • Test everything at trailhead before leaving cell service area",
          "  • Check-ins every 30-60 min keep everyone accountable",
          "  • GPS position + outside contact = how rescuers find you if needed",
          "  • Stay together or within confirmed radio range - no wandering off",
          "  • If emergency: STOP, radio for help, preserve battery, stay put if possible",
          "  • Most backcountry emergencies are preventable with proper planning and communication"
        ]
      }
    };
    
    const terrainTypes = {
      suburban: { 
        multiplier: 1.0, 
        description: "Typical houses, light tree cover"
      },
      urban: { 
        multiplier: 0.6, 
        description: "Dense buildings, RF obstruction"
      },
      rural: { 
        multiplier: 1.5, 
        description: "Open terrain, minimal obstructions"
      },
      hilly: { 
        multiplier: 0.7, 
        description: "Rolling hills, variable LOS"
      },
      forest: {
        multiplier: 0.5,
        description: "Dense trees, heavy attenuation"
      }
    };
    
    const equipmentDB = {
      nodes: [
        { name: "Heltec V3", price: 35, range: "2-5km", battery: "18-24hr", gps: false },
        { name: "Seeed T1000-E", price: 55, range: "2-4km", battery: "24-36hr", gps: true },
        { name: "RAK WisBlock", price: 80, range: "3-8km", battery: "36+hr", gps: true },
        { name: "LilyGO T-Beam", price: 45, range: "2-6km", battery: "24-30hr", gps: true }
      ],
      radios: [
        { name: "Baofeng GM-15 Pro", price: 30, power: "5W HT" },
        { name: "Wouxun KG-UV9G Pro", price: 140, power: "5W HT + Repeater" },
        { name: "Midland MXT575", price: 180, power: "50W Mobile" }
      ]
    };
    
    const cards = {
      gmrs: {
        title: 'GMRS QUICK REFERENCE',
        content: `LICENSE: $35, 10 years, no test, family coverage
RANGE: 2-5 miles typical, 20+ with repeater
POWER: Max 50W mobile, 5W handheld

RECOMMENDED CHANNELS:
├─ Ch 15 (462.550) - Simplex primary
├─ Ch 16 (462.575) - Simplex backup  
├─ Ch 20 (462.675) - Backup/secondary
└─ Ch 19 (462.650) - Long-range simplex

REPEATER CHANNELS: 15-22 (with offset)

EMERGENCY PROTOCOL:
1. Monitor Ch 15 during emergencies
2. Keep transmissions brief
3. Use plain language
4. Identify with callsign

LEGAL GMRS RADIOS (Part 95E Certified):
Budget: Baofeng GM-15 Pro (~$30)
Mid-range: Wouxun KG-UV9G Pro (~$140)
Mobile: Midland MXT575 (~$180)

IMPORTANT: Must be FCC Part 95E certified.
Ham radios (UV-5R etc) are NOT legal for
transmitting on GMRS (owning is fine, but
transmission requires Part 95E cert).

FCC Part 95 Compliant Required`
      },
      meshtastic: {
        title: 'MESHTASTIC QUICK SETUP',
        content: `NO LICENSE REQUIRED
Range: 2-10km typical, more with elevation

QUICK START:
1. Download app (iOS/Android)
2. Plug in device via USB
3. Connect via Bluetooth
4. Set your callsign/name
5. Enable encryption (PSK)

RECOMMENDED SETTINGS:
├─ Region: US (or your region)
├─ Power: Long Fast (default)
├─ Hop Limit: 3
└─ Encryption: ON (PSK shared)

BEST BUDGET: Heltec V3 (~$35)
BEST PORTABLE: Seeed T1000-E (~$50)
SOLAR SETUP: RAK WisBlock + 10W panel

TROUBLESHOOTING:
- No messages? Check region setting
- Short range? Increase antenna height
- Battery drain? Reduce power to Medium

Mesh works better with MORE nodes`
      },
      frequencies: {
        title: 'EMERGENCY FREQUENCY GUIDE',
        content: `UNLICENSED:
FRS: 462-467 MHz (0.5W max)
MURS: 151-154 MHz (2W max, 5 ch)
CB: 27 MHz (4W AM, SSB allowed)

GMRS (LICENSE - $35):
462-467 MHz (50W mobile, 5W HT)
Channels 15-22: Repeater capable

HAM (LICENSE - TEST):
2m: 144-148 MHz (local VHF)
70cm: 420-450 MHz (local UHF)
40m: 7.0-7.3 MHz (regional HF)
20m: 14.0-14.35 MHz (DX HF)

EMERGENCY SIMPLEX:
├─ 2m: 146.52 MHz (National)
├─ 70cm: 446.0 MHz (National)  
├─ GMRS: Ch 15 (462.550)
└─ FRS: Ch 1 (462.5625)

LISTEN FIRST - Don't transmit until licensed
EMERGENCY: Use any frequency if life-threatening`
      },
      emergency: {
        title: 'NEIGHBORHOOD EMERGENCY PROTOCOL',
        content: `WHEN CELL TOWERS FAIL:

IMMEDIATE ACTIONS:
□ Turn on all Meshtastic nodes
□ Test mesh with "ping" message
□ Tune GMRS to Ch 15 (462.550)
□ Establish check-in times

POWER PRIORITIES:
1st: One mesh relay node (solar)
2nd: GMRS handheld radios
3rd: Additional mesh nodes

COMMUNICATION SCHEDULE:
├─ 08:00: Morning check-in (all)
├─ 12:00: Midday (emergencies)
├─ 20:00: Evening check-in (all)
└─ Emergency: Break in anytime

MESSAGE PRIORITY:
1. Life-threatening emergency
2. Medical need
3. Safety/security issue  
4. Resource request
5. Status update

KEEP TRANSMISSIONS BRIEF
Use plain language
Identify yourself
Listen before transmitting

chaoskoalas.com | Print & Laminate`
      },
      atak: {
        title: 'ATAK QUICK START GUIDE',
        content: `ANDROID TEAM AWARENESS KIT

SETUP:
1. Download ATAK from tak.gov or the Play Store
2. Get the DataSync, GRG Builder, and VNS plugins
3. Install on Android device
4. Configure server (if available)
5. Import map packages
6. Set callsign and role

MESHTASTIC PLUGIN:
├─ Install from github
├─ Connect device via Bluetooth
├─ Enable position sharing
└─ Set update interval

BASIC OPERATIONS:
- Drop marker: Long press map
- Send message: Chat icon
- Share location: Auto or manual
- Create route: Tools > Route
- Measure distance: Tools > Measure

PRIVACY:
□ Disable GPS broadcast if needed
□ Use secure mesh encryption
□ Turn off when not in use
□ Don't broadcast home location

OFFLINE MAPS:
Download map packages before emergency
Store on device, not SD card`
      },
      battery: {
        title: 'BATTERY MANAGEMENT GUIDE',
        content: `RUNTIME CALCULATIONS:

Meshtastic Node Power Draw:
├─ Long Fast: ~80-100mA avg
├─ Medium Fast: ~50-70mA avg
└─ Short Slow: ~30-50mA avg

Battery Bank Runtime:
10,000mAh = 18-24 hours (Long Fast)
20,000mAh = 36-48 hours (Long Fast)
Solar 10W = Indefinite (sunny)

CHARGING PRIORITIES:
1. One always-on relay node
2. GMRS handheld radios
3. Portable mesh nodes
4. Mobile devices
5. Additional nodes

COLD WEATHER:
- Battery capacity drops 20-40%
- Keep batteries warm (inside)
- Use hand warmers if needed
- Charge more frequently

SOLAR SETUP:
10W panel + 10,000mAh battery
= 24/7 operation in most conditions

POWER SAVING:
□ Reduce transmission power
□ Increase hop limit
□ Disable GPS when not needed
□ Use longer beacon intervals`
      },
      antenna: {
        title: 'ANTENNA IMPROVEMENT GUIDE',
        content: `RANGE IMPROVEMENTS:

HEIGHT IS MIGHT:
+3m elevation = ~30% more range
Rooftop > attic > ground floor

ANTENNA TYPES:
Stock: 2-5km typical
3dBi upgrade: 3-7km typical
5dBi upgrade: 4-10km typical
Directional: 5-15km+ (aimed)

DIY ANTENNAS:
Ground plane: Easy, cheap, effective
1/4 wave: Simple wire, good range
Yagi: Directional, max range

MOUNTING TIPS:
□ Above roof line if possible
□ Clear line of sight
□ Avoid metal obstructions
□ Weatherproof connections
□ Secure against wind

CABLE LOSS:
Every foot of cable = loss
Keep runs SHORT
Use low-loss cable (LMR-400)
Direct mount best

TROUBLESHOOTING:
- Low range? Check SWR
- No improvement? Check connections
- Still bad? Try different location
- Directional not working? Aim it!`
      },
      troubleshooting: {
        title: 'TROUBLESHOOTING FLOWCHART',
        content: `NO CONNECTIVITY?

STEP 1: Basic Checks
□ Device powered on?
□ Firmware up to date?
□ App connected via Bluetooth?
□ Region setting correct?

STEP 2: Settings
□ Encryption matching neighbors?
□ Same channel/frequency?
□ Power level sufficient?
□ Hop limit at least 3?

STEP 3: Antenna
□ Antenna connected?
□ SWR acceptable?
□ Elevated position?
□ Clear line of sight?

STEP 4: Range Test
□ Start close (100m)
□ Gradually increase distance
□ Note where it fails
□ Adjust power/position

COMMON FIXES:
- Update firmware first
- Match encryption keys
- Check region setting
- Increase antenna height
- Reduce obstructions
- Add relay node

STILL NOT WORKING?
1. Factory reset device
2. Reconfigure from scratch
3. Check hardware with multimeter
4. Replace antenna
5. Try different device

chaoskoalas.com/mesh`
      },
      neighborhood: {
        title: 'NEIGHBORHOOD NET CARD',
        content: `FILL IN YOUR INFORMATION:

FREQUENCIES:
Primary Channel: _____ (___.___ MHz)
CTCSS/PL Tone: _____ Hz
Backup Channel: _____ (___.___ MHz)
Emergency: Ch 1 (462.5625 MHz)

NET CONTROL:
Callsign: _____________________
Name: _________________________
Location: _____________________
Phone: ________________________

CHECK-IN SCHEDULE:
Morning: _____ (Time)
Evening: _____ (Time)
Emergency: Monitor continuously

RALLY POINTS:
Alpha: _______________________
GPS: __________________________
Bravo: ________________________
GPS: __________________________

SPECIAL NEEDS HOUSEHOLDS:
□ ___________________________
  Medical: ___________________
□ ___________________________
  Medical: ___________________
□ ___________________________
  Medical: ___________________

RESOURCE OWNERS:
Generator: ____________________
Solar Panels: _________________
Medical Training: _____________
Chainsaw: _____________________
Tools: ________________________
Water Storage: ________________

NEIGHBORHOOD CONTACTS:
_____ / _____________________ / _____
_____ / _____________________ / _____
_____ / _____________________ / _____
_____ / _____________________ / _____
_____ / _____________________ / _____

NOTES:
_________________________________
_________________________________
_________________________________

Print, laminate, keep with radio!
chaoskoalas.com/wombat`
      }
    };
    
    // ===========================================================================================
    // COMMAND PROCESSING
    // ===========================================================================================
    
    function processCommand(cmd) {
      // Command aliases
      const aliases = {
        '?': 'help',
        'cls': 'clear',
        'h': 'help'
      };
      
      cmd = cmd.trim();
      if (aliases[cmd]) cmd = aliases[cmd];
      
      const parts = cmd.toLowerCase().split(' ');
      const command = parts[0];
      const args = parts.slice(1);
      
      const historyDiv = document.createElement('div');
      historyDiv.className = 'command-history';
      historyDiv.textContent = '$ ' + cmd;
      terminal.appendChild(historyDiv);
      
      commandHistory.push(cmd);
      historyIndex = commandHistory.length;
      
      switch(command) {
        case 'help': showHelp(); break;
        case 'about': showAbout(); break;
        case 'quick': quickStart(); break;
        case 'demo': runDemo(); break;
        case 'triage': showTriage(); break;
        case 'save': saveSession(); break;
        case 'load': loadSession(); break;
        case 'import': openImportDialog(); break;
        case 'backup': backupSave(); break;
        case 'restore': restoreSave(); break;
        case 'status': showStatus(); break;
        case 'scenario': handleScenario(args); break;
        case 'plan': handlePlan(args); break;
        case 'equipment': handleEquipment(args); break;
        case 'card': handleCard(args); break;
        case 'battery': batteryCalculator(); break;
        case 'range': rangeCalculator(); break;
        case 'export': handleExport(args); break;
        case 'clear': clearTerminal(); break;
        case '': break;
        default:
          addOutput(`Unknown command: ${command}`, 'warning');
          
          // Suggest similar commands
          const COMMANDS = ['help', 'about', 'quick', 'demo', 'triage', 'save', 'load', 'import', 'backup', 
                           'restore', 'status', 'scenario', 'plan', 'equipment', 'card', 'battery', 
                           'range', 'export', 'clear'];
          const suggestions = COMMANDS.filter(cmd => 
            cmd.startsWith(command) || command.startsWith(cmd.slice(0, 3))
          ).slice(0, 3);
          
          if (suggestions.length > 0) {
            addOutput(`Did you mean: ${suggestions.join(', ')}?`, 'dim');
          }
          addOutput('Type "help" for available commands', 'dim');
      }
      
      input.value = '';
    }
    
    function showTriage() {
      addOutput('\n' + '='.repeat(60), 'danger');
      addOutput('EMERGENCY TRIAGE - FIRST 30 MINUTES', 'danger');
      addOutput('='.repeat(60) + '\n', 'danger');
      
      addOutput('If disaster is happening RIGHT NOW, do these IN ORDER:\n', 'warning');
      
      addOutput('FIRST 10 MINUTES - LIFE SAFETY:', 'danger');
      addOutput('  1. Get to safe location (away from windows, water, fire)');
      addOutput('  2. Check immediate family/household for injuries');
      addOutput('  3. Turn on ONE radio to monitor emergency broadcasts');
      addOutput('  4. If power out: Fill bathtubs and sinks with water NOW');
      addOutput('  5. Grab go-bag if evacuation likely\n');
      
      addOutput('NEXT 10 MINUTES - SITUATIONAL AWARENESS:', 'warning');
      addOutput('  6. Activate Meshtastic nodes or GMRS radio on Ch 15');
      addOutput('  7. Quick radio check: "Callsign - Status OK/NEED HELP"');
      addOutput('  8. Assess your immediate area (gas leaks, structural damage, fires)');
      addOutput('  9. Check phones for official emergency alerts');
      addOutput(' 10. If phones work: Text don\'t call (preserves network)\n');
      
      addOutput('NEXT 10 MINUTES - STABILIZE:', 'info');
      addOutput(' 11. Treat any injuries with first aid');
      addOutput(' 12. Turn OFF gas if you smell it or see damage');
      addOutput(' 13. Deploy battery banks, start charging critical devices');
      addOutput(' 14. Take photos of any damage (insurance)');
      addOutput(' 15. If safe, check on immediate neighbors (visual only)\n');
      
      addOutput('WHEN TO STOP AND CALL 911:', 'danger');
      addOutput('  * Serious injury or medical emergency');
      addOutput('  * Fire you cannot extinguish');
      addOutput('  * Gas leak you cannot stop');
      addOutput('  * Building collapse or major structural damage');
      addOutput('  * Anyone trapped or missing');
      addOutput('  * Chemical spill or hazmat situation\n');
      
      addOutput('AFTER 30 MINUTES:', 'success');
      addOutput('  * You should have: Safety check done, water stored,');
      addOutput('    communications active, injuries treated, neighbors checked');
      addOutput('  * Next: Type "scenario [type]" for detailed response plan');
      addOutput('  * Available: hurricane, power_outage, earthquake, wildfire, etc\n');
      
      addOutput('='.repeat(60) + '\n');
      addOutput('Type "help" for all commands | "scenario list" for specific plans', 'info');
      
      // Add print button
      addHTML_UNSAFE_TRUSTED_ONLY(`
        <div class="button-group" style="margin-top: 1rem;">
          <button class="terminal-button" onclick="printTriageCard()">
            PRINT TRIAGE CARD
          </button>
        </div>
      `);
    }
    
    function printTriageCard() {
      addOutput('GENERATING PRINTABLE TRIAGE CARD', 'info');
      
      let cardHTML = `
        <div class="card-preview" style="page-break-after: always; max-width: 100%; padding: 2rem; border: 2px solid black; margin: 1rem 0;">
          <h2 style="margin: 0 0 0.5rem 0; font-size: 1.5rem; border-bottom: 3px solid #dc3545; padding-bottom: 0.5rem; color: #dc3545;">
            EMERGENCY TRIAGE - FIRST 30 MINUTES
          </h2>
          <p style="margin: 0.5rem 0; padding: 0.5rem; background: #f8d7da; border-left: 4px solid #dc3545; font-weight: bold;">
            If disaster is happening RIGHT NOW, do these IN ORDER
          </p>
          
          <h3 style="margin: 1.5rem 0 0.5rem 0; border-bottom: 2px solid #dc3545; padding-bottom: 0.25rem; color: #dc3545;">
            FIRST 10 MINUTES - LIFE SAFETY
          </h3>
          <div style="margin: 0.5rem 0; padding-left: 1rem;">
            <div style="margin: 0.25rem 0;">☐ Get to safe location (away from windows, water, fire)</div>
            <div style="margin: 0.25rem 0;">☐ Check immediate family/household for injuries</div>
            <div style="margin: 0.25rem 0;">☐ Turn on ONE radio to monitor emergency broadcasts</div>
            <div style="margin: 0.25rem 0;">☐ If power out: Fill bathtubs and sinks with water NOW</div>
            <div style="margin: 0.25rem 0;">☐ Grab go-bag if evacuation likely</div>
          </div>
          
          <h3 style="margin: 1.5rem 0 0.5rem 0; border-bottom: 2px solid #ffc107; padding-bottom: 0.25rem; color: #856404;">
            NEXT 10 MINUTES - SITUATIONAL AWARENESS
          </h3>
          <div style="margin: 0.5rem 0; padding-left: 1rem;">
            <div style="margin: 0.25rem 0;">☐ Activate Meshtastic nodes or GMRS radio on Ch 15</div>
            <div style="margin: 0.25rem 0;">☐ Quick radio check: "Callsign - Status OK/NEED HELP"</div>
            <div style="margin: 0.25rem 0;">☐ Assess your immediate area (gas leaks, structural damage, fires)</div>
            <div style="margin: 0.25rem 0;">☐ Check phones for official emergency alerts</div>
            <div style="margin: 0.25rem 0;">☐ If phones work: Text don't call (preserves network)</div>
          </div>
          
          <h3 style="margin: 1.5rem 0 0.5rem 0; border-bottom: 2px solid #17a2b8; padding-bottom: 0.25rem; color: #0c5460;">
            NEXT 10 MINUTES - STABILIZE
          </h3>
          <div style="margin: 0.5rem 0; padding-left: 1rem;">
            <div style="margin: 0.25rem 0;">☐ Treat any injuries with first aid</div>
            <div style="margin: 0.25rem 0;">☐ Turn OFF gas if you smell it or see damage</div>
            <div style="margin: 0.25rem 0;">☐ Deploy battery banks, start charging critical devices</div>
            <div style="margin: 0.25rem 0;">☐ Take photos of any damage (insurance)</div>
            <div style="margin: 0.25rem 0;">☐ If safe, check on immediate neighbors (visual only)</div>
          </div>
          
          <h3 style="margin: 1.5rem 0 0.5rem 0; border-bottom: 2px solid #dc3545; padding-bottom: 0.25rem; color: #dc3545;">
            WHEN TO STOP AND CALL 911
          </h3>
          <div style="margin: 0.5rem 0; padding-left: 1rem; background: #f8d7da; padding: 0.75rem; border-radius: 4px;">
            <div style="margin: 0.25rem 0; font-weight: bold;">★ Serious injury or medical emergency</div>
            <div style="margin: 0.25rem 0; font-weight: bold;">★ Fire you cannot extinguish</div>
            <div style="margin: 0.25rem 0; font-weight: bold;">★ Gas leak you cannot stop</div>
            <div style="margin: 0.25rem 0; font-weight: bold;">★ Building collapse or major structural damage</div>
            <div style="margin: 0.25rem 0; font-weight: bold;">★ Anyone trapped or missing</div>
            <div style="margin: 0.25rem 0; font-weight: bold;">★ Chemical spill or hazmat situation</div>
          </div>
          
          <h3 style="margin: 1.5rem 0 0.5rem 0; border-bottom: 2px solid #28a745; padding-bottom: 0.25rem; color: #155724;">
            AFTER 30 MINUTES - STATUS CHECK
          </h3>
          <div style="margin: 0.5rem 0; padding-left: 1rem; background: #d4edda; padding: 0.75rem; border-radius: 4px;">
            <div style="margin: 0.25rem 0;"><strong>You should have:</strong></div>
            <div style="margin: 0.25rem 0;">• Safety check done, water stored</div>
            <div style="margin: 0.25rem 0;">• Communications active, injuries treated</div>
            <div style="margin: 0.25rem 0;">• Neighbors checked</div>
            <div style="margin: 0.5rem 0; margin-top: 0.75rem;"><strong>Next steps:</strong></div>
            <div style="margin: 0.25rem 0;">• Refer to specific scenario plan (hurricane, earthquake, etc.)</div>
            <div style="margin: 0.25rem 0;">• Establish regular radio check-ins with neighborhood</div>
            <div style="margin: 0.25rem 0;">• Begin organized response coordination</div>
          </div>
          
          <div style="margin-top: 2rem; padding-top: 1rem; border-top: 2px solid #dc3545; font-size: 0.85rem;">
            <div style="background: #fff3cd; padding: 0.75rem; border-radius: 4px; border-left: 4px solid #ffc107;">
              <strong>CRITICAL REMINDERS:</strong><br>
              • First responders may be overwhelmed - you are on your own for 72+ hours<br>
              • Every second counts in the first 30 minutes<br>
              • Check on neighbors - coordination saves lives<br>
              • Communications = your lifeline to help and coordination
            </div>
          </div>
          
          <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #ccc; font-size: 0.75rem; color: #666;">
            <strong>Emergency planning guidance only</strong> - Adjust for your specific situation<br>
            Generated by WOMBAT - chaoskoalas.com<br>
            Print, laminate, post in visible location or keep with emergency supplies
          </div>
        </div>
      `;
      
      // Show in terminal for preview
      addHTML_UNSAFE_TRUSTED_ONLY(cardHTML);
      
      // Stage for printing (outside the terminal, so print CSS can hide the UI)
      addCardToPrintArea(cardHTML);
      
      addOutput('\n[OK] Printable triage card generated', 'success');
      addOutput('Press Ctrl+P to print or save as PDF\n', 'info');
    }
    
    function showHelp() {
      const help = `
WOMBAT COMMAND REFERENCE

QUICK START:
  quick                     - Fast interactive setup guide
  about                     - About WOMBAT and disclaimer
  triage                    - EMERGENCY: First 30 minutes action list
  demo                      - Full system demonstration

SCENARIO PLANNING (10 scenarios):
  scenario list             - Show all scenarios
  scenario [name]           - Interactive scenario (hurricane, power_outage,
                              wildfire, earthquake, winter_storm, lights_out,
                              water_question, etc.)
  scenario [name] timeline  - Action timeline
  scenario [name] checklist - Printable checklist
  scenario [name] card      - Printable reference card

NETWORK PLANNING:
  plan wizard               - Full planning wizard
  plan quick                - Quick assessment
  plan visualize            - Interactive network map
  plan show                 - Show current plan

EQUIPMENT:
  equipment list            - Browse database
  equipment compare         - Side-by-side comparison
  equipment calculator      - Build equipment list

CALCULATIONS:
  battery                   - Runtime calculations
  range                     - Distance estimation

REFERENCE CARDS (9 types):
  card list                 - Show all cards
  card [type]              - Generate card (gmrs, meshtastic, frequencies,
                            emergency, atak, battery, antenna, troubleshooting,
                            neighborhood)
  card pack                - Print all essential cards at once

DATA:
  export text              - Export plan as text summary
  export plan              - Export network plan JSON
  export all               - Export everything as JSON
  backup                   - Backup your session (copy/paste)
  restore                  - Restore from backup
  save / load / import     - Session management

SYSTEM:
  clear                    - Clear terminal
  status                   - Show current status
  save                     - Save session
  load                     - Load session
  import                   - Import exported JSON (plan or full session)
  help                     - This help

EXAMPLES:
  $ quick
  $ triage
  $ scenario hurricane
  $ plan visualize
  $ equipment compare
  $ card pack
  $ card gmrs

TIP: Most commands are interactive - just follow the prompts!
`;
      addOutput(help, 'info');
    }
    
    function quickStart() {
      addOutput('QUICK START GUIDE', 'info');
      
      addOutput('Welcome to WOMBAT! Let me help you get started.\n', 'success');
      addOutput('What do you want to do?\n');
      
      addHTML_UNSAFE_TRUSTED_ONLY(`
        <div class="button-group">
          <button class="terminal-button" onclick="processCommand('scenario list')">
            Plan for Emergency
          </button>
          <button class="terminal-button" onclick="processCommand('plan wizard')">
            Design Network
          </button>
          <button class="terminal-button" onclick="processCommand('equipment list')">
            Browse Equipment
          </button>
          <button class="terminal-button" onclick="processCommand('card list')">
            Get Quick Reference
          </button>
        </div>
      `);
      
      addOutput('\n\nOr type any command - "help" for full list', 'info');
    }
    
    // ===========================================================================================
    // SCENARIO HANDLING
    // ===========================================================================================
    
    function handleScenario(args) {
      if (!args[0] || args[0] === 'list') {
        listScenarios();
      } else if (args[1] === 'timeline') {
        showTimeline(args[0]);
      } else if (args[1] === 'checklist') {
        showChecklist(args[0]);
      } else if (args[1] === 'card') {
        showScenarioCard(args[0]);
      } else {
        runScenario(args[0]);
      }
    }
    
    function listScenarios() {
      addOutput('AVAILABLE SCENARIOS', 'info');
      
      Object.entries(scenarios).forEach(([key, s]) => {
        const color = s.severity === 'critical' ? 'danger' : 'warning';
        addOutput(`[${s.severity.toUpperCase()}] ${s.name}`, color);
        addOutput(`  ${s.description}`);
        addOutput(`  Usage: scenario ${key}\n`);
      });
    }
    
    async function runScenario(name) {
      const s = scenarios[name];
      if (!s) {
        addOutput(`ERROR: Unknown scenario '${name}'`, 'warning');
        addOutput('Type "scenario list" to see available scenarios');
        return;
      }
      
      addOutput('\n' + '═'.repeat(60), 'info');
      addOutput(`SCENARIO: ${s.name}`, 'info');
      addOutput('═'.repeat(60), 'info');
      addOutput(s.description + '\n', 'warning');
      addOutput('NOTE: This is a planning aid. Always follow local emergency management and official guidance for your area.\n', 'help-text');
      
      // Check if this is a COA-based scenario or question-based
      if (s.courses_of_action) {
        // New COA format - decision-focused
        addOutput('\nOBJECTIVE:', 'info');
        addOutput(s.objective + '\n');
        
        if (s.constraints) {
          addOutput('CONSTRAINTS:', 'warning');
          s.constraints.forEach(c => addOutput('  * ' + c));
          addOutput('');
        }
        
        if (s.available_assets) {
          addOutput('AVAILABLE ASSETS:', 'success');
          s.available_assets.forEach(a => addOutput('  * ' + a));
          addOutput('');
        }
        
        addOutput('COURSES OF ACTION:', 'info');
        addOutput('═'.repeat(60) + '\n');
        
        s.courses_of_action.forEach((coa, i) => {
          addOutput(`${coa.name}`, 'success');
          addOutput(`Description: ${coa.description}`);
          addOutput(`Effort: ${coa.effort} | Resources: ${coa.resources}`);
          addOutput(`\nOutcome: ${coa.outcome}`);
          addOutput(`Best for: ${coa.best_for}\n`);
        });
        
        if (s.decision_factors) {
          addOutput('DECISION FACTORS:', 'info');
          s.decision_factors.forEach(f => addOutput('  ? ' + f));
          addOutput('');
        }
        
        if (s.real_world_notes) {
          addOutput('REAL-WORLD NOTES:', 'info');
          s.real_world_notes.forEach(n => addOutput('  - ' + n));
          addOutput('');
        }
        
        if (s.recommended_coa) {
          addOutput('RECOMMENDED:', 'success');
          addOutput(s.recommended_coa + '\n');
        }
        
        addOutput('═'.repeat(60) + '\n');
        
        // Add print button for COA scenarios
        addHTML_UNSAFE_TRUSTED_ONLY(`
          <div class="button-group" style="margin-top: 1rem;">
            <button class="terminal-button" onclick="showScenarioCard('${name}')">
              PRINT SCENARIO CARD
            </button>
            <button class="terminal-button" onclick="printChecklist('${name}')">
              PRINT CHECKLIST
            </button>
          </div>
        `);
        
      } else if (s.questions) {
        // Original question-based format - assessment focused
        const answers = [];
        
        for (let i = 0; i < s.questions.length; i++) {
          const q = s.questions[i];
          showProgress(i + 1, s.questions.length, 'Assessment');
          
          await new Promise(resolve => {
            // Setup state for event delegation
            currentScenarioState = {
              scenario: name,
              questions: s.questions,
              answers: answers,
              resolve: resolve
            };
            
            addOutput(`\n[${i + 1}/${s.questions.length}] ${q.q}`, 'info');
            if (q.tooltip) addOutput(`INFO:  ${q.tooltip}`, 'help-text');
            
            addHTML_UNSAFE_TRUSTED_ONLY(`
              <div class="button-group">
                <button class="terminal-button" 
                  data-action="scenarioAnswer" 
                  data-q-index="${i}" 
                  data-ans="true">[OK] YES</button>
                <button class="terminal-button" 
                  data-action="scenarioAnswer" 
                  data-q-index="${i}" 
                  data-ans="false">[X] NO</button>
              </div>
            `);
          });
        }
        
        // Clean up state
        currentScenarioState = null;
        
        const readiness = Math.round((answers.filter(a => a).length / answers.length) * 100);
        
        addOutput('\n' + '═'.repeat(60), 'success');
        addOutput('ASSESSMENT COMPLETE', 'success');
        addOutput('═'.repeat(60) + '\n', 'success');
        addOutput(`Readiness Score: ${readiness}%`, readiness > 70 ? 'success' : 'warning');
        
        if (readiness < 50) {
          addOutput('\nWARNING:  CRITICAL GAPS', 'danger');
        } else if (readiness < 80) {
          addOutput('\nWARNING:  MODERATE PREP', 'warning');
        } else {
          addOutput('\n[OK] WELL PREPARED', 'success');
        }
        
        addOutput('\n\nRECOMMENDED ACTIONS:', 'info');
        addOutput('═'.repeat(40));
        s.recommendations
          .filter(line => line.trim() !== '')
          .forEach(line => addOutput(line));
        
        scenarioResults[name] = { answers, readiness, timestamp: new Date().toISOString() };
        
        addOutput('\n' + '═'.repeat(60) + '\n');
        if (s.timeline) {
          addOutput(`Type "scenario ${name} timeline" for action timeline`, 'info');
        }
        addOutput(`Type "scenario ${name} checklist" for checklist`, 'info');
        addOutput(`Type "scenario ${name} card" for printable card`, 'info');
        
        // Add print button for quick access
        addHTML_UNSAFE_TRUSTED_ONLY(`
          <div class="button-group" style="margin-top: 1rem;">
            <button class="terminal-button" onclick="showScenarioCard('${name}')">
              PRINT SCENARIO CARD
            </button>
          </div>
        `);
      }
    }
    
    function showTimeline(name) {
      const s = scenarios[name];
      if (!s) return;
      
      addOutput(`${s.name.toUpperCase()} - ACTION TIMELINE`, 'info');
      
      if (!Array.isArray(s.timeline) || s.timeline.length === 0) {
        addOutput('No timeline available for this scenario.', 'warning');
        if (s.courses_of_action) {
          addOutput('This is a decision-focused scenario.', 'info');
          addOutput(`Type "scenario ${name}" to see Courses of Action instead.\n`, 'info');
        }
        return;
      }
      
      // Create proper DOM structure
      const wrapper = document.createElement('div');
      wrapper.className = 'timeline';
      
      s.timeline.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'timeline-item';
        
        const timeDiv = document.createElement('div');
        timeDiv.className = 'timeline-time';
        timeDiv.textContent = item.time;
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'timeline-content';
        contentDiv.textContent = item.action;
        
        itemDiv.appendChild(timeDiv);
        itemDiv.appendChild(contentDiv);
        wrapper.appendChild(itemDiv);
      });
      
      const output = document.createElement('div');
      output.className = 'output';
      output.appendChild(wrapper);
      terminal.appendChild(output);
      
      // Add print button
      addHTML_UNSAFE_TRUSTED_ONLY(`
        <div class="button-group" style="margin-top: 1rem;">
          <button class="terminal-button" onclick="printTimeline('${name}')">
            PRINT TIMELINE
          </button>
        </div>
      `);
      
      scrollToBottom(true);
    }
    
    function showChecklist(name) {
      const s = scenarios[name];
      if (!s) return;
      
      addOutput(`${s.name.toUpperCase()} - CHECKLIST`, 'info');
      
      if (!Array.isArray(s.recommendations) || s.recommendations.length === 0) {
        addOutput('No checklist available for this scenario.', 'warning');
        if (s.courses_of_action) {
          addOutput('\nDECISION FACTORS:', 'info');
          if (s.decision_factors) {
            s.decision_factors.forEach(f => addOutput(`  □ ${f}`));
          }
          addOutput('\nRECOMMENDED ACTION:', 'success');
          if (s.recommended_coa) {
            addOutput(`  ${s.recommended_coa}\n`);
          }
        }
        return;
      }
      
      s.recommendations
        .filter(line => line.trim() !== '')
        .forEach(r => addOutput(`□ ${r}`));
      
      addOutput('\n[OK] Checklist generated', 'success');
      
      // Add print button
      addHTML_UNSAFE_TRUSTED_ONLY(`
        <div class="button-group" style="margin-top: 1rem;">
          <button class="terminal-button" onclick="printChecklist('${name}')">
            PRINT CHECKLIST
          </button>
        </div>
      `);
    }
    
    function printChecklist(name) {
      const s = scenarios[name];
      if (!s) return;
      
      addOutput('GENERATING PRINTABLE CHECKLIST', 'info');
      
      // Build the checklist card HTML
      let cardHTML = `
        <div class="card-preview" style="page-break-after: always; max-width: 100%; padding: 2rem; border: 2px solid black; margin: 1rem 0;">
          <h2 style="margin: 0 0 0.5rem 0; font-size: 1.5rem; border-bottom: 2px solid black; padding-bottom: 0.5rem;">
            ${escapeHTML(s.name)} - CHECKLIST
          </h2>
          <p style="margin: 0.5rem 0; padding: 0.5rem; background: #fff3cd; border-left: 4px solid #ffc107;">
            <strong>Severity:</strong> ${escapeHTML(s.severity.toUpperCase())}
          </p>
      `;
      
      // Add recommendations if available
      if (s.recommendations && s.recommendations.length > 0) {
        cardHTML += `
          <h3 style="margin: 1.5rem 0 0.5rem 0; border-bottom: 1px solid #333; padding-bottom: 0.25rem;">
            Action Items
          </h3>
        `;
        s.recommendations.forEach(r => {
          if (r.trim()) {
            cardHTML += `
              <div style="margin: 0.25rem 0; font-size: 0.9rem;">
                ☐ ${escapeHTML(r)}
              </div>
            `;
          }
        });
      }
      
      // Add decision factors for COA-based scenarios
      if (s.decision_factors && s.decision_factors.length > 0) {
        cardHTML += `
          <h3 style="margin: 1.5rem 0 0.5rem 0; border-bottom: 1px solid #333; padding-bottom: 0.25rem;">
            Decision Factors
          </h3>
        `;
        s.decision_factors.forEach(f => {
          cardHTML += `
            <div style="margin: 0.25rem 0; font-size: 0.9rem;">
              ☐ ${escapeHTML(f)}
            </div>
          `;
        });
      }
      
      // Add recommended COA if available
      if (s.recommended_coa) {
        cardHTML += `
          <h3 style="margin: 1.5rem 0 0.5rem 0; border-bottom: 1px solid #333; padding-bottom: 0.25rem;">
            Recommended Action
          </h3>
          <div style="margin: 0.5rem 0; padding: 0.75rem; background: #d4edda; border-left: 4px solid #28a745;">
            ${escapeHTML(s.recommended_coa)}
          </div>
        `;
      }
      
      cardHTML += `
          <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #ccc; font-size: 0.75rem; color: #666;">
            <strong>Planning guidance only</strong> - Verify with local authorities<br>
            Generated by WOMBAT - chaoskoalas.com<br>
            Print, laminate, keep with emergency supplies
          </div>
        </div>
      `;
      
      // Show in terminal for preview
      addHTML_UNSAFE_TRUSTED_ONLY(cardHTML);
      
      // Stage for printing
      addCardToPrintArea(cardHTML);
      
      addOutput('\n[OK] Printable checklist generated', 'success');
      addOutput('Press Ctrl+P to print or save as PDF\n', 'info');
    }
    
    function printTimeline(name) {
      const s = scenarios[name];
      if (!s) return;
      
      addOutput('GENERATING PRINTABLE TIMELINE', 'info');
      
      // Build the timeline card HTML
      let cardHTML = `
        <div class="card-preview" style="page-break-after: always; max-width: 100%; padding: 2rem; border: 2px solid black; margin: 1rem 0;">
          <h2 style="margin: 0 0 0.5rem 0; font-size: 1.5rem; border-bottom: 2px solid black; padding-bottom: 0.5rem;">
            ${escapeHTML(s.name)} - ACTION TIMELINE
          </h2>
          <p style="margin: 0.5rem 0; padding: 0.5rem; background: #fff3cd; border-left: 4px solid #ffc107;">
            <strong>Severity:</strong> ${escapeHTML(s.severity.toUpperCase())}
          </p>
      `;
      
      // Add timeline if available
      if (s.timeline && s.timeline.length > 0) {
        cardHTML += `
          <div style="margin: 1.5rem 0;">
        `;
        s.timeline.forEach(item => {
          cardHTML += `
            <div style="margin: 0.75rem 0; padding-left: 1.5rem; position: relative;">
              <div style="position: absolute; left: 0; top: 0.3rem; width: 10px; height: 10px; border-radius: 50%; background: black; border: 2px solid white; box-shadow: 0 0 0 2px black;"></div>
              <div style="font-weight: bold; color: #d97706; margin-bottom: 0.25rem;">
                ${escapeHTML(item.time)}
              </div>
              <div style="color: #333; line-height: 1.5;">
                ${escapeHTML(item.action)}
              </div>
            </div>
          `;
        });
        cardHTML += `
          </div>
        `;
      }
      
      cardHTML += `
          <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #ccc; font-size: 0.75rem; color: #666;">
            <strong>Planning guidance only</strong> - Verify with local authorities<br>
            Generated by WOMBAT - chaoskoalas.com<br>
            Print, laminate, keep with emergency supplies
          </div>
        </div>
      `;
      
      // Show in terminal for preview
      addHTML_UNSAFE_TRUSTED_ONLY(cardHTML);
      
      // Stage for printing
      addCardToPrintArea(cardHTML);
      
      addOutput('\n[OK] Printable timeline generated', 'success');
      addOutput('Press Ctrl+P to print or save as PDF\n', 'info');
    }
    
    function showScenarioCard(name) {
      const s = scenarios[name];
      if (!s) {
        addOutput(`ERROR: Unknown scenario '${name}'`, 'warning');
        return;
      }
      
      addOutput('GENERATING PRINTABLE CARD', 'info');
      
      let cardHTML = `
        <div class="card-preview" style="page-break-after: always; max-width: 100%; padding: 2rem; border: 2px solid black; margin: 1rem 0;">
          <h2 style="margin: 0 0 0.5rem 0; font-size: 1.5rem; border-bottom: 2px solid black; padding-bottom: 0.5rem;">
            ${escapeHTML(s.name)}
          </h2>
          <p style="margin: 0.5rem 0; padding: 0.5rem; background: #fff3cd; border-left: 4px solid #ffc107;">
            <strong>Severity:</strong> ${escapeHTML(s.severity.toUpperCase())}
          </p>
          <p style="margin: 0.5rem 0; line-height: 1.6;">
            ${escapeHTML(s.description)}
          </p>
      `;
      
      if (s.timeline && s.timeline.length > 0) {
        cardHTML += `
          <h3 style="margin: 1.5rem 0 0.5rem 0; border-bottom: 1px solid #333; padding-bottom: 0.25rem;">
            Timeline
          </h3>
        `;
        s.timeline.slice(0, 8).forEach(t => {
          cardHTML += `
            <div style="margin: 0.5rem 0; padding-left: 1rem;">
              <strong>${escapeHTML(t.time)}:</strong> ${escapeHTML(t.action)}
            </div>
          `;
        });
      }
      
      if (s.recommendations && s.recommendations.length > 0) {
        cardHTML += `
          <h3 style="margin: 1.5rem 0 0.5rem 0; border-bottom: 1px solid #333; padding-bottom: 0.25rem;">
            Key Actions Checklist
          </h3>
        `;
        s.recommendations.slice(0, 15).forEach(r => {
          if (r.trim()) {
            cardHTML += `
              <div style="margin: 0.25rem 0; font-size: 0.9rem;">
                ☐ ${escapeHTML(r)}
              </div>
            `;
          }
        });
      }
      
      if (s.decision_factors && s.decision_factors.length > 0) {
        cardHTML += `
          <h3 style="margin: 1.5rem 0 0.5rem 0; border-bottom: 1px solid #333; padding-bottom: 0.25rem;">
            Decision Factors
          </h3>
        `;
        s.decision_factors.forEach(f => {
          cardHTML += `
            <div style="margin: 0.25rem 0; font-size: 0.9rem;">
              • ${escapeHTML(f)}
            </div>
          `;
        });
      }
      
      cardHTML += `
          <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #ccc; font-size: 0.75rem; color: #666;">
            <strong>Planning guidance only</strong> - Verify with local authorities<br>
            Generated by WOMBAT - chaoskoalas.com<br>
            Print, laminate, keep with emergency supplies
          </div>
        </div>
      `;
      
      // Show in terminal for preview
      addHTML_UNSAFE_TRUSTED_ONLY(cardHTML);
      
      // Stage for printing (outside the terminal, so print CSS can hide the UI)
      addCardToPrintArea(cardHTML);
      
      addOutput('\n[OK] Printable card generated', 'success');
      addOutput('Press Ctrl+P to print or save as PDF\n', 'info');
    }
    
    // ===========================================================================================
    // NETWORK PLANNING
    // ===========================================================================================
    
    function handlePlan(args) {
      if (args[0] === 'wizard') {
        planWizard();
      } else if (args[0] === 'quick') {
        quickPlan();
      } else if (args[0] === 'visualize') {
        visualizeNetwork();
      } else if (args[0] === 'show') {
        showPlan();
      } else {
        addOutput('Usage: plan [wizard|quick|visualize|show]', 'warning');
      }
    }
    
    async function planWizard() {
      addOutput('NETWORK PLANNING WIZARD', 'info');
      
      const budgetRanges = {
        'starter': { label: '$100-$300 (Starter - 2-3 basic nodes)', value: 200 },
        'basic': { label: '$300-$600 (Basic - 5-8 nodes)', value: 450 },
        'standard': { label: '$600-$1200 (Standard - 10-15 nodes)', value: 900 },
        'advanced': { label: '$1200-$2500 (Advanced - 20-35 nodes)', value: 1850 },
        'professional': { label: '$2500+ (Professional - 35+ nodes)', value: 3000 }
      };
      
      const questions = [
        { key: 'houses', prompt: 'How many houses need coverage?', type: 'number' },
        { key: 'area_sqkm', prompt: 'Area in square kilometers?', type: 'number' },
        { key: 'terrain', prompt: 'Terrain type?', type: 'select', options: Object.keys(terrainTypes) },
        { key: 'has_solar', prompt: 'Solar power available?', type: 'bool' },
        { key: 'budget', prompt: 'Budget range?', type: 'budget', options: budgetRanges }
      ];
      
      for (let i = 0; i < questions.length; i++) {
        const q = questions[i];
        showProgress(i + 1, questions.length, 'Planning');
        
        await new Promise(resolve => {
          // Setup state for event delegation
          currentWizardState = {
            questions: questions,
            currentStep: i,
            resolve: resolve
          };
          
          addOutput(`\n[${i + 1}/${questions.length}] ${q.prompt}`, 'info');
          
          if (q.type === 'select') {
            addHTML_UNSAFE_TRUSTED_ONLY(`
              <div data-wizard-step="${i}">
                <select class="terminal-select" data-wizard-input style="display:block;margin:0.5rem 0;">
                  ${q.options.map(o => `<option value="${o}">${o}</option>`).join('')}
                </select>
                <button class="terminal-button" data-action="wizardSubmit" data-step="${i}">Continue</button>
              </div>
            `);
          } else if (q.type === 'budget') {
            addHTML_UNSAFE_TRUSTED_ONLY(`
              <div data-wizard-step="${i}">
                <select class="terminal-select" data-wizard-input data-budget-select style="display:block;margin:0.5rem 0;">
                  ${Object.entries(q.options).map(([key, opt]) => 
                    `<option value="${opt.value}">${opt.label}</option>`
                  ).join('')}
                </select>
                <button class="terminal-button" data-action="wizardSubmit" data-step="${i}">Continue</button>
              </div>
            `);
          } else if (q.type === 'bool') {
            addHTML_UNSAFE_TRUSTED_ONLY(`
              <div data-wizard-step="${i}" class="button-group">
                <button class="terminal-button" data-action="wizardBool" data-step="${i}" data-value="true">YES</button>
                <button class="terminal-button" data-action="wizardBool" data-step="${i}" data-value="false">NO</button>
              </div>
            `);
          } else {
            addHTML_UNSAFE_TRUSTED_ONLY(`
              <div data-wizard-step="${i}">
                <input type="${q.type}" class="terminal-input" data-wizard-input placeholder="${q.key}" style="display:block;margin:0.5rem 0;" min="0">
                <button class="terminal-button" data-action="wizardSubmit" data-step="${i}">Continue</button>
              </div>
            `);
          }
        });
      }
      
      // Clean up state
      currentWizardState = null;
      
      generatePlan();
    }
    
    function generatePlan() {
      addOutput('\n\nAnalyzing configuration...', 'info');
      
      setTimeout(() => {
        const terrain = terrainTypes[networkPlan.terrain];
        const baseRange = 2.0;
        const effectiveRange = baseRange * terrain.multiplier;
        const coverage = Math.PI * Math.pow(effectiveRange * 0.8, 2);
        const minNodes = Math.ceil(networkPlan.area_sqkm / coverage);
        const recNodes = Math.ceil(minNodes * 1.5);
        
        const nodeCost = 60;
        const affordableNodes = Math.floor(networkPlan.budget / nodeCost);
        
        // Store calculated values for visualizer
        networkPlan.minNodes = minNodes;
        networkPlan.recNodes = recNodes;
        networkPlan.effectiveRange = effectiveRange;
        networkPlan.coverage = coverage;
        
        addOutput('\n' + '═'.repeat(60), 'info');
        addOutput('NETWORK PLAN GENERATED', 'info');
        addOutput('═'.repeat(60) + '\n', 'info');
        
        addHTML_UNSAFE_TRUSTED_ONLY(`
          <div class="stats-grid">
            <div class="stat-box">
              <div class="stat-label">Effective Range</div>
              <div class="stat-value">${effectiveRange.toFixed(1)} km</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">Min Nodes</div>
              <div class="stat-value">${minNodes}</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">Recommended</div>
              <div class="stat-value">${recNodes}</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">Affordable</div>
              <div class="stat-value">${affordableNodes}</div>
            </div>
          </div>
        `);
        
        addOutput(`\nArea: ${networkPlan.area_sqkm} sq km`);
        addOutput(`Houses: ${networkPlan.houses}`);
        addOutput(`Terrain: ${networkPlan.terrain} (${terrain.description})`);
        addOutput(`Budget: $${networkPlan.budget}\n`);
        
        if (affordableNodes < minNodes) {
          addOutput('WARNING:  INSUFFICIENT COVERAGE', 'danger');
          addOutput(`   Need ${minNodes - affordableNodes} more nodes`, 'danger');
        } else if (affordableNodes < recNodes) {
          addOutput('WARNING:  BASIC COVERAGE', 'warning');
          addOutput('   Consider more nodes for redundancy', 'warning');
        } else {
          addOutput('[OK] EXCELLENT COVERAGE', 'success');
        }
        
        addOutput('\n\nDEPLOYMENT PRIORITIES:', 'info');
        addOutput('1. Install perimeter nodes first');
        addOutput('2. Add central relay at high point');
        addOutput('3. Fill coverage gaps');
        addOutput('4. Deploy solar nodes');
        addOutput('5. Test before permanent mount\n');
        
        addHTML_UNSAFE_TRUSTED_ONLY(`
          <div class="button-group">
            <button class="terminal-button" onclick="visualizeNetwork()">Visualize Network</button>
            <button class="terminal-button" onclick="processCommand('equipment list')">Browse Equipment</button>
            <button class="terminal-button" onclick="processCommand('export plan')">Export Plan</button>
          </div>
        `);
        
        showNotification('Plan generated!', 'success');
      }, 1000);
    }
    
    function quickPlan() {
      addOutput('\nQUICK ASSESSMENT:', 'info');
      addOutput('═'.repeat(40));
      addOutput('For typical suburban neighborhood:');
      addOutput('  - 15 houses: 5-7 nodes needed');
      addOutput('  - Budget: $300-500 for good coverage');
      addOutput('  - Include 2-3 solar nodes');
      addOutput('  - Heltec V3 recommended for budget\n');
      addOutput('Type "plan wizard" for custom planning', 'info');
    }
    
    function showPlan() {
      if (networkPlan.houses === 0) {
        addOutput('No plan created yet. Type "plan wizard"', 'warning');
        return;
      }
      
      addOutput('\nCURRENT NETWORK PLAN:', 'info');
      addOutput('═'.repeat(40));
      addOutput(JSON.stringify(networkPlan, null, 2));
    }
    
    function visualizeNetwork() {
      addOutput('INTERACTIVE NETWORK VISUALIZER', 'info');
      
      addOutput('Drag nodes to reposition. Red circles show coverage.\n');
      
      // Remove any existing canvas to prevent pileup
      const existing = terminal.querySelector('.network-canvas');
      if (existing) existing.remove();
      
      const canvas = document.createElement('canvas');
      canvas.className = 'network-canvas';
      canvas.width = Math.min(800, window.innerWidth - 100);
      canvas.height = 500;
      terminal.appendChild(canvas);
      
      const ctx = canvas.getContext('2d');
      // Use calculated recommended nodes if available, otherwise estimate from houses
      const targetNodes = networkPlan.recNodes || Math.ceil((networkPlan.houses || 10) / 3);
      const nodeCount = Math.max(5, Math.min(20, targetNodes));
      const nodes = [];
      
      for (let i = 0; i < nodeCount; i++) {
        nodes.push({
          x: 50 + Math.random() * (canvas.width - 100),
          y: 50 + Math.random() * (canvas.height - 100),
          id: i + 1,
          solar: i < nodeCount * 0.3
        });
      }
      
      let dragNode = null;
      
      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Connections
        ctx.strokeStyle = 'rgba(57, 255, 20, 0.3)';
        ctx.lineWidth = 1;
        nodes.forEach((n1, i) => {
          nodes.forEach((n2, j) => {
            if (i < j) {
              const dist = Math.sqrt(Math.pow(n2.x - n1.x, 2) + Math.pow(n2.y - n1.y, 2));
              if (dist < 200) {
                ctx.beginPath();
                ctx.moveTo(n1.x, n1.y);
                ctx.lineTo(n2.x, n2.y);
                ctx.stroke();
              }
            }
          });
        });
        
        // Coverage circles
        nodes.forEach(n => {
          ctx.strokeStyle = 'rgba(255, 107, 53, 0.2)';
          ctx.beginPath();
          ctx.arc(n.x, n.y, 150, 0, Math.PI * 2);
          ctx.stroke();
        });
        
        // Nodes
        nodes.forEach(n => {
          ctx.fillStyle = n.solar ? '#00ff88' : '#39ff14';
          ctx.beginPath();
          ctx.arc(n.x, n.y, 8, 0, Math.PI * 2);
          ctx.fill();
          
          ctx.fillStyle = '#00d9ff';
          ctx.font = '10px "Share Tech Mono"';
          ctx.textAlign = 'center';
          ctx.fillText(`N${n.id}`, n.x, n.y - 12);
          if (n.solar) ctx.fillText('[SOLAR]', n.x, n.y + 20);
        });
      }
      
      canvas.addEventListener('mousedown', (e) => {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        nodes.forEach(n => {
          if (Math.sqrt(Math.pow(x - n.x, 2) + Math.pow(y - n.y, 2)) < 10) {
            dragNode = n;
          }
        });
      });
      
      canvas.addEventListener('mousemove', (e) => {
        if (dragNode) {
          const rect = canvas.getBoundingClientRect();
          dragNode.x = Math.max(20, Math.min(e.clientX - rect.left, canvas.width - 20));
          dragNode.y = Math.max(20, Math.min(e.clientY - rect.top, canvas.height - 20));
          draw();
        }
      });
      
      canvas.addEventListener('mouseup', () => dragNode = null);
      canvas.addEventListener('mouseleave', () => dragNode = null);
      
      draw();
      addOutput('\n[OK] Interactive visualizer loaded', 'success');
    }
    
    // ===========================================================================================
    // EQUIPMENT HANDLING
    // ===========================================================================================
    
    function handleEquipment(args) {
      if (args[0] === 'list') {
        listEquipment();
      } else if (args[0] === 'compare') {
        compareEquipment();
      } else if (args[0] === 'calculator') {
        equipmentCalculator();
      } else {
        addOutput('Usage: equipment [list|compare|calculator]', 'warning');
      }
    }
    
    function listEquipment() {
      addOutput('EQUIPMENT DATABASE', 'info');
      
      addOutput('MESHTASTIC NODES:', 'success');
      addOutput('═'.repeat(60));
      equipmentDB.nodes.forEach(n => {
        addOutput(`${n.name} - $${n.price}`);
        addOutput(`  Range: ${n.range} | Battery: ${n.battery} | GPS: ${n.gps ? 'Yes' : 'No'}\n`);
      });
      
      addOutput('\nGMRS RADIOS:', 'success');
      addOutput('═'.repeat(60));
      equipmentDB.radios.forEach(r => {
        addOutput(`${r.name} - $${r.price}`);
        addOutput(`  Power: ${r.power}\n`);
      });
    }
    
    function compareEquipment() {
      addOutput('EQUIPMENT COMPARISON', 'info');
      
      addHTML_UNSAFE_TRUSTED_ONLY(`
        <table class="comparison-table">
          <thead>
            <tr>
              <th>Model</th>
              <th>Price</th>
              <th>Range</th>
              <th>Battery</th>
              <th>GPS</th>
            </tr>
          </thead>
          <tbody>
            ${equipmentDB.nodes.map(n => `
              <tr>
                <td><strong>${n.name}</strong></td>
                <td>$${n.price}</td>
                <td>${n.range}</td>
                <td>${n.battery}</td>
                <td>${n.gps ? '[OK]' : '[X]'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `);
    }
    
    function equipmentCalculator() {
      addOutput('EQUIPMENT COST CALCULATOR', 'info');
      
      addOutput('Coming soon: Interactive equipment calculator', 'warning');
      addOutput('For now, use these estimates:');
      addOutput('  - Basic node: $35-45');
      addOutput('  - Solar setup: +$40');
      addOutput('  - GMRS radio: $25-140');
      addOutput('  - Battery bank: $25\n');
    }
    
    // ===========================================================================================
    // CALCULATORS
    // ===========================================================================================
    
    function batteryCalculator() {
      addOutput('BATTERY RUNTIME CALCULATOR', 'info');
      
      addOutput('TYPICAL RUNTIMES:', 'info');
      addOutput('═'.repeat(60));
      addOutput('Meshtastic Node (Long Fast mode):');
      addOutput('  - 10,000mAh battery: 18-24 hours');
      addOutput('  - 20,000mAh battery: 36-48 hours');
      addOutput('  - 10W solar + 10,000mAh: Indefinite\n');
      
      addOutput('GMRS Handheld Radio (5W):');
      addOutput('  - Standard battery (1800mAh): 8-12 hours');
      addOutput('  - Extended battery (3800mAh): 16-20 hours\n');
      
      addOutput('POWER SAVING TIPS:', 'success');
      addOutput('- Reduce transmission power to Medium');
      addOutput('- Increase beacon interval');
      addOutput('- Disable GPS when not needed');
      addOutput('- Use solar panels even in cloudy weather');
      addOutput('- Keep batteries warm in cold weather\n');
    }
    
    function rangeCalculator() {
      addOutput('RANGE CALCULATOR', 'info');
      
      addOutput('TYPICAL RANGES:', 'info');
      addOutput('═'.repeat(60));
      addOutput('Meshtastic (LoRa):');
      addOutput('  - Suburban: 2-5 km');
      addOutput('  - Urban: 1-3 km');
      addOutput('  - Rural: 5-15 km');
      addOutput('  - Line-of-sight: 10-50 km\n');
      
      addOutput('GMRS:');
      addOutput('  - Handheld (5W): 1-3 miles');
      addOutput('  - Mobile (50W): 5-15 miles');
      addOutput('  - With repeater: 15-30 miles\n');
      
      addOutput('RANGE FACTORS:', 'warning');
      addOutput('- Antenna height (most important!)');
      addOutput('- Terrain and obstacles');
      addOutput('- Transmission power');
      addOutput('- Antenna type and quality');
      addOutput('- Weather conditions\n');
    }
    
    // ===========================================================================================
    // CARD GENERATION
    // ===========================================================================================
    
    function handleCard(args) {
      if (!args[0] || args[0] === 'list') {
        listCards();
      } else if (args[0] === 'pack') {
        generateCardPack();
      } else {
        generateCard(args[0]);
      }
    }
    
    function listCards() {
      addOutput('\n' + '='.repeat(60), 'info');
      addOutput('AVAILABLE QUICK REFERENCE CARDS', 'info');
      addOutput('='.repeat(60) + '\n', 'info');
      
      Object.keys(cards).forEach(key => {
        addOutput(`${key.padEnd(20)} - ${cards[key].title}`);
      });
      
      addOutput('\n\nUsage: card [type]');
      addOutput('Example: card gmrs');
      addOutput('\nOr: card pack - Prints GMRS + Emergency + Frequencies + Battery', 'success');
      addOutput('    (Recommended for printing all essential cards at once)\n');
    }
    
    function generateCardPack() {
      addOutput('\nGenerating essential card pack...', 'info');
      addOutput('Includes: GMRS, Emergency Protocol, Frequencies, Battery, Neighborhood Net\n');

      const packCards = ['gmrs', 'emergency', 'frequencies', 'battery', 'neighborhood'];

      // Clear prior print staging content
      clearPrintArea();

      setTimeout(() => {
        packCards.forEach((type, idx) => {
          const card = cards[type];
          if (!card) return;

          const cardHtml = `
            <div class="card-preview">
              <h3 style="text-align: center; border-bottom: 2px solid black; padding-bottom: 0.5rem; margin-bottom: 1rem;">
                ${card.title}
              </h3>
              <pre style="font-size: 0.75rem; line-height: 1.4; white-space: pre-wrap; font-family: monospace;">${card.content}</pre>
              <div style="margin-top: 1rem; padding-top: 0.5rem; border-top: 1px solid black; font-size: 0.7rem; text-align: center;">
                chaoskoalas.com | Print & Laminate
              </div>
            </div>
          `;

          // Show in terminal for preview
          addHTML_UNSAFE_TRUSTED_ONLY(cardHtml);

          // Stage for printing (outside the terminal, so print CSS can hide the UI)
          addCardToPrintArea(cardHtml);
        });

        addOutput('\n[OK] Card pack generated (5 cards)', 'success');
        addOutput('To print: Ctrl+P - cards will print on separate pages', 'info');
        addOutput('Recommended: Print on cardstock and laminate\n');
      }, 500);
    }
    
    function generateCard(type) {
      const card = cards[type];
      if (!card) {
        addOutput(`ERROR: Unknown card type '${type}'`, 'warning');
        addOutput('Type "card list" to see available cards');
        return;
      }

      addOutput('\nGenerating printable card...', 'info');

      // Clear prior print staging content
      clearPrintArea();

      setTimeout(() => {
        const cardHtml = `
          <div class="card-preview">
            <h3 style="text-align: center; border-bottom: 2px solid black; padding-bottom: 0.5rem; margin-bottom: 1rem;">
              ${card.title}
            </h3>
            <pre style="font-size: 0.75rem; line-height: 1.4; white-space: pre-wrap; font-family: monospace;">${card.content}</pre>
            <div style="margin-top: 1rem; padding-top: 0.5rem; border-top: 1px solid black; font-size: 0.7rem; text-align: center;">
              chaoskoalas.com | Print & Laminate
            </div>
          </div>
        `;

        addHTML_UNSAFE_TRUSTED_ONLY(cardHtml);
        addCardToPrintArea(cardHtml);

        addOutput(`\n[OK] Generated card: ${card.title}`, 'success');
        addOutput('To print: Ctrl+P - card will print full page', 'info');
      }, 300);
    }
    
    // ===========================================================================================
    // EXPORT FUNCTIONS
    // ===========================================================================================
    
    function handleExport(args) {
      if (args.length === 0) {
        addOutput('Usage: export [text|plan|all]', 'warning');
        addOutput('  text - Plain text summary');
        addOutput('  plan - Network plan JSON');
        addOutput('  all  - Complete data JSON\n');
      } else if (args[0] === 'text') {
        exportText();
      } else if (args[0] === 'plan') {
        exportPlan();
      } else if (args[0] === 'all') {
        exportAll();
      } else {
        addOutput('Usage: export [text|plan|all]', 'warning');
      }
    }
    
    function exportText() {
      let text = 'W.O.M.B.A.T. NETWORK PLAN SUMMARY\n';
      text += '='.repeat(60) + '\n';
      text += `Generated: ${new Date().toLocaleString()}\n\n`;
      
      text += 'NETWORK CONFIGURATION\n';
      text += '-'.repeat(60) + '\n';
      text += `Houses: ${networkPlan.houses || 'Not configured'}\n`;
      text += `Area: ${networkPlan.area_sqkm || 'Not configured'} sq km\n`;
      text += `Terrain: ${networkPlan.terrain || 'Not configured'}\n`;
      text += `Budget: $${networkPlan.budget || 0}\n`;
      text += `Solar Available: ${networkPlan.has_solar ? 'Yes' : 'No'}\n\n`;
      
      if (networkPlan.recNodes) {
        text += 'CALCULATED REQUIREMENTS\n';
        text += '-'.repeat(60) + '\n';
        text += `Minimum Nodes: ${networkPlan.minNodes}\n`;
        text += `Recommended Nodes: ${networkPlan.recNodes}\n`;
        text += `Effective Range: ${networkPlan.effectiveRange.toFixed(1)} km\n`;
        text += `Coverage Area: ${networkPlan.coverage.toFixed(1)} sq km per node\n\n`;
      }
      
      const scenarioKeys = Object.keys(scenarioResults);
      if (scenarioKeys.length > 0) {
        text += 'COMPLETED SCENARIOS\n';
        text += '-'.repeat(60) + '\n';
        scenarioKeys.forEach(key => {
          const result = scenarioResults[key];
          text += `${key}: ${result.readiness}% ready\n`;
        });
        text += '\n';
      }
      
      text += '='.repeat(60) + '\n';
      text += 'Generated by WOMBAT - chaoskoalas.com\n';
      text += 'Planning guidance only - verify with local authorities\n';
      
      const blob = new Blob([text], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `wombat-plan-${Date.now()}.txt`;
      a.click();
      setTimeout(() => URL.revokeObjectURL(url), 1000);
      
      addOutput('\n[OK] Text summary exported', 'success');
      showNotification('Plan exported as text', 'success');
    }
    
    function exportPlan() {
      const data = JSON.stringify(networkPlan, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'wombat-network-plan.json';
      a.click();
      
      setTimeout(() => URL.revokeObjectURL(url), 1000);
      addOutput('\n[OK] Network plan exported', 'success');
      showNotification('Plan exported as JSON', 'success');
    }
    
    function exportAll() {
      const data = {
        version: 3,
        networkPlan,
        equipmentInventory,
        scenarioResults,
        timestamp: new Date().toISOString()
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'wombat-complete-export.json';
      a.click();
      
      setTimeout(() => URL.revokeObjectURL(url), 1000);
      addOutput('\n[OK] Complete export generated', 'success');
      showNotification('All data exported', 'success');
    }
    
    // ===========================================================================================
    // DEMO
    // ===========================================================================================
    
    function runDemo() {
      addOutput('FULL SYSTEM DEMONSTRATION', 'info ascii-art');
      
      addOutput('This demo will showcase key features:\n');
      
      setTimeout(() => {
        addOutput('[1/4] Scenario Planning...', 'info');
        setTimeout(() => {
          addOutput('  [OK] Hurricane scenario available', 'success');
          addOutput('  [OK] Interactive assessment ready', 'success');
          addOutput('  [OK] Timeline and checklist tools', 'success');
          
          setTimeout(() => {
            addOutput('\n[2/4] Network Planning...', 'info');
            setTimeout(() => {
              addOutput('  [OK] Planning wizard operational', 'success');
              addOutput('  [OK] Coverage calculator ready', 'success');
              addOutput('  [OK] Interactive visualizer active', 'success');
              
              setTimeout(() => {
                addOutput('\n[3/4] Equipment Database...', 'info');
                setTimeout(() => {
                  addOutput('  [OK] 4 Meshtastic nodes listed', 'success');
                  addOutput('  [OK] 3 GMRS radios available', 'success');
                  addOutput('  [OK] Comparison tool ready', 'success');
                  
                  setTimeout(() => {
                    addOutput('\n[4/4] Reference Cards...', 'info');
                    setTimeout(() => {
                      addOutput('  [OK] 8 quick reference cards', 'success');
                      addOutput('  [OK] Print-ready format', 'success');
                      addOutput('  [OK] Lamination recommended', 'success');
                      
                      setTimeout(() => {
                        addOutput('\n\n' + '═'.repeat(60), 'success');
                        addOutput('DEMONSTRATION COMPLETE', 'success');
                        addOutput('═'.repeat(60) + '\n', 'success');
                        
                        addOutput('All systems operational and ready to use!', 'success');
                        addOutput('Type "help" for command reference', 'info');
                        addOutput('Type "quick" for fast start guide\n', 'info');
                        
                        addHTML_UNSAFE_TRUSTED_ONLY(`
                          <div class="button-group">
                            <button class="terminal-button" onclick="processCommand('scenario list')">
                              Start Planning
                            </button>
                            <button class="terminal-button" onclick="processCommand('plan wizard')">
                              Design Network
                            </button>
                            <button class="terminal-button" onclick="processCommand('equipment list')">
                              Browse Equipment
                            </button>
                          </div>
                        `);
                      }, 1000);
                    }, 500);
                  }, 1000);
                }, 500);
              }, 1000);
            }, 500);
          }, 1000);
        }, 500);
      }, 500);
    }
    
    // ===========================================================================================
    // INPUT HANDLING
    // ===========================================================================================
    
    // Event delegation for interactive buttons (avoids global function pollution)
    terminal.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;
      
      const action = btn.dataset.action;
      
      if (action === 'scenarioAnswer') {
        const qIndex = Number(btn.dataset.qIndex);
        const ans = btn.dataset.ans === 'true';
        handleScenarioAnswer(qIndex, ans, btn);
      }
      
      if (action === 'wizardSubmit') {
        const step = Number(btn.dataset.step);
        handleWizardSubmit(step, btn);
      }
      
      if (action === 'wizardBool') {
        const step = Number(btn.dataset.step);
        const value = btn.dataset.value === 'true';
        handleWizardBool(step, value, btn);
      }
    });
    
    // Store scenario state for event delegation
    let currentScenarioState = null;
    
    function handleScenarioAnswer(qIndex, ans, btn) {
      if (!currentScenarioState) return;
      
      const { scenario, questions, answers, resolve } = currentScenarioState;
      const q = questions[qIndex];
      
      if (qIndex === answers.length) {
        answers.push(ans);
        btn.closest('.button-group').remove();
        addOutput(`-> ${ans ? 'YES' : 'NO'}`, ans ? 'success' : 'danger');
        addOutput(ans ? q.yes : q.no, ans ? 'info' : 'warning');
        if (resolve) resolve();
      }
    }
    
    // Store wizard state for event delegation
    let currentWizardState = null;
    
    function handleWizardSubmit(step, btn) {
      if (!currentWizardState) return;
      
      const { questions, currentStep, resolve } = currentWizardState;
      
      if (step === currentStep) {
        const q = questions[step];
        const container = btn.closest('[data-wizard-step]');
        const input = container.querySelector('[data-wizard-input]');
        
        if (input && input.value) {
          let val = input.value;
          
          // Validate number inputs
          if (q.type === 'number') {
            const num = parseFloat(val);
            if (!Number.isFinite(num) || num < 0) {
              addOutput('! Invalid number. Please enter a positive number.', 'warning');
              input.value = '';
              input.focus();
              return;
            }
            networkPlan[q.key] = num;
          } else if (q.type === 'budget') {
            // Budget dropdown returns the numeric value
            networkPlan[q.key] = parseFloat(val);
            // Display the label
            const selectedOption = input.options[input.selectedIndex];
            val = selectedOption.text;
          } else {
            networkPlan[q.key] = val;
          }
          
          addOutput(`→ ${val}`, 'success');
          container.remove();
          if (resolve) resolve();
        }
      }
    }
    
    function handleWizardBool(step, value, btn) {
      if (!currentWizardState) return;
      
      const { questions, currentStep, resolve } = currentWizardState;
      
      if (step === currentStep) {
        const q = questions[step];
        networkPlan[q.key] = value;
        addOutput(`→ ${value ? 'YES' : 'NO'}`, 'success');
        btn.closest('[data-wizard-step]').remove();
        if (resolve) resolve();
      }
    }
    
    document.addEventListener('click', () => input.focus());
    
    // Command list for autocomplete
    const commandList = [
      'help', 'about', 'quick', 'demo', 'triage', 'save', 'load', 'import', 'backup', 'restore', 'status', 'clear',
      'scenario list',
      'scenario hurricane', 'scenario hurricane timeline', 'scenario hurricane checklist', 'scenario hurricane card',
      'scenario power_outage', 'scenario power_outage timeline', 'scenario power_outage checklist', 'scenario power_outage card',
      'scenario wildfire', 'scenario wildfire timeline', 'scenario wildfire checklist', 'scenario wildfire card',
      'scenario earthquake', 'scenario earthquake timeline', 'scenario earthquake checklist', 'scenario earthquake card',
      'scenario winter_storm', 'scenario winter_storm timeline', 'scenario winter_storm checklist', 'scenario winter_storm card',
      'scenario flood', 'scenario flood timeline', 'scenario flood checklist', 'scenario flood card',
      'scenario lights_out', 'scenario lights_out timeline', 'scenario lights_out checklist', 'scenario lights_out card',
      'scenario water_question', 'scenario water_question timeline', 'scenario water_question checklist', 'scenario water_question card',
      'scenario civil_unrest', 'scenario civil_unrest timeline', 'scenario civil_unrest checklist', 'scenario civil_unrest card',
      'scenario hiking', 'scenario hiking timeline', 'scenario hiking checklist', 'scenario hiking card',
      'plan wizard', 'plan quick', 'plan visualize', 'plan show',
      'equipment list', 'equipment compare', 'equipment calculator',
      'card list', 'card pack', 'card gmrs', 'card meshtastic', 'card frequencies',
      'card emergency', 'card atak', 'card battery', 'card antenna', 'card troubleshooting',
      'card neighborhood',
      'battery', 'range', 'export text', 'export plan', 'export all'
    ];

    // =========================================================================================
    // AUTOCOMPLETE (TAB + DROPDOWN)
    // =========================================================================================

    const autocompleteEl = document.getElementById('autocomplete');
    const acState = {
      matches: [],
      selectedIndex: 0,
      isOpen: false
    };

    function normalizeCmd(s) {
      return (s || '').toLowerCase().replace(/\s+/g, ' ').trim();
    }

    function getMatches(prefix) {
      const p = normalizeCmd(prefix);
      if (!p) return [];
      return commandList
        .filter(c => c.startsWith(p))
        .slice(0, 12); // keep dropdown tidy
    }

    function closeAutocomplete() {
      if (!autocompleteEl) return;
      autocompleteEl.innerHTML = '';
      autocompleteEl.setAttribute('aria-hidden', 'true');
      autocompleteEl.classList.remove('open');
      acState.isOpen = false;
      acState.matches = [];
      acState.selectedIndex = 0;
    }

    function renderAutocomplete(matches, selectedIndex) {
      if (!autocompleteEl) return;

      if (!matches || matches.length === 0) {
        closeAutocomplete();
        return;
      }

      autocompleteEl.innerHTML = matches
        .map((m, i) => {
          const active = i === selectedIndex ? ' active' : '';
          // keep it safe: plain text only
          const esc = m
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
          return `<div class="autocomplete-item${active}" role="option" data-i="${i}">${esc}</div>`;
        })
        .join('');

      autocompleteEl.setAttribute('aria-hidden', 'false');
      autocompleteEl.classList.add('open');
      acState.isOpen = true;
      acState.matches = matches;
      acState.selectedIndex = selectedIndex;
    }

    function updateAutocompleteFromInput() {
      const v = input.value;
      const matches = getMatches(v);
      // If the user already typed an exact match, don't nag them.
      if (matches.length === 1 && normalizeCmd(matches[0]) === normalizeCmd(v)) {
        closeAutocomplete();
        return;
      }
      renderAutocomplete(matches, 0);
    }

    function applySuggestion(s) {
      if (!s) return;
      input.value = s;
      // put caret at end
      input.setSelectionRange(input.value.length, input.value.length);
    }

    // Mouse support
    if (autocompleteEl) {
      autocompleteEl.addEventListener('mousedown', (e) => {
        const item = e.target.closest('.autocomplete-item');
        if (!item) return;
        const idx = Number(item.dataset.i);
        const choice = acState.matches[idx];
        if (choice) {
          e.preventDefault();
          applySuggestion(choice);
          closeAutocomplete();
          input.focus();
        }
      });
    }

    // Live update on typing
    input.addEventListener('input', () => {
      // Whenever the user types, reset history selection and refresh suggestions.
      updateAutocompleteFromInput();
    });

    input.addEventListener('focus', () => {
      updateAutocompleteFromInput();
    });

    input.addEventListener('blur', () => {
      // Give click handlers a chance to run before closing.
      setTimeout(() => closeAutocomplete(), 120);
    });

    input.addEventListener('keydown', (e) => {
      // Ctrl+L to clear terminal
      if (e.ctrlKey && e.key === 'l') {
        e.preventDefault();
        clearTerminal();
        return;
      }

      // Esc: if dropdown open, close it; otherwise clear input.
      if (e.key === 'Escape') {
        e.preventDefault();
        if (acState.isOpen) closeAutocomplete();
        else input.value = '';
        return;
      }

      // Arrow navigation: if dropdown open, move selection. Otherwise preserve history behavior.
      if (e.key === 'ArrowDown') {
        if (acState.isOpen && acState.matches.length) {
          e.preventDefault();
          const next = (acState.selectedIndex + 1) % acState.matches.length;
          renderAutocomplete(acState.matches, next);
          return;
        }

        // command history (existing behavior)
        e.preventDefault();
        if (historyIndex < commandHistory.length - 1) {
          historyIndex++;
          input.value = commandHistory[historyIndex];
        } else {
          historyIndex = commandHistory.length;
          input.value = '';
        }
        closeAutocomplete();
        return;
      }

      if (e.key === 'ArrowUp') {
        if (acState.isOpen && acState.matches.length) {
          e.preventDefault();
          const prev = (acState.selectedIndex - 1 + acState.matches.length) % acState.matches.length;
          renderAutocomplete(acState.matches, prev);
          return;
        }

        // command history (existing behavior)
        e.preventDefault();
        if (historyIndex > 0) {
          historyIndex--;
          input.value = commandHistory[historyIndex];
        }
        closeAutocomplete();
        return;
      }

      // Tab: cycle suggestions (Shift+Tab cycles backwards)
      if (e.key === 'Tab') {
        e.preventDefault();
        const v = input.value;
        const matches = acState.isOpen ? acState.matches : getMatches(v);
        if (!matches.length) {
          closeAutocomplete();
          return;
        }

        let idx = acState.isOpen ? acState.selectedIndex : 0;
        idx = e.shiftKey
          ? (idx - 1 + matches.length) % matches.length
          : (idx + 1) % matches.length;

        renderAutocomplete(matches, idx);
        applySuggestion(matches[idx]);
        return;
      }

      // Enter: if dropdown open, accept selection when input is a prefix (or not exact), else execute.
      if (e.key === 'Enter') {
        if (acState.isOpen && acState.matches.length) {
          const choice = acState.matches[acState.selectedIndex];
          const v = normalizeCmd(input.value);
          const c = normalizeCmd(choice);
          // If user hasn't already typed the exact choice, accept it first.
          if (choice && v && c !== v && c.startsWith(v)) {
            e.preventDefault();
            applySuggestion(choice);
            closeAutocomplete();
            return;
          }
        }
        closeAutocomplete();
        processCommand(input.value);
        return;
      }

      // Any other key: keep dropdown current (but don't fight modifier keys)
      if (!e.ctrlKey && !e.metaKey && !e.altKey) {
        // defer until the input value updates
        setTimeout(updateAutocompleteFromInput, 0);
      }
    });
    
    // ===========================================================================================
    // INITIALIZATION
    // ===========================================================================================
    
    function init() {
      checkStorage();
      showWelcome();
      input.focus();
    }
    
    // Blur input when page becomes hidden (user navigates away) to prevent mobile keyboard popup
    let isNavigatingAway = false;
    
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        isNavigatingAway = true;
        const commandInput = document.getElementById('commandInput');
        if (commandInput) {
          commandInput.blur();
          // Extra insurance: remove focus entirely
          if (document.activeElement === commandInput) {
            commandInput.blur();
          }
        }
      }
    });

    // Blur before unload
    window.addEventListener('beforeunload', () => {
      isNavigatingAway = true;
      const commandInput = document.getElementById('commandInput');
      if (commandInput) {
        commandInput.blur();
      }
    });

    // Also blur on pagehide (iOS Safari backup)
    window.addEventListener('pagehide', () => {
      isNavigatingAway = true;
      const commandInput = document.getElementById('commandInput');
      if (commandInput) {
        commandInput.blur();
      }
    });
    
    // Prevent any focus events during navigation
    window.addEventListener('focus', (e) => {
      if (isNavigatingAway && e.target.id === 'commandInput') {
        e.preventDefault();
        e.target.blur();
      }
    }, true);
    
    document.addEventListener('DOMContentLoaded', init);
  </script>

  <footer style="text-align: center; padding: 2rem 1rem; border-top: 1px solid var(--line); margin-top: 2rem; color: var(--muted);">
    <p style="font-size: 0.85em; opacity: 0.7; margin: 0;">
      &copy; 2025–2026 Chaos Koalas Project
    </p>
  </footer>  
</body>
</html>
